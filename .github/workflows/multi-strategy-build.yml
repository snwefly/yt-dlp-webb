name: å¤šç­–ç•¥å¹¶è¡Œæ„å»º

on:
  workflow_dispatch:
    inputs:
      strategies:
        description: 'è¦æ„å»ºçš„ç­–ç•¥ (ç”¨é€—å·åˆ†éš”)'
        required: false
        default: 'hybrid,build-time'
        type: string
      
      ytdlp_source:
        description: 'yt-dlp æºç±»å‹'
        required: false
        default: 'github_release'
        type: choice
        options:
          - 'github_release'
          - 'pypi'
          - 'local'
      
      ytdlp_version:
        description: 'yt-dlp ç‰ˆæœ¬'
        required: false
        default: 'latest'
        type: string
      
      push_to_registry:
        description: 'æ˜¯å¦æ¨é€åˆ°é•œåƒä»“åº“'
        required: false
        default: false
        type: boolean

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ç­–ç•¥çŸ©é˜µå‡†å¤‡
  prepare-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    
    steps:
    - name: è®¾ç½®æ„å»ºçŸ©é˜µ
      id: set-matrix
      run: |
        STRATEGIES="${{ github.event.inputs.strategies || 'hybrid,build-time' }}"
        
        # è½¬æ¢ä¸º JSON æ•°ç»„
        MATRIX_JSON="["
        IFS=',' read -ra STRATEGY_ARRAY <<< "$STRATEGIES"
        for i in "${!STRATEGY_ARRAY[@]}"; do
          STRATEGY="${STRATEGY_ARRAY[$i]// /}"  # å»é™¤ç©ºæ ¼
          
          # éªŒè¯ç­–ç•¥
          case $STRATEGY in
            "build-time"|"runtime"|"hybrid"|"local")
              if [ $i -gt 0 ]; then
                MATRIX_JSON="$MATRIX_JSON,"
              fi
              MATRIX_JSON="$MATRIX_JSON\"$STRATEGY\""
              ;;
            *)
              echo "âš ï¸ è·³è¿‡ä¸æ”¯æŒçš„ç­–ç•¥: $STRATEGY"
              ;;
          esac
        done
        MATRIX_JSON="$MATRIX_JSON]"
        
        echo "matrix={\"strategy\":$MATRIX_JSON}" >> $GITHUB_OUTPUT
        echo "ğŸ”§ æ„å»ºçŸ©é˜µ: $MATRIX_JSON"

  # å¹¶è¡Œæ„å»ºå¤šç§ç­–ç•¥
  build-strategies:
    runs-on: ubuntu-latest
    needs: prepare-matrix
    if: needs.prepare-matrix.outputs.matrix != '{"strategy":[]}'
    
    strategy:
      matrix: ${{ fromJson(needs.prepare-matrix.outputs.matrix) }}
      fail-fast: false
    
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: æ£€å‡ºä»£ç åº“
      uses: actions/checkout@v4
    
    - name: é…ç½®ç­–ç•¥å‚æ•°
      id: config
      run: |
        STRATEGY="${{ matrix.strategy }}"
        
        case $STRATEGY in
          "build-time")
            echo "dockerfile=Dockerfile.build-time" >> $GITHUB_OUTPUT
            echo "requirements=requirements.github.txt" >> $GITHUB_OUTPUT
            ;;
          "runtime")
            echo "dockerfile=Dockerfile.runtime" >> $GITHUB_OUTPUT
            echo "requirements=requirements.runtime.txt" >> $GITHUB_OUTPUT
            ;;
          "hybrid")
            echo "dockerfile=Dockerfile.hybrid" >> $GITHUB_OUTPUT
            echo "requirements=requirements.hybrid.txt" >> $GITHUB_OUTPUT
            ;;
          "local")
            echo "dockerfile=Dockerfile.local" >> $GITHUB_OUTPUT
            echo "requirements=requirements.local.txt" >> $GITHUB_OUTPUT
            ;;
        esac
        
        echo "âœ… ç­–ç•¥é…ç½®å®Œæˆ: $STRATEGY"
    
    - name: è®¾ç½® Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: ç™»å½•å®¹å™¨æ³¨å†Œè¡¨
      if: github.event.inputs.push_to_registry == 'true'
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: æå–å…ƒæ•°æ®
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=raw,value=${{ matrix.strategy }}-latest
          type=raw,value=${{ matrix.strategy }}-{{date 'YYYYMMDD-HHmmss'}}
        labels: |
          org.opencontainers.image.title=YT-DLP Web (${{ matrix.strategy }})
          org.opencontainers.image.description=yt-dlp Webç•Œé¢ - ${{ matrix.strategy }} æ„å»ºæ¨¡å¼
          build.strategy=${{ matrix.strategy }}
          ytdlp.source=${{ github.event.inputs.ytdlp_source }}
          ytdlp.version=${{ github.event.inputs.ytdlp_version }}
    
    - name: æ„å»º Docker é•œåƒ (${{ matrix.strategy }})
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ${{ steps.config.outputs.dockerfile }}
        platforms: linux/amd64,linux/arm64
        push: ${{ github.event.inputs.push_to_registry == 'true' }}
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        build-args: |
          BUILDTIME=${{ github.run_id }}
          VERSION=multi-${{ github.run_number }}
          REVISION=${{ github.sha }}
          YTDLP_SOURCE=${{ github.event.inputs.ytdlp_source }}
          YTDLP_VERSION=${{ github.event.inputs.ytdlp_version }}
        cache-from: type=gha,scope=${{ matrix.strategy }}
        cache-to: type=gha,mode=max,scope=${{ matrix.strategy }}
    
    - name: æ„å»ºç»“æœ (${{ matrix.strategy }})
      run: |
        echo "âœ… ${{ matrix.strategy }} ç­–ç•¥æ„å»ºå®Œæˆ"
        echo "ğŸ“¦ é•œåƒæ ‡ç­¾: ${{ steps.meta.outputs.tags }}"

  # æ„å»ºæ‘˜è¦
  summary:
    runs-on: ubuntu-latest
    needs: [prepare-matrix, build-strategies]
    if: always()
    
    steps:
    - name: æ„å»ºæ‘˜è¦
      run: |
        echo "ğŸ‰ å¤šç­–ç•¥æ„å»ºå®Œæˆï¼"
        echo ""
        echo "ğŸ“‹ æ„å»ºä¿¡æ¯:"
        echo "  ğŸ—ï¸ è¯·æ±‚çš„ç­–ç•¥: ${{ github.event.inputs.strategies }}"
        echo "  ğŸ“¦ yt-dlp æº: ${{ github.event.inputs.ytdlp_source }}"
        echo "  ğŸ·ï¸ yt-dlp ç‰ˆæœ¬: ${{ github.event.inputs.ytdlp_version }}"
        echo "  ğŸš€ æ¨é€çŠ¶æ€: ${{ github.event.inputs.push_to_registry }}"
        echo ""
        
        # æ£€æŸ¥æ„å»ºçŠ¶æ€
        if [ "${{ needs.build-strategies.result }}" == "success" ]; then
          echo "âœ… æ‰€æœ‰ç­–ç•¥æ„å»ºæˆåŠŸ"
        elif [ "${{ needs.build-strategies.result }}" == "failure" ]; then
          echo "âŒ éƒ¨åˆ†ç­–ç•¥æ„å»ºå¤±è´¥"
        else
          echo "âš ï¸ æ„å»ºçŠ¶æ€: ${{ needs.build-strategies.result }}"
        fi
