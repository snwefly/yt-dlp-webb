name: å¢å¼ºç‰ˆ Docker æ„å»º - æ”¯æŒå¤šç§æ„å»ºç­–ç•¥

on:
  # æ‰‹åŠ¨è§¦å‘ï¼Œæ”¯æŒå¤šç§æ„å»ºç­–ç•¥
  workflow_dispatch:
    inputs:
      build_strategy:
        description: 'æ„å»ºç­–ç•¥'
        required: true
        default: 'æ··åˆæ¨¡å¼'
        type: choice
        options:
          - 'æ„å»ºæ—¶ä¸‹è½½'
          - 'è¿è¡Œæ—¶ä¸‹è½½'
          - 'æ··åˆæ¨¡å¼'
          - 'æœ¬åœ°æ¨¡å¼'

      ytdlp_source:
        description: 'yt-dlp æºç±»å‹'
        required: true
        default: 'GitHubå‘å¸ƒç‰ˆ'
        type: choice
        options:
          - 'GitHubå‘å¸ƒç‰ˆ'
          - 'PyPIå®˜æ–¹åŒ…'
          - 'æœ¬åœ°æ–‡ä»¶'

      ytdlp_version:
        description: 'yt-dlp ç‰ˆæœ¬'
        required: false
        default: 'latest'
        type: string

      build_platforms:
        description: 'æ„å»ºå¹³å° (ç”¨é€—å·åˆ†éš”)'
        required: false
        default: 'linux/amd64,linux/arm64'
        type: string

      image_tag:
        description: 'é•œåƒæ ‡ç­¾'
        required: false
        default: 'latest'
        type: string

      push_to_registry:
        description: 'æ˜¯å¦æ¨é€åˆ°é•œåƒä»“åº“'
        required: false
        default: true
        type: boolean

      run_tests:
        description: 'æ˜¯å¦è¿è¡ŒåŠŸèƒ½æµ‹è¯•'
        required: false
        default: true
        type: boolean

      environment:
        description: 'ç¯å¢ƒç±»å‹'
        required: false
        default: 'ç”Ÿäº§ç¯å¢ƒ'
        type: choice
        options:
          - 'å¼€å‘ç¯å¢ƒ'
          - 'ç”Ÿäº§ç¯å¢ƒ'
          - 'æµ‹è¯•ç¯å¢ƒ'

  # è‡ªåŠ¨è§¦å‘ï¼ˆå¯é€‰ï¼Œé»˜è®¤æ³¨é‡Šï¼‰
  # push:
  #   branches: [ main, master ]
  #   tags: [ 'v*' ]
  # pull_request:
  #   branches: [ main, master ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # æ„å»ºä¿¡æ¯å‡†å¤‡
  prepare:
    runs-on: ubuntu-latest
    outputs:
      dockerfile: ${{ steps.config.outputs.dockerfile }}
      requirements: ${{ steps.config.outputs.requirements }}
      start_script: ${{ steps.config.outputs.start_script }}
      image_suffix: ${{ steps.config.outputs.image_suffix }}
      build_args: ${{ steps.config.outputs.build_args }}

    steps:
    - name: æ£€å‡ºä»£ç åº“
      uses: actions/checkout@v4

    - name: é…ç½®æ„å»ºç­–ç•¥
      id: config
      run: |
        # ä¸­æ–‡åˆ°è‹±æ–‡çš„æ˜ å°„
        case "${{ github.event.inputs.build_strategy || 'æ··åˆæ¨¡å¼' }}" in
          "æ„å»ºæ—¶ä¸‹è½½") STRATEGY="build-time" ;;
          "è¿è¡Œæ—¶ä¸‹è½½") STRATEGY="runtime" ;;
          "æ··åˆæ¨¡å¼") STRATEGY="hybrid" ;;
          "æœ¬åœ°æ¨¡å¼") STRATEGY="local" ;;
          *) STRATEGY="hybrid" ;;
        esac

        case "${{ github.event.inputs.ytdlp_source || 'GitHubå‘å¸ƒç‰ˆ' }}" in
          "GitHubå‘å¸ƒç‰ˆ") YTDLP_SOURCE="github_release" ;;
          "PyPIå®˜æ–¹åŒ…") YTDLP_SOURCE="pypi" ;;
          "æœ¬åœ°æ–‡ä»¶") YTDLP_SOURCE="local" ;;
          *) YTDLP_SOURCE="github_release" ;;
        esac

        case "${{ github.event.inputs.environment || 'ç”Ÿäº§ç¯å¢ƒ' }}" in
          "å¼€å‘ç¯å¢ƒ") ENVIRONMENT="development" ;;
          "ç”Ÿäº§ç¯å¢ƒ") ENVIRONMENT="production" ;;
          "æµ‹è¯•ç¯å¢ƒ") ENVIRONMENT="testing" ;;
          *) ENVIRONMENT="production" ;;
        esac

        YTDLP_VERSION="${{ github.event.inputs.ytdlp_version || 'latest' }}"

        echo "ğŸ”§ é…ç½®æ„å»ºç­–ç•¥: $STRATEGY"
        echo "ğŸ“¦ yt-dlp æº: $YTDLP_SOURCE"
        echo "ğŸ·ï¸ yt-dlp ç‰ˆæœ¬: $YTDLP_VERSION"
        echo "ğŸŒ ç¯å¢ƒ: $ENVIRONMENT"

        # æ ¹æ®ç­–ç•¥è®¾ç½®æ–‡ä»¶ï¼ˆä½¿ç”¨æ–°çš„æ–‡ä»¶å¤¹ç»“æ„ï¼‰
        case $STRATEGY in
          "build-time")
            echo "dockerfile=dockerfiles/Dockerfile.build-time" >> $GITHUB_OUTPUT
            echo "requirements=requirements/requirements.github.txt" >> $GITHUB_OUTPUT
            echo "start_script=scripts/start.sh" >> $GITHUB_OUTPUT
            echo "image_suffix=build-time" >> $GITHUB_OUTPUT
            echo "strategy_chinese=æ„å»ºæ—¶ä¸‹è½½" >> $GITHUB_OUTPUT
            ;;
          "runtime")
            echo "dockerfile=dockerfiles/Dockerfile.runtime" >> $GITHUB_OUTPUT
            echo "requirements=requirements/requirements.runtime.txt" >> $GITHUB_OUTPUT
            echo "start_script=scripts/start-runtime.sh" >> $GITHUB_OUTPUT
            echo "image_suffix=runtime" >> $GITHUB_OUTPUT
            echo "strategy_chinese=è¿è¡Œæ—¶ä¸‹è½½" >> $GITHUB_OUTPUT
            ;;
          "hybrid")
            echo "dockerfile=dockerfiles/Dockerfile.hybrid" >> $GITHUB_OUTPUT
            echo "requirements=requirements/requirements.hybrid.txt" >> $GITHUB_OUTPUT
            echo "start_script=scripts/start-hybrid.sh" >> $GITHUB_OUTPUT
            echo "image_suffix=hybrid" >> $GITHUB_OUTPUT
            echo "strategy_chinese=æ··åˆæ¨¡å¼" >> $GITHUB_OUTPUT
            ;;
          "local")
            echo "dockerfile=dockerfiles/Dockerfile.local-ytdlp" >> $GITHUB_OUTPUT
            echo "requirements=requirements/requirements.local.txt" >> $GITHUB_OUTPUT
            echo "start_script=scripts/start.sh" >> $GITHUB_OUTPUT
            echo "image_suffix=local" >> $GITHUB_OUTPUT
            echo "strategy_chinese=æœ¬åœ°æ¨¡å¼" >> $GITHUB_OUTPUT
            ;;
          *)
            echo "âŒ ä¸æ”¯æŒçš„æ„å»ºç­–ç•¥: $STRATEGY"
            exit 1
            ;;
        esac

        # è®¾ç½®æ„å»ºå‚æ•°
        BUILD_ARGS="BUILDTIME=$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
        BUILD_ARGS="$BUILD_ARGS,VERSION=${{ github.event.inputs.image_tag || 'latest' }}"
        BUILD_ARGS="$BUILD_ARGS,REVISION=${{ github.sha }}"
        BUILD_ARGS="$BUILD_ARGS,YTDLP_SOURCE=$YTDLP_SOURCE"
        BUILD_ARGS="$BUILD_ARGS,YTDLP_VERSION=$YTDLP_VERSION"
        BUILD_ARGS="$BUILD_ARGS,ENVIRONMENT=$ENVIRONMENT"

        echo "build_args=$BUILD_ARGS" >> $GITHUB_OUTPUT

        echo "âœ… é…ç½®å®Œæˆ"

  # ä¸»æ„å»ºä½œä¸š
  build:
    runs-on: ubuntu-latest
    needs: prepare
    permissions:
      contents: read
      packages: write
      security-events: write

    steps:
    - name: æ£€å‡ºä»£ç åº“
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: éªŒè¯æ„å»ºæ–‡ä»¶
      run: |
        DOCKERFILE="${{ needs.prepare.outputs.dockerfile }}"
        REQUIREMENTS="${{ needs.prepare.outputs.requirements }}"
        START_SCRIPT="${{ needs.prepare.outputs.start_script }}"

        echo "ğŸ” éªŒè¯æ„å»ºæ–‡ä»¶..."

        if [ ! -f "$DOCKERFILE" ]; then
          echo "âŒ Dockerfile ä¸å­˜åœ¨: $DOCKERFILE"
          exit 1
        fi

        if [ ! -f "$REQUIREMENTS" ]; then
          echo "âš ï¸ Requirements æ–‡ä»¶ä¸å­˜åœ¨: $REQUIREMENTSï¼Œä½¿ç”¨é»˜è®¤æ–‡ä»¶"
          # å¯ä»¥åˆ›å»ºé»˜è®¤æ–‡ä»¶æˆ–ä½¿ç”¨å¤‡ç”¨æ–‡ä»¶
        fi

        if [ ! -f "$START_SCRIPT" ]; then
          echo "âš ï¸ å¯åŠ¨è„šæœ¬ä¸å­˜åœ¨: $START_SCRIPTï¼Œä½¿ç”¨é»˜è®¤è„šæœ¬"
        fi

        echo "âœ… æ–‡ä»¶éªŒè¯å®Œæˆ"

    - name: è®¾ç½® Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ç™»å½•å®¹å™¨æ³¨å†Œè¡¨
      if: github.event.inputs.push_to_registry == 'true'
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: æå–å…ƒæ•°æ®
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=raw,value=${{ github.event.inputs.image_tag || 'latest' }}-${{ needs.prepare.outputs.image_suffix }}
          type=raw,value=${{ needs.prepare.outputs.image_suffix }}-{{date 'YYYYMMDD-HHmmss'}}
          type=raw,value=${{ needs.prepare.outputs.image_suffix }}-${{ github.event.inputs.ytdlp_source || 'github_release' }}
        labels: |
          org.opencontainers.image.title=YT-DLP Web (${{ github.event.inputs.build_strategy || 'hybrid' }} æ¨¡å¼)
          org.opencontainers.image.description=yt-dlp Webç•Œé¢ - ${{ github.event.inputs.build_strategy || 'hybrid' }} æ„å»ºæ¨¡å¼
          org.opencontainers.image.vendor=${{ github.repository_owner }}
          org.opencontainers.image.source=https://github.com/${{ github.repository }}
          org.opencontainers.image.revision=${{ github.sha }}
          org.opencontainers.image.created={{date 'YYYY-MM-DDTHH:mm:ssZ'}}
          build.strategy=${{ github.event.inputs.build_strategy || 'hybrid' }}
          ytdlp.source=${{ github.event.inputs.ytdlp_source || 'github_release' }}
          ytdlp.version=${{ github.event.inputs.ytdlp_version || 'latest' }}

    - name: æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ${{ needs.prepare.outputs.dockerfile }}
        platforms: ${{ github.event.inputs.build_platforms || 'linux/amd64,linux/arm64' }}
        push: ${{ github.event.inputs.push_to_registry == 'true' }}
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        build-args: ${{ needs.prepare.outputs.build_args }}
        cache-from: type=gha,scope=${{ needs.prepare.outputs.image_suffix }}
        cache-to: type=gha,mode=max,scope=${{ needs.prepare.outputs.image_suffix }}

    - name: æ„å»ºç»“æœæ‘˜è¦
      run: |
        echo "ğŸ‰ Docker é•œåƒæ„å»ºå®Œæˆï¼"
        echo ""
        echo "ğŸ“‹ æ„å»ºä¿¡æ¯:"
        echo "  ğŸ—ï¸ æ„å»ºç­–ç•¥: ${{ github.event.inputs.build_strategy || 'hybrid' }}"
        echo "  ğŸ“¦ yt-dlp æº: ${{ github.event.inputs.ytdlp_source || 'github_release' }}"
        echo "  ğŸ·ï¸ yt-dlp ç‰ˆæœ¬: ${{ github.event.inputs.ytdlp_version || 'latest' }}"
        echo "  ğŸŒ ç¯å¢ƒ: ${{ github.event.inputs.environment || 'production' }}"
        echo "  ğŸ·ï¸ é•œåƒæ ‡ç­¾: ${{ steps.meta.outputs.tags }}"
        echo "  ğŸš€ æ¨é€çŠ¶æ€: ${{ github.event.inputs.push_to_registry == 'true' }}"
        echo "  ğŸ—ï¸ æ„å»ºå¹³å°: ${{ github.event.inputs.build_platforms || 'linux/amd64,linux/arm64' }}"
        echo "  ğŸ“ Dockerfile: ${{ needs.prepare.outputs.dockerfile }}"

  # åŠŸèƒ½æµ‹è¯•ä½œä¸š
  test:
    runs-on: ubuntu-latest
    needs: [prepare, build]
    if: github.event.inputs.run_tests == 'true'

    steps:
    - name: æ£€å‡ºä»£ç åº“
      uses: actions/checkout@v4

    - name: è®¾ç½® Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: æ„å»ºæµ‹è¯•é•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ${{ needs.prepare.outputs.dockerfile }}
        platforms: linux/amd64
        push: false
        tags: test-image:latest
        load: true
        build-args: ${{ needs.prepare.outputs.build_args }}
        cache-from: type=gha,scope=${{ needs.prepare.outputs.image_suffix }}

    - name: è¿è¡Œå®¹å™¨æµ‹è¯•
      run: |
        echo "ğŸ” éªŒè¯æµ‹è¯•é•œåƒ..."
        docker images

        echo "ğŸ§ª å¯åŠ¨æµ‹è¯•å®¹å™¨..."
        # å¯åŠ¨å®¹å™¨
        docker run -d --name test-container \
          -p 8080:8080 \
          -e ENVIRONMENT=testing \
          test-image:latest

        # ç­‰å¾…å®¹å™¨å¯åŠ¨
        echo "â³ ç­‰å¾…å®¹å™¨å¯åŠ¨..."
        sleep 30

        # æ£€æŸ¥å®¹å™¨çŠ¶æ€
        if ! docker ps | grep -q test-container; then
          echo "âŒ å®¹å™¨å¯åŠ¨å¤±è´¥"
          docker logs test-container
          exit 1
        fi

        echo "âœ… å®¹å™¨å¯åŠ¨æˆåŠŸ"

    - name: å¥åº·æ£€æŸ¥æµ‹è¯•
      run: |
        echo "ğŸ” æ‰§è¡Œå¥åº·æ£€æŸ¥..."

        # ç­‰å¾…æœåŠ¡å®Œå…¨å¯åŠ¨
        for i in {1..12}; do
          if curl -f http://localhost:8080/health >/dev/null 2>&1; then
            echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡"
            break
          fi
          echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨... ($i/12)"
          sleep 10
        done

        # æœ€ç»ˆæ£€æŸ¥
        if ! curl -f http://localhost:8080/health; then
          echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥"
          docker logs test-container
          exit 1
        fi

    - name: API åŠŸèƒ½æµ‹è¯•
      run: |
        echo "ğŸ”§ æ‰§è¡Œ API åŠŸèƒ½æµ‹è¯•..."

        # æµ‹è¯•ç™»å½• API
        LOGIN_RESPONSE=$(curl -s -X POST http://localhost:8080/api/auth/login \
          -H "Content-Type: application/json" \
          -d '{"username":"admin","password":"admin123"}')

        if echo "$LOGIN_RESPONSE" | grep -q '"success":true'; then
          echo "âœ… ç™»å½• API æµ‹è¯•é€šè¿‡"
        else
          echo "âŒ ç™»å½• API æµ‹è¯•å¤±è´¥"
          echo "å“åº”: $LOGIN_RESPONSE"
          exit 1
        fi

        # æå– token
        TOKEN=$(echo "$LOGIN_RESPONSE" | grep -o '"token":"[^"]*"' | cut -d'"' -f4)

        if [ -z "$TOKEN" ]; then
          echo "âŒ æ— æ³•è·å–è®¤è¯ token"
          exit 1
        fi

        # æµ‹è¯•è§†é¢‘ä¿¡æ¯ API
        INFO_RESPONSE=$(curl -s -H "Authorization: Bearer $TOKEN" \
          "http://localhost:8080/api/info?url=https://www.youtube.com/watch?v=dQw4w9WgXcQ")

        if echo "$INFO_RESPONSE" | grep -q '"success":true'; then
          echo "âœ… è§†é¢‘ä¿¡æ¯ API æµ‹è¯•é€šè¿‡"
        else
          echo "âš ï¸ è§†é¢‘ä¿¡æ¯ API æµ‹è¯•å¤±è´¥ï¼ˆå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜ï¼‰"
          echo "å“åº”: $INFO_RESPONSE"
        fi

    - name: æ¸…ç†æµ‹è¯•å®¹å™¨
      if: always()
      run: |
        echo "ğŸ§¹ æ¸…ç†æµ‹è¯•å®¹å™¨..."
        docker stop test-container || true
        docker rm test-container || true
        docker rmi test-image:latest || true

  # å®‰å…¨æ‰«æä½œä¸š
  security:
    runs-on: ubuntu-latest
    needs: [prepare, build]
    if: github.event.inputs.push_to_registry == 'true'

    steps:
    - name: è¿è¡Œ Trivy æ¼æ´æ‰«æ
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.event.inputs.image_tag || 'latest' }}-${{ needs.prepare.outputs.image_suffix }}
        format: 'sarif'
        output: 'trivy-results.sarif'
        exit-code: '0'
        ignore-unfixed: true
        vuln-type: 'os,library'
        severity: 'CRITICAL,HIGH'

    - name: ä¸Šä¼ æ‰«æç»“æœ
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'
        category: 'Trivy-${{ needs.prepare.outputs.image_suffix }}'
