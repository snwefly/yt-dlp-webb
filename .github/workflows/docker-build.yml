name: æ„å»ºå¹¶æ¨é€Dockeré•œåƒ

on:
  # åªå…è®¸æ‰‹åŠ¨è§¦å‘æ„å»º
  workflow_dispatch:
    inputs:
      push_to_registry:
        description: 'æ˜¯å¦æ¨é€åˆ°é•œåƒä»“åº“'
        required: false
        default: true
        type: boolean
      build_platforms:
        description: 'æ„å»ºå¹³å° (ç”¨é€—å·åˆ†éš”ï¼Œä¾‹å¦‚: linux/amd64,linux/arm64)'
        required: false
        default: 'linux/amd64,linux/arm64'
        type: string
      image_tag:
        description: 'é•œåƒæ ‡ç­¾'
        required: false
        default: 'latest'
        type: string

  # å¦‚æœéœ€è¦ï¼Œå¯ä»¥å–æ¶ˆæ³¨é‡Šä»¥ä¸‹è¡Œæ¥å¯ç”¨è‡ªåŠ¨è§¦å‘
  # push:
  #   branches: [ main, master, develop ]
  #   tags: [ 'v*' ]
  # pull_request:
  #   branches: [ main, master ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      security-events: write

    steps:
    - name: æ£€å‡ºä»£ç åº“
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: è®¾ç½®Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ç™»å½•å®¹å™¨æ³¨å†Œè¡¨
      if: github.event_name != 'pull_request'
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: æå–å…ƒæ•°æ®
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=raw,value=${{ github.event.inputs.image_tag || 'latest' }}
          type=raw,value=manual-build-{{date 'YYYYMMDD-HHmmss'}}
        labels: |
          org.opencontainers.image.title=YT-DLP ç½‘é¡µç•Œé¢
          org.opencontainers.image.description=å¸¦ä¸‹è½½ç®¡ç†çš„yt-dlpç½‘é¡µç•Œé¢
          org.opencontainers.image.vendor=${{ github.repository_owner }}
          org.opencontainers.image.source=https://github.com/${{ github.repository }}
          org.opencontainers.image.revision=${{ github.sha }}
          org.opencontainers.image.created={{date 'YYYY-MM-DDTHH:mm:ssZ'}}

    - name: è·å–æ„å»ºä¿¡æ¯
      id: build_info
      run: |
        echo "buildtime=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT
        echo "version=${{ fromJSON(steps.meta.outputs.json).labels['org.opencontainers.image.version'] }}" >> $GITHUB_OUTPUT
        echo "revision=${{ github.sha }}" >> $GITHUB_OUTPUT

    - name: æ„å»ºå¹¶æ¨é€Dockeré•œåƒ
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: ${{ github.event.inputs.build_platforms || 'linux/amd64,linux/arm64' }}
        push: ${{ github.event_name == 'workflow_dispatch' && (github.event.inputs.push_to_registry == 'true' || github.event.inputs.push_to_registry == '') }}
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        build-args: |
          BUILDTIME=${{ steps.build_info.outputs.buildtime }}
          VERSION=${{ steps.build_info.outputs.version }}
          REVISION=${{ steps.build_info.outputs.revision }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: æ„å»ºç»“æœ
      run: |
        echo "ğŸ‰ Dockeré•œåƒæ„å»ºå®Œæˆï¼"
        echo "ğŸ“¦ é•œåƒæ ‡ç­¾: ${{ steps.meta.outputs.tags }}"
        echo "ğŸš€ æ¨é€çŠ¶æ€: ${{ github.event_name == 'workflow_dispatch' && (github.event.inputs.push_to_registry == 'true' || github.event.inputs.push_to_registry == '') }}"
        echo "ğŸ—ï¸ æ„å»ºå¹³å°: ${{ github.event.inputs.build_platforms || 'linux/amd64,linux/arm64' }}"

    - name: è¿è¡ŒTrivyæ¼æ´æ‰«æ
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.version }}
        format: 'sarif'
        output: 'trivy-results.sarif'
        exit-code: '0'
        ignore-unfixed: true
        vuln-type: 'os,library'
        severity: 'CRITICAL,HIGH'

    - name: ä¸Šä¼ Trivyæ‰«æç»“æœåˆ°GitHubå®‰å…¨é€‰é¡¹å¡
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'
        category: 'Trivy Scan'

  # æµ‹è¯•ä½œä¸šå·²ç§»é™¤ï¼Œå› ä¸ºç°åœ¨åªæ”¯æŒæ‰‹åŠ¨è§¦å‘
  # å¦‚æœéœ€è¦æµ‹è¯•ï¼Œå¯ä»¥åœ¨æ‰‹åŠ¨è§¦å‘æ—¶é€‰æ‹©ä¸æ¨é€åˆ°ä»“åº“ï¼Œä»…æ„å»ºæµ‹è¯•
