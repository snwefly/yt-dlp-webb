# YT-DLP Web é¡¹ç›®è¿è¡Œé€»è¾‘è¯¦è§£

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

YT-DLP Web æ˜¯ä¸€ä¸ªåŸºäº Flask çš„ Web åº”ç”¨ç¨‹åºï¼Œä¸º yt-dlp å‘½ä»¤è¡Œå·¥å…·æä¾›äº†ç°ä»£åŒ–çš„ç½‘é¡µç•Œé¢ã€‚é¡¹ç›®é‡‡ç”¨å‰åç«¯åˆ†ç¦»çš„æ¶æ„ï¼Œæ”¯æŒå¤šç”¨æˆ·ç®¡ç†ã€å®æ—¶ä¸‹è½½ç›‘æ§ã€iOS å¿«æ·æŒ‡ä»¤é›†æˆç­‰åŠŸèƒ½ã€‚

## ğŸ—ï¸ æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    YT-DLP Web æ¶æ„å›¾                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å‰ç«¯ç•Œé¢ (HTML/CSS/JavaScript)                             â”‚
â”‚  â”œâ”€â”€ ä¸»ç•Œé¢ (index.html)                                   â”‚
â”‚  â”œâ”€â”€ ç™»å½•ç•Œé¢ (login.html)                                 â”‚
â”‚  â””â”€â”€ ç®¡ç†ç•Œé¢ (admin.html)                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Flask Web æœåŠ¡å™¨                                          â”‚
â”‚  â”œâ”€â”€ è·¯ç”±å¤„ç† (app.py)                                     â”‚
â”‚  â”œâ”€â”€ ç”¨æˆ·è®¤è¯ (auth.py)                                    â”‚
â”‚  â”œâ”€â”€ æ–‡ä»¶ç®¡ç† (file_cleaner.py)                           â”‚
â”‚  â””â”€â”€ æœåŠ¡å™¨å¯åŠ¨ (server.py)                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ä¸‹è½½ç®¡ç†å±‚                                                â”‚
â”‚  â”œâ”€â”€ DownloadManager (ä¸‹è½½ä»»åŠ¡ç®¡ç†)                        â”‚
â”‚  â”œâ”€â”€ å¤šçº¿ç¨‹ä¸‹è½½å¤„ç†                                        â”‚
â”‚  â””â”€â”€ è¿›åº¦ç›‘æ§å’ŒçŠ¶æ€ç®¡ç†                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  YT-DLP æ ¸å¿ƒ                                               â”‚
â”‚  â”œâ”€â”€ è§†é¢‘ä¿¡æ¯æå–                                          â”‚
â”‚  â”œâ”€â”€ æ ¼å¼é€‰æ‹©å’Œä¸‹è½½                                        â”‚
â”‚  â””â”€â”€ åå¤„ç† (æ ¼å¼è½¬æ¢ã€å­—å¹•ç­‰)                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ–‡ä»¶ç³»ç»Ÿ                                                  â”‚
â”‚  â”œâ”€â”€ ä¸‹è½½æ–‡ä»¶å­˜å‚¨                                          â”‚
â”‚  â”œâ”€â”€ ä¸´æ—¶æ–‡ä»¶ç®¡ç†                                          â”‚
â”‚  â””â”€â”€ è‡ªåŠ¨æ¸…ç†æœºåˆ¶                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš€ å¯åŠ¨æµç¨‹

### 1. åº”ç”¨åˆå§‹åŒ–
```python
# start.sh è„šæœ¬å¯åŠ¨
export ADMIN_USERNAME=${ADMIN_USERNAME:-admin}
export ADMIN_PASSWORD=${ADMIN_PASSWORD:-admin123}
export SECRET_KEY=${SECRET_KEY:-dev-key}
export DOWNLOAD_FOLDER=${DOWNLOAD_FOLDER:-/app/downloads}

# å¯åŠ¨ Web æœåŠ¡å™¨
python3 -m web.server --host 0.0.0.0 --port 8080
```

### 2. Flask åº”ç”¨åˆ›å»º
```python
# web/app.py - create_app()
def create_app(config=None):
    app = Flask(__name__)

    # é…ç½®åº”ç”¨
    app.config.update({
        'SECRET_KEY': os.environ.get('SECRET_KEY', 'dev-key'),
        'DOWNLOAD_FOLDER': config.get('DOWNLOAD_FOLDER', './downloads'),
        'DEBUG': config.get('DEBUG', False)
    })

    # åˆå§‹åŒ–ç»„ä»¶
    CORS(app)  # è·¨åŸŸæ”¯æŒ
    initialize_cleanup_manager()  # æ–‡ä»¶æ¸…ç†
    register_routes(app)  # æ³¨å†Œè·¯ç”±

    return app
```

### 3. æœåŠ¡å™¨å¯åŠ¨
```python
# web/server.py - WebServer.start()
def start(self, open_browser=True):
    self.app.run(
        host=self.host,      # 0.0.0.0
        port=self.port,      # 8080
        debug=self.debug,    # False (ç”Ÿäº§ç¯å¢ƒ)
        threaded=True        # å¤šçº¿ç¨‹æ”¯æŒ
    )
```

## ğŸ” ç”¨æˆ·è®¤è¯æµç¨‹

### 1. è®¤è¯ç®¡ç†å™¨åˆå§‹åŒ–
```python
# web/auth.py - AuthManager
class AuthManager:
    def __init__(self):
        # ä»ç¯å¢ƒå˜é‡è¯»å–ç®¡ç†å‘˜è´¦å·
        self.admin_username = os.environ.get('ADMIN_USERNAME', 'admin')
        self.admin_password_hash = self._hash_password(
            os.environ.get('ADMIN_PASSWORD', 'admin123')
        )
        self.active_sessions = {}  # å­˜å‚¨æ´»è·ƒä¼šè¯
```

### 2. ç™»å½•éªŒè¯æµç¨‹
```
ç”¨æˆ·è¾“å…¥ â†’ å¯†ç å“ˆå¸Œ â†’ å‡­æ®éªŒè¯ â†’ åˆ›å»ºä¼šè¯ â†’ è¿”å›Token
    â†“
å‰ç«¯å­˜å‚¨Token â†’ åç»­è¯·æ±‚æºå¸¦Token â†’ æœåŠ¡å™¨éªŒè¯Token
```

### 3. æƒé™æ§åˆ¶
```python
@login_required  # éœ€è¦ç™»å½•
def protected_route():
    pass

@admin_required  # éœ€è¦ç®¡ç†å‘˜æƒé™
def admin_route():
    pass
```

## ğŸ“¥ ä¸‹è½½ç®¡ç†æœºåˆ¶

### 1. ä¸‹è½½ç®¡ç†å™¨æ¶æ„
```python
class DownloadManager:
    def __init__(self):
        self.downloads = {}      # å­˜å‚¨æ‰€æœ‰ä¸‹è½½ä»»åŠ¡
        self.lock = threading.Lock()  # çº¿ç¨‹å®‰å…¨é”

    def add_download(self, download_id, url, options):
        # æ·»åŠ æ–°ä¸‹è½½ä»»åŠ¡

    def update_download(self, download_id, **kwargs):
        # æ›´æ–°ä¸‹è½½çŠ¶æ€

    def get_download(self, download_id):
        # è·å–ä¸‹è½½ä¿¡æ¯
```

### 2. ä¸‹è½½æµç¨‹
```
URLè¾“å…¥ â†’ URLéªŒè¯ â†’ å¹¶å‘æ£€æŸ¥ â†’ åˆ›å»ºä»»åŠ¡ â†’ åå°ä¸‹è½½
   â†“
è¿›åº¦å›è°ƒ â†’ çŠ¶æ€æ›´æ–° â†’ å‰ç«¯è½®è¯¢ â†’ å®æ—¶æ˜¾ç¤º â†’ ä¸‹è½½å®Œæˆ
```

### 3. å¤šçº¿ç¨‹ä¸‹è½½å¤„ç†
```python
def _download_worker(download_id, url, ydl_opts):
    """åå°ä¸‹è½½å·¥ä½œçº¿ç¨‹"""
    try:
        # æ›´æ–°çŠ¶æ€ä¸ºä¸‹è½½ä¸­
        download_manager.update_download(download_id, status='downloading')

        # é…ç½®è¿›åº¦å›è°ƒ
        ydl_opts['progress_hooks'] = [
            lambda d: _progress_hook(download_id, d)
        ]

        # æ‰§è¡Œä¸‹è½½
        with YoutubeDL(ydl_opts) as ydl:
            ydl.download([url])

        # æ›´æ–°çŠ¶æ€ä¸ºå®Œæˆ
        download_manager.update_download(download_id, status='completed')

    except Exception as e:
        # æ›´æ–°çŠ¶æ€ä¸ºé”™è¯¯
        download_manager.update_download(download_id,
                                       status='error',
                                       error=str(e))
```

## ğŸŒ API ç«¯ç‚¹è®¾è®¡

### 1. æ ¸å¿ƒ API ç«¯ç‚¹
```
POST /api/auth/login          # ç”¨æˆ·ç™»å½•
POST /api/auth/logout         # ç”¨æˆ·ç™»å‡º
GET  /api/auth/status         # æ£€æŸ¥ç™»å½•çŠ¶æ€

POST /api/info                # è·å–è§†é¢‘ä¿¡æ¯
POST /api/download            # å¼€å§‹ä¸‹è½½
GET  /api/download/{id}       # è·å–ä¸‹è½½çŠ¶æ€
GET  /api/downloads           # è·å–æ‰€æœ‰ä¸‹è½½

GET  /api/files               # åˆ—å‡ºä¸‹è½½æ–‡ä»¶
GET  /api/files/{filename}    # ä¸‹è½½æ–‡ä»¶
DELETE /api/files/{filename}  # åˆ é™¤æ–‡ä»¶

POST /api/shortcuts/download  # iOS å¿«æ·æŒ‡ä»¤ä¸“ç”¨
```

### 2. API è¯·æ±‚æµç¨‹
```
å®¢æˆ·ç«¯è¯·æ±‚ â†’ è®¤è¯æ£€æŸ¥ â†’ å‚æ•°éªŒè¯ â†’ ä¸šåŠ¡é€»è¾‘ â†’ è¿”å›å“åº”
     â†“
é”™è¯¯å¤„ç† â†’ æ—¥å¿—è®°å½• â†’ çŠ¶æ€ç  â†’ JSONå“åº”
```

### 3. å®‰å…¨éªŒè¯
```python
def validate_url(url):
    """URL å®‰å…¨éªŒè¯"""
    # æ£€æŸ¥åè®® (ä»…å…è®¸ HTTP/HTTPS)
    # æ£€æŸ¥åŸŸå (é˜»æ­¢å†…ç½‘åœ°å€)
    # æ£€æŸ¥é•¿åº¦ (é˜²æ­¢ DoS)
    # æ£€æŸ¥æ ¼å¼ (é˜²æ­¢æ³¨å…¥)
```

## ğŸ¨ å‰ç«¯ç•Œé¢äº¤äº’

### 1. é¡µé¢ç»“æ„
```html
<!DOCTYPE html>
<html>
<head>
    <!-- æ ·å¼å’Œå…ƒæ•°æ® -->
</head>
<body>
    <div class="container">
        <div class="header">æ ‡é¢˜åŒºåŸŸ</div>
        <div class="main-content">
            <div class="left-panel">
                <!-- è¾“å…¥åŒºåŸŸ -->
                <!-- é€‰é¡¹é…ç½® -->
                <!-- ä¸‹è½½æŒ‰é’® -->
            </div>
            <div class="right-panel">
                <!-- çŠ¶æ€æ˜¾ç¤º -->
                <!-- ä¸‹è½½åˆ—è¡¨ -->
                <!-- æ–‡ä»¶ç®¡ç† -->
            </div>
        </div>
    </div>
</body>
</html>
```

### 2. JavaScript äº¤äº’é€»è¾‘
```javascript
// ä¸»è¦åŠŸèƒ½æ¨¡å—
const App = {
    // URL éªŒè¯
    validateUrl(url) { /* ... */ },

    // è·å–è§†é¢‘ä¿¡æ¯
    async getVideoInfo(url) { /* ... */ },

    // å¼€å§‹ä¸‹è½½
    async startDownload(options) { /* ... */ },

    // è½®è¯¢çŠ¶æ€æ›´æ–°
    pollDownloadStatus() { /* ... */ },

    // æ–‡ä»¶ç®¡ç†
    loadFiles() { /* ... */ },

    // iOS å¿«æ·æŒ‡ä»¤
    setupShortcuts() { /* ... */ }
};
```

### 3. å®æ—¶çŠ¶æ€æ›´æ–°
```javascript
// æ¯2ç§’è½®è¯¢ä¸€æ¬¡ä¸‹è½½çŠ¶æ€
setInterval(() => {
    if (activeDownloads.length > 0) {
        updateDownloadStatus();
    }
}, 2000);

function updateDownloadStatus() {
    activeDownloads.forEach(async (downloadId) => {
        const status = await fetch(`/api/download/${downloadId}`);
        const data = await status.json();
        updateProgressBar(downloadId, data.progress);
    });
}
```

## ğŸ“± iOS å¿«æ·æŒ‡ä»¤é›†æˆ

### 1. ä¸“ç”¨ API ç«¯ç‚¹
```python
@app.route('/api/shortcuts/download', methods=['POST'])
def shortcuts_download():
    """iOS å¿«æ·æŒ‡ä»¤ä¸“ç”¨ä¸‹è½½ç«¯ç‚¹"""
    # æ”¯æŒ JSON å’Œè¡¨å•æ•°æ®
    # è¿”å›å¿«æ·æŒ‡ä»¤å‹å¥½çš„å“åº”æ ¼å¼
    return jsonify({
        'success': True,
        'download_id': download_id,
        'status_url': f'/api/download/{download_id}/status',
        'download_url': f'/api/shortcuts/download/{download_id}/file'
    })
```

### 2. å¿«æ·æŒ‡ä»¤é…ç½®
```
å¿«æ·æŒ‡ä»¤æµç¨‹:
1. è·å–å‰ªè´´æ¿/åˆ†äº«çš„URL
2. å‘é€POSTè¯·æ±‚åˆ° /api/shortcuts/download
3. è§£æè¿”å›çš„download_id
4. è½®è¯¢çŠ¶æ€ç›´åˆ°å®Œæˆ
5. ä¸‹è½½æ–‡ä»¶åˆ°ç›¸å†Œ/æ–‡ä»¶
```

## ğŸ—‚ï¸ æ–‡ä»¶ç®¡ç†å’Œæ¸…ç†

### 1. è‡ªåŠ¨æ¸…ç†æœºåˆ¶
```python
class FileCleanupManager:
    def __init__(self, download_folder, config):
        self.settings = {
            'auto_cleanup_enabled': True,
            'cleanup_interval_hours': 1,     # æ¯å°æ—¶æ¸…ç†
            'file_retention_hours': 24,      # ä¿ç•™24å°æ—¶
            'max_storage_mb': 2048,          # æœ€å¤§2GB
            'keep_recent_files': 20,         # ä¿ç•™æœ€è¿‘20ä¸ª
        }

    def cleanup_files(self):
        # 1. æ¸…ç†è¿‡æœŸæ–‡ä»¶
        # 2. æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        # 3. æ£€æŸ¥å­˜å‚¨é™åˆ¶
        # 4. æ¸…ç†ç©ºç›®å½•
```

### 2. æ¸…ç†ç­–ç•¥
```
å®šæ—¶æ¸…ç† (æ¯å°æ—¶) â†’ æ£€æŸ¥æ–‡ä»¶å¹´é¾„ â†’ åˆ é™¤è¿‡æœŸæ–‡ä»¶
     â†“
å­˜å‚¨æ£€æŸ¥ â†’ è¶…è¿‡é™åˆ¶ â†’ åˆ é™¤æœ€æ—§æ–‡ä»¶ (ä¿ç•™æœ€è¿‘Nä¸ª)
     â†“
ä¸‹è½½å®Œæˆ â†’ ç«‹å³æ¸…ç†ä¸´æ—¶æ–‡ä»¶ â†’ æ£€æŸ¥å­˜å‚¨ç©ºé—´
```

## ğŸ³ å®¹å™¨åŒ–éƒ¨ç½²

### 1. Docker æ„å»ºæµç¨‹
```dockerfile
# å¤šé˜¶æ®µæ„å»º
FROM python:3.11-slim as builder
# å®‰è£…æ„å»ºä¾èµ–å’ŒPythonåŒ…

FROM python:3.11-slim as runtime
# å¤åˆ¶è¿è¡Œæ—¶æ–‡ä»¶
# åˆ›å»ºérootç”¨æˆ·
# è®¾ç½®æƒé™å’Œç¯å¢ƒ
```

### 2. å®¹å™¨å¯åŠ¨æµç¨‹
```bash
# start.sh è„šæœ¬
1. è®¾ç½®ç¯å¢ƒå˜é‡
2. åˆ›å»ºå¿…è¦ç›®å½•
3. éªŒè¯ä¾èµ–å®‰è£…
4. å¯åŠ¨WebæœåŠ¡å™¨
```

### 3. Docker Compose ç¼–æ’
```yaml
services:
  yt-dlp-web:
    image: yt-dlp-web:latest
    ports: ["8080:8080"]
    volumes:
      - downloads:/app/downloads
      - config:/app/config
    environment:
      - ADMIN_USERNAME=admin
      - ADMIN_PASSWORD=secure_password
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/"]
```

## ğŸ”„ å®Œæ•´è¯·æ±‚æµç¨‹ç¤ºä¾‹

### ä¸‹è½½è§†é¢‘çš„å®Œæ•´æµç¨‹:

1. **ç”¨æˆ·æ“ä½œ**: åœ¨å‰ç«¯è¾“å…¥YouTube URL
2. **URLéªŒè¯**: JavaScriptéªŒè¯URLæ ¼å¼
3. **è·å–ä¿¡æ¯**: è°ƒç”¨ `/api/info` è·å–è§†é¢‘ä¿¡æ¯
4. **æ˜¾ç¤ºä¿¡æ¯**: å‰ç«¯æ˜¾ç¤ºè§†é¢‘æ ‡é¢˜ã€æ—¶é•¿ç­‰
5. **é…ç½®é€‰é¡¹**: ç”¨æˆ·é€‰æ‹©æ ¼å¼ã€è´¨é‡ç­‰é€‰é¡¹
6. **å¼€å§‹ä¸‹è½½**: è°ƒç”¨ `/api/download` å¼€å§‹ä¸‹è½½
7. **åå°å¤„ç†**: åˆ›å»ºä¸‹è½½ä»»åŠ¡ï¼Œå¯åŠ¨å·¥ä½œçº¿ç¨‹
8. **çŠ¶æ€è½®è¯¢**: å‰ç«¯æ¯2ç§’æŸ¥è¯¢ä¸‹è½½è¿›åº¦
9. **è¿›åº¦æ›´æ–°**: å®æ—¶æ›´æ–°è¿›åº¦æ¡å’ŒçŠ¶æ€
10. **ä¸‹è½½å®Œæˆ**: æ˜¾ç¤ºå®ŒæˆçŠ¶æ€ï¼Œæä¾›ä¸‹è½½é“¾æ¥
11. **æ–‡ä»¶æ¸…ç†**: åå°è‡ªåŠ¨æ¸…ç†è¿‡æœŸæ–‡ä»¶

è¿™ä¸ªæ¶æ„ç¡®ä¿äº†ç³»ç»Ÿçš„å¯æ‰©å±•æ€§ã€å®‰å…¨æ€§å’Œç”¨æˆ·ä½“éªŒï¼ŒåŒæ—¶æ”¯æŒå¤šç§ä½¿ç”¨åœºæ™¯ï¼ˆWebç•Œé¢ã€APIè°ƒç”¨ã€iOSå¿«æ·æŒ‡ä»¤ï¼‰ã€‚
