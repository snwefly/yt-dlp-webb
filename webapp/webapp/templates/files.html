{% extends "base.html" %}

{% block title %}æ–‡ä»¶ç®¡ç† - yt-dlp Web{% endblock %}

{% block extra_css %}
    <style>
        .file-item {
            transition: all 0.3s ease;
        }
        .file-item:hover {
            background-color: #f8f9fa;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .file-size {
            color: #6c757d;
            font-size: 0.9em;
        }
        .file-date {
            color: #6c757d;
            font-size: 0.85em;
        }
        .download-btn {
            transition: all 0.3s ease;
        }
        .download-btn:hover {
            transform: scale(1.05);
        }
        .play-btn {
            transition: all 0.3s ease;
        }
        .play-btn:hover {
            transform: scale(1.05);
        }
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }

        /* æ¸…ç†åŠŸèƒ½æ ·å¼ */
        .dropdown-item {
            transition: all 0.2s ease;
        }

        .dropdown-item:hover {
            background-color: #f8f9fa;
            transform: translateX(2px);
        }

        .dropdown-item.text-danger:hover {
            background-color: #f8d7da;
            color: #721c24 !important;
        }

        .btn-group .dropdown-toggle::after {
            margin-left: 0.5em;
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

    </style>
{% endblock %}

{% block content %}
    <div class="container mt-4">
        <!-- é¡µé¢æ ‡é¢˜å’Œç»Ÿè®¡ -->
        <div class="row mb-4">
            <div class="col-md-8">
                <h2><i class="bi bi-folder2-open"></i> æ–‡ä»¶ç®¡ç†</h2>
                <p class="text-muted">ç®¡ç†æ‚¨ä¸‹è½½çš„æ‰€æœ‰æ–‡ä»¶</p>
            </div>
            <div class="col-md-4">
                <div class="card stats-card">
                    <div class="card-body text-center">
                        <h4 id="totalFiles">0</h4>
                        <small>æ€»æ–‡ä»¶æ•°</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ“ä½œæŒ‰é’® -->
        <div class="row mb-3">
            <div class="col">
                <button class="btn btn-primary" onclick="refreshFiles()">
                    <i class="bi bi-arrow-clockwise"></i> åˆ·æ–°åˆ—è¡¨
                </button>

                <!-- æ¸…ç†åŠŸèƒ½ä¸‹æ‹‰èœå• -->
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-trash"></i> æ¸…ç†æ–‡ä»¶
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="cleanupFiles('completed')">
                            <i class="bi bi-check-circle"></i> æ¸…ç†å·²å®Œæˆä¸‹è½½
                        </a></li>
                        <li><a class="dropdown-item" href="#" onclick="cleanupFiles('expired')">
                            <i class="bi bi-clock-history"></i> æ¸…ç†è¿‡æœŸæ–‡ä»¶
                        </a></li>
                        <li><a class="dropdown-item" href="#" onclick="cleanupFiles('temp')">
                            <i class="bi bi-file-earmark-x"></i> æ¸…ç†ä¸´æ—¶æ–‡ä»¶
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="#" onclick="cleanupFiles('all')">
                            <i class="bi bi-trash3"></i> å®Œæ•´æ¸…ç†
                        </a></li>
                    </ul>
                </div>

            </div>
        </div>

        <!-- æ–‡ä»¶åˆ—è¡¨ -->
        <div class="row">
            <div class="col">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-list-ul"></i> ä¸‹è½½æ–‡ä»¶åˆ—è¡¨</h5>
                    </div>
                    <div class="card-body">
                        <div id="loadingSpinner" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">åŠ è½½ä¸­...</span>
                            </div>
                            <p class="mt-2">æ­£åœ¨åŠ è½½æ–‡ä»¶åˆ—è¡¨...</p>
                        </div>
                        
                        <div id="filesList" style="display: none;">
                            <!-- æ–‡ä»¶åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                        
                        <div id="emptyState" class="empty-state" style="display: none;">
                            <i class="bi bi-folder-x" style="font-size: 3rem; color: #dee2e6;"></i>
                            <h4 class="mt-3">æš‚æ— æ–‡ä»¶</h4>
                            <p>æ‚¨è¿˜æ²¡æœ‰ä¸‹è½½ä»»ä½•æ–‡ä»¶ã€‚<a href="/">ç«‹å³å¼€å§‹ä¸‹è½½</a></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥è®¤è¯çŠ¶æ€
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ğŸ¯ æ–‡ä»¶ç®¡ç†é¡µé¢åŠ è½½');

            // ä½¿ç”¨Flask-Loginè®¤è¯çŠ¶æ€
            if (typeof window.ensureAuthSync === 'function') {
                console.log('ğŸ”„ æ£€æŸ¥è®¤è¯çŠ¶æ€');
                const isAuthenticated = await window.ensureAuthSync();
                if (isAuthenticated) {
                    console.log('âœ… å·²è®¤è¯ï¼ŒåŠ è½½æ–‡ä»¶');
                    loadFiles();
                } else {
                    console.log('âŒ æœªè®¤è¯ï¼Œæ˜¾ç¤ºç™»å½•æç¤º');
                    showLoginPrompt();
                }
            } else {
                // æ£€æŸ¥åŸºæœ¬è®¤è¯çŠ¶æ€
                if (isAuthenticated && currentUser) {
                    loadFiles();
                } else {
                    showLoginPrompt();
                }
            }
        });

        // æ—§çš„è®¤è¯æ£€æŸ¥å‡½æ•°å·²åˆ é™¤ï¼Œä½¿ç”¨Flask-Login

        // æ˜¾ç¤ºç™»å½•æç¤º
        function showLoginPrompt() {
            // éšè—åŠ è½½çŠ¶æ€å’Œç©ºçŠ¶æ€
            hideLoading();
            document.getElementById('emptyState').style.display = 'none';

            // åœ¨æ–‡ä»¶åˆ—è¡¨åŒºåŸŸæ˜¾ç¤ºç™»å½•æç¤º
            const filesList = document.getElementById('filesList');
            filesList.style.display = 'block';
            filesList.innerHTML = `
                <div class="text-center py-5">
                    <div class="mb-4">
                        <i class="bi bi-lock" style="font-size: 3rem; color: #6c757d;"></i>
                    </div>
                    <h4>éœ€è¦ç™»å½•è®¿é—®</h4>
                    <p class="text-muted mb-4">è¯·å…ˆç™»å½•ä»¥æŸ¥çœ‹å’Œç®¡ç†æ‚¨çš„æ–‡ä»¶</p>
                    <button class="btn btn-primary" onclick="goToLogin()">
                        <i class="bi bi-box-arrow-in-right"></i> ç«‹å³ç™»å½•
                    </button>
                </div>
            `;
        }

        // è·³è½¬åˆ°ç™»å½•é¡µ
        function goToLogin() {
            window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname);
        }

        // è·³è½¬åˆ°ç™»å½•é¡µï¼ˆå…¼å®¹æ—§å‡½æ•°åï¼‰
        function redirectToLogin() {
            goToLogin();
        }

        // åŠ è½½æ–‡ä»¶åˆ—è¡¨ - ä½¿ç”¨Flask-Login
        async function loadFiles() {
            try {
                showLoading();
                const response = await fetch('/api/files', {
                    credentials: 'same-origin'  // ä½¿ç”¨cookiesè®¤è¯
                });
                const data = await response.json();
                
                if (data.success) {
                    displayFiles(data.files);
                    updateStats(data.total);
                } else {
                    showError('è·å–æ–‡ä»¶åˆ—è¡¨å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('åŠ è½½æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', error);
                showError('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥');
            }
        }

        // æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨
        function displayFiles(files) {
            const filesList = document.getElementById('filesList');
            const emptyState = document.getElementById('emptyState');
            
            hideLoading();
            
            if (!files || files.length === 0) {
                filesList.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            filesList.style.display = 'block';
            
            let html = '';
            files.forEach(file => {
                // æ£€æŸ¥æ˜¯å¦ä¸ºè§†é¢‘æ–‡ä»¶
                const isVideo = isVideoFile(file.filename || '');

                html += `
                    <div class="file-item border rounded p-3 mb-3">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <h6 class="mb-1">
                                    <i class="bi bi-${isVideo ? 'play-circle' : 'file-earmark-arrow-down'} text-primary"></i>
                                    ${escapeHtml(file.filename || 'æœªçŸ¥æ–‡ä»¶')}
                                    ${isVideo ? '<span class="badge bg-info ms-2">è§†é¢‘</span>' : ''}
                                </h6>
                                <small class="text-muted">
                                    <i class="bi bi-link-45deg"></i>
                                    ${escapeHtml(file.original_url || '')}
                                </small>
                            </div>
                            <div class="col-md-2 text-center">
                                <span class="file-size">${file.file_size_formatted || 'æœªçŸ¥'}</span>
                            </div>
                            <div class="col-md-2 text-center">
                                <span class="file-date">${file.created_at_formatted || 'æœªçŸ¥'}</span>
                            </div>
                            <div class="col-md-2 text-end">
                                ${isVideo ? `
                                    <button class="btn btn-primary btn-sm play-btn me-1"
                                            onclick="openVideoPlayer('${escapeHtml(file.filename)}', '${file.download_url}')">
                                        <i class="bi bi-play-fill"></i> æ’­æ”¾
                                    </button>
                                ` : ''}
                                <a href="${file.download_url}"
                                   class="btn btn-success btn-sm download-btn me-1"
                                   download="${escapeHtml(file.filename || 'download')}">
                                    <i class="bi bi-download"></i> ä¸‹è½½
                                </a>
                                <button class="btn btn-outline-danger btn-sm"
                                        onclick="deleteFile('${escapeHtml(file.filename)}', '${file.file_path || ''}')">
                                    <i class="bi bi-trash"></i> åˆ é™¤
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            filesList.innerHTML = html;
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats(total) {
            document.getElementById('totalFiles').textContent = total || 0;
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading() {
            document.getElementById('loadingSpinner').style.display = 'block';
            document.getElementById('filesList').style.display = 'none';
            document.getElementById('emptyState').style.display = 'none';
        }

        // éšè—åŠ è½½çŠ¶æ€
        function hideLoading() {
            document.getElementById('loadingSpinner').style.display = 'none';
        }

        // åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
        function refreshFiles() {
            loadFiles();
        }

        // åˆ é™¤å•ä¸ªæ–‡ä»¶
        async function deleteFile(filename, filePath) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤æ–‡ä»¶ "${filename}" å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                return;
            }

            try {
                const response = await fetch('/api/files/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin',  // ä½¿ç”¨cookiesè®¤è¯
                    body: JSON.stringify({
                        filename: filename,
                        file_path: filePath
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showSuccessMessage(`æ–‡ä»¶ "${filename}" å·²åˆ é™¤`);
                    // åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
                    loadFiles();
                } else {
                    showErrorMessage('åˆ é™¤å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('åˆ é™¤æ–‡ä»¶å¤±è´¥:', error);
                showErrorMessage('åˆ é™¤å¤±è´¥: ç½‘ç»œé”™è¯¯');
            }
        }

        // æ¸…ç†æ–‡ä»¶ï¼ˆæ–°çš„ç»Ÿä¸€å‡½æ•°ï¼‰
        async function cleanupFiles(type) {
            const cleanupTypes = {
                'completed': {
                    title: 'æ¸…ç†å·²å®Œæˆä¸‹è½½',
                    message: 'ç¡®å®šè¦åˆ é™¤æ‰€æœ‰å·²å®Œæˆä¸‹è½½çš„æ–‡ä»¶å—ï¼Ÿ\n\nè¿™å°†åˆ é™¤æ‰€æœ‰å·²ä¸‹è½½å®Œæˆçš„æ–‡ä»¶ï¼Œä½†ä¿ç•™ä¸‹è½½è®°å½•ã€‚',
                    icon: 'check-circle'
                },
                'expired': {
                    title: 'æ¸…ç†è¿‡æœŸæ–‡ä»¶',
                    message: 'ç¡®å®šè¦åˆ é™¤æ‰€æœ‰è¿‡æœŸæ–‡ä»¶å—ï¼Ÿ\n\nè¿™å°†åˆ é™¤è¶…è¿‡ä¿ç•™æœŸé™çš„æ–‡ä»¶ã€‚',
                    icon: 'clock-history'
                },
                'temp': {
                    title: 'æ¸…ç†ä¸´æ—¶æ–‡ä»¶',
                    message: 'ç¡®å®šè¦åˆ é™¤æ‰€æœ‰ä¸´æ—¶æ–‡ä»¶å—ï¼Ÿ\n\nè¿™å°†åˆ é™¤ä¸‹è½½è¿‡ç¨‹ä¸­äº§ç”Ÿçš„ä¸´æ—¶æ–‡ä»¶ã€‚',
                    icon: 'file-earmark-x'
                },
                'all': {
                    title: 'å®Œæ•´æ¸…ç†',
                    message: 'ç¡®å®šè¦æ‰§è¡Œå®Œæ•´æ¸…ç†å—ï¼Ÿ\n\nè¿™å°†åˆ é™¤è¿‡æœŸæ–‡ä»¶ã€ä¸´æ—¶æ–‡ä»¶ï¼Œå¹¶æ£€æŸ¥å­˜å‚¨ç©ºé—´é™åˆ¶ã€‚\n\nâš ï¸ æ­¤æ“ä½œä¸å¯æ¢å¤ï¼',
                    icon: 'trash3'
                }
            };

            const config = cleanupTypes[type];
            if (!config) {
                showErrorMessage('æ— æ•ˆçš„æ¸…ç†ç±»å‹');
                return;
            }

            if (!confirm(config.message)) {
                return;
            }

            try {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const loadingMessage = showLoadingMessage(`æ­£åœ¨æ‰§è¡Œ${config.title}...`);

                const response = await fetch('/api/files/cleanup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        type: type
                    })
                });

                const data = await response.json();

                // éšè—åŠ è½½çŠ¶æ€
                hideLoadingMessage(loadingMessage);

                if (data.success) {
                    showSuccessMessage(`${config.title}å®Œæˆï¼åˆ é™¤äº† ${data.cleaned_count} ä¸ªæ–‡ä»¶`);
                    // åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
                    loadFiles();
                } else {
                    showErrorMessage(`${config.title}å¤±è´¥: ` + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error(`${config.title}å¤±è´¥:`, error);
                showErrorMessage(`${config.title}å¤±è´¥: ç½‘ç»œé”™è¯¯`);
            }
        }

        // ä¿æŒå‘åå…¼å®¹çš„å‡½æ•°
        function clearCompleted() {
            cleanupFiles('completed');
        }

        // æ˜¾ç¤ºåŠ è½½æ¶ˆæ¯
        function showLoadingMessage(message) {
            const toast = document.createElement('div');
            toast.className = 'toast align-items-center text-white bg-info border-0';
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.setAttribute('aria-atomic', 'true');
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="bi bi-hourglass-split"></i> ${message}
                    </div>
                </div>
            `;

            // æ·»åŠ åˆ°é¡µé¢
            let toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toastContainer';
                toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
                toastContainer.style.zIndex = '1055';
                document.body.appendChild(toastContainer);
            }
            toastContainer.appendChild(toast);

            // æ˜¾ç¤º toast
            const bsToast = new bootstrap.Toast(toast, { autohide: false });
            bsToast.show();

            return toast;
        }

        // éšè—åŠ è½½æ¶ˆæ¯
        function hideLoadingMessage(toastElement) {
            if (toastElement) {
                const bsToast = bootstrap.Toast.getInstance(toastElement);
                if (bsToast) {
                    bsToast.hide();
                }
                setTimeout(() => {
                    if (toastElement.parentNode) {
                        toastElement.parentNode.removeChild(toastElement);
                    }
                }, 500);
            }
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            hideLoading();
            const filesList = document.getElementById('filesList');
            filesList.style.display = 'block';
            filesList.innerHTML = `
                <div class="alert alert-danger" role="alert">
                    <i class="bi bi-exclamation-triangle"></i>
                    ${escapeHtml(message)}
                </div>
            `;
        }

        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        function showSuccessMessage(message) {
            showMessage(message, 'success');
        }

        // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
        function showErrorMessage(message) {
            showMessage(message, 'danger');
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type) {
            // åˆ›å»ºæ¶ˆæ¯å…ƒç´ 
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            // æ’å…¥åˆ°é¡µé¢é¡¶éƒ¨
            const container = document.querySelector('.container');
            container.insertBefore(alertDiv, container.firstChild);

            // 5ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // HTMLè½¬ä¹‰å‡½æ•°
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // æ£€æŸ¥æ˜¯å¦ä¸ºè§†é¢‘æ–‡ä»¶
        function isVideoFile(filename) {
            const videoExtensions = ['.mp4', '.avi', '.mkv', '.mov', '.wmv', '.flv', '.webm', '.m4v', '.3gp', '.ogv'];
            const extension = filename.toLowerCase().substring(filename.lastIndexOf('.'));
            return videoExtensions.includes(extension);
        }

        // æ‰“å¼€è§†é¢‘æ’­æ”¾å™¨ï¼ˆæ–°çª—å£ï¼‰
        function openVideoPlayer(filename, videoUrl) {
            try {
                console.log('ğŸ¬ æ‰“å¼€è§†é¢‘æ’­æ”¾å™¨:', filename);
                console.log('ğŸ“ è§†é¢‘URL:', videoUrl);

                // æ„å»ºæ’­æ”¾å™¨é¡µé¢URL
                const playerUrl = `/video-player?url=${encodeURIComponent(videoUrl)}&filename=${encodeURIComponent(filename)}`;

                // åœ¨æ–°çª—å£ä¸­æ‰“å¼€æ’­æ”¾å™¨
                const playerWindow = window.open(
                    playerUrl,
                    'videoPlayer',
                    'width=1200,height=800,scrollbars=no,resizable=yes,status=no,toolbar=no,menubar=no,location=no'
                );

                if (playerWindow) {
                    playerWindow.focus();
                    console.log('âœ… è§†é¢‘æ’­æ”¾å™¨çª—å£å·²æ‰“å¼€');
                } else {
                    // å¦‚æœå¼¹çª—è¢«é˜»æ­¢ï¼Œå°è¯•åœ¨å½“å‰çª—å£æ‰“å¼€
                    console.log('âš ï¸ å¼¹çª—è¢«é˜»æ­¢ï¼Œåœ¨å½“å‰çª—å£æ‰“å¼€');
                    window.location.href = playerUrl;
                }

            } catch (error) {
                console.error('âŒ æ‰“å¼€è§†é¢‘æ’­æ”¾å™¨å¤±è´¥:', error);
                showErrorMessage('æ— æ³•æ‰“å¼€è§†é¢‘æ’­æ”¾å™¨: ' + error.message);
            }
        }
    </script>
{% endblock %}
