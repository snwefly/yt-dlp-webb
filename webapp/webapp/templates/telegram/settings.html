{% extends "base.html" %}

{% block title %}Telegram è‡ªåŠ¨ä¸‹è½½è®¾ç½®{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- é¡µé¢æ ‡é¢˜ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 bg-gradient-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h2 class="mb-1">
                                <i class="fab fa-telegram"></i> 
                                Telegram è‡ªåŠ¨ä¸‹è½½è®¾ç½®
                            </h2>
                            <p class="mb-0 opacity-75">é…ç½® Telegram Botï¼Œå®ç°å‘é€é“¾æ¥è‡ªåŠ¨ä¸‹è½½å¹¶æ¨é€æ–‡ä»¶</p>
                        </div>
                        <div class="btn-group">
                            <button id="testConnection" class="btn btn-light">
                                <i class="fas fa-test-tube"></i> æµ‹è¯•è¿æ¥
                            </button>
                            <button id="testFilePush" class="btn btn-outline-light">
                                <i class="fas fa-file-upload"></i> æµ‹è¯•æ–‡ä»¶æ¨é€
                            </button>
                            <button id="checkPushConfig" class="btn btn-outline-warning">
                                <i class="fas fa-search"></i> æ£€æŸ¥æ¨é€é…ç½®
                            </button>
                            <button id="setupWebhook" class="btn btn-outline-light">
                                <i class="fas fa-link"></i> è®¾ç½®Webhook
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸»è¦å†…å®¹ -->
    <div class="row">
        <!-- å·¦ä¾§ï¼šåŸºç¡€é…ç½® -->
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        <i class="fas fa-cog text-primary"></i> åŸºç¡€é…ç½®
                    </h5>
                </div>
                <div class="card-body">
                    <form id="telegramConfigForm">
                        <!-- Telegram API é…ç½® -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="alert alert-info border-0">
                                    <h6 class="alert-heading">
                                        <i class="fas fa-key"></i> Telegram API é…ç½®
                                    </h6>
                                    <p class="mb-3">
                                        éœ€è¦ä» <a href="https://my.telegram.org" target="_blank" class="text-decoration-none">
                                            <i class="fas fa-external-link-alt"></i> https://my.telegram.org
                                        </a> è·å– API ID å’Œ API Hash
                                    </p>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="apiId" class="form-label">
                                                    <strong>API ID</strong>
                                                    <small class="text-muted">ä» my.telegram.org è·å–</small>
                                                </label>
                                                <input type="text" class="form-control" id="apiId" name="api_id"
                                                       placeholder="12345678">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="apiHash" class="form-label">
                                                    <strong>API Hash</strong>
                                                    <small class="text-muted">ä» my.telegram.org è·å–</small>
                                                </label>
                                                <input type="password" class="form-control" id="apiHash" name="api_hash"
                                                       placeholder="abcdef1234567890abcdef1234567890">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="text-muted small">
                                        <i class="fas fa-info-circle"></i>
                                        è¿™äº›å‚æ•°ç”¨äº Pyrogram å®¢æˆ·ç«¯ï¼Œæ”¯æŒå¤§æ–‡ä»¶ä¸Šä¼ ï¼ˆ50MB-2GBï¼‰
                                    </div>

                                    <!-- API é…ç½®çŠ¶æ€æç¤º -->
                                    <div id="apiConfigStatus" class="mt-2" style="display: none;">
                                        <div class="alert alert-warning alert-sm mb-0">
                                            <i class="fas fa-exclamation-triangle"></i>
                                            <strong>å¯é€‰é…ç½®ï¼š</strong>ä¸é…ç½® API ID/Hash åªèƒ½å‘é€å°æ–‡ä»¶ï¼ˆâ‰¤50MBï¼‰ï¼Œé…ç½®åå¯å‘é€å¤§æ–‡ä»¶ï¼ˆæœ€å¤§2GBï¼‰
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Bot é…ç½® -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="botToken" class="form-label fw-bold">
                                    <i class="fas fa-robot text-primary"></i> Bot Token
                                </label>
                                <input type="password" class="form-control" id="botToken" name="bot_token" 
                                       placeholder="ä» @BotFather è·å–">
                                <div class="form-text">
                                    <a href="https://t.me/BotFather" target="_blank" class="text-decoration-none">
                                        <i class="fas fa-external-link-alt"></i> åˆ›å»º Bot
                                    </a>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="chatId" class="form-label fw-bold">
                                    <i class="fas fa-comments text-primary"></i> Chat ID
                                </label>
                                <input type="text" class="form-control" id="chatId" name="chat_id" 
                                       placeholder="æ¥æ”¶æ¶ˆæ¯çš„èŠå¤©ID">
                                <div class="form-text">
                                    <a href="https://t.me/userinfobot" target="_blank" class="text-decoration-none">
                                        <i class="fas fa-external-link-alt"></i> è·å– Chat ID
                                    </a>
                                </div>
                            </div>
                        </div>

                        <!-- åŠŸèƒ½å¼€å…³ -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <h6 class="fw-bold mb-3">
                                    <i class="fas fa-toggle-on text-success"></i> åŠŸèƒ½å¼€å…³
                                </h6>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="enableTelegram" name="enabled">
                                            <label class="form-check-label" for="enableTelegram">
                                                å¯ç”¨ Telegram é€šçŸ¥
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="enableWebhook" name="webhook_enabled">
                                            <label class="form-check-label" for="enableWebhook">
                                                å¯ç”¨ Webhook è‡ªåŠ¨ä¸‹è½½
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="autoDownload" name="auto_download">
                                            <label class="form-check-label" for="autoDownload">
                                                è‡ªåŠ¨ä¸‹è½½é“¾æ¥
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- æ¨é€è®¾ç½® -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="pushMode" class="form-label fw-bold">
                                    <i class="fas fa-paper-plane text-primary"></i> æ¨é€æ¨¡å¼
                                </label>
                                <select class="form-select" id="pushMode" name="push_mode">
                                    <option value="file">ä»…æ–‡ä»¶</option>
                                    <option value="message">ä»…é€šçŸ¥</option>
                                    <option value="both">æ–‡ä»¶+é€šçŸ¥</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="fileSizeLimit" class="form-label fw-bold">
                                    <i class="fas fa-file-archive text-primary"></i> æ–‡ä»¶å¤§å°é™åˆ¶ (MB)
                                </label>
                                <input type="number" class="form-control" id="fileSizeLimit" name="file_size_limit_mb" 
                                       value="50" min="1" max="2000">
                            </div>
                        </div>

                        <!-- æ“ä½œæŒ‰é’® -->
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> ä¿å­˜é…ç½®
                            </button>
                            <button type="button" class="btn btn-outline-secondary" id="loadConfig">
                                <i class="fas fa-sync-alt"></i> é‡æ–°åŠ è½½
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- å³ä¾§ï¼šWebhook é…ç½® -->
        <div class="col-lg-4">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">
                        <i class="fas fa-link text-warning"></i> Webhook é…ç½®
                    </h5>
                </div>
                <div class="card-body">
                    <!-- ç«¯å£é™åˆ¶è¯´æ˜ -->
                    <div class="alert alert-warning border-0 mb-3">
                        <h6 class="alert-heading">
                            <i class="fas fa-exclamation-triangle"></i> ç«¯å£é™åˆ¶
                        </h6>
                        <p class="mb-2">Telegram åªæ”¯æŒç«¯å£ï¼š<code>80, 88, 443, 8443</code></p>
                        <p class="mb-0">æ‚¨çš„æœåŠ¡è¿è¡Œåœ¨ <code>8090</code> ç«¯å£ï¼Œéœ€è¦ä½¿ç”¨ä»£ç†</p>
                    </div>

                    <!-- æœåŠ¡å™¨åœ°å€é…ç½® -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-server text-primary"></i> ç›®æ ‡æœåŠ¡å™¨åœ°å€
                        </label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="targetServerUrl"
                                   placeholder="http://your-domain.com:8090">
                            <button class="btn btn-outline-primary" onclick="generateWorkerCode()" type="button">
                                <i class="fas fa-code"></i> ç”Ÿæˆä»£ç 
                            </button>
                            <button class="btn btn-outline-secondary" onclick="testJavaScript()" type="button">
                                <i class="fas fa-bug"></i> æµ‹è¯•
                            </button>
                        </div>
                        <div class="form-text">æ‚¨çš„ yt-dlp æœåŠ¡å™¨åœ°å€ï¼ˆå¯è‡ªå®šä¹‰åŸŸåï¼‰</div>
                    </div>

                    <!-- Cloudflare Workers URL -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="fab fa-cloudflare text-warning"></i> Cloudflare Worker URL
                        </label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="cloudflareWorkerUrl" 
                                   placeholder="https://your-worker.workers.dev/telegram/webhook">
                            <button class="btn btn-outline-secondary" onclick="copyCloudflareUrl()">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        <div class="form-text">
                            <a href="#" onclick="showCloudflareGuide()" class="text-decoration-none">
                                <i class="fas fa-question-circle"></i> å¦‚ä½•é…ç½®ï¼Ÿ
                            </a>
                        </div>
                    </div>

                    <!-- ç›´è¿ URLï¼ˆä»…æ˜¾ç¤ºï¼‰ -->
                    <div class="mb-3">
                        <label class="form-label fw-bold text-muted">
                            <i class="fas fa-times-circle text-danger"></i> ç›´è¿æ–¹å¼ï¼ˆä¸å¯ç”¨ï¼‰
                        </label>
                        <input type="text" class="form-control" id="webhookUrl" readonly 
                               placeholder="ç«¯å£ 8090 ä¸è¢« Telegram æ”¯æŒ">
                    </div>
                </div>
            </div>

            <!-- çŠ¶æ€å¡ç‰‡ -->
            <div class="card shadow-sm mt-3">
                <div class="card-header bg-white">
                    <h6 class="mb-0">
                        <i class="fas fa-info-circle text-info"></i> é…ç½®çŠ¶æ€
                    </h6>
                </div>
                <div class="card-body">
                    <div id="configStatus">
                        <div class="d-flex align-items-center mb-2">
                            <i class="fas fa-circle text-secondary me-2"></i>
                            <span class="text-muted">ç­‰å¾…é…ç½®...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æµ‹è¯•ç»“æœåŒºåŸŸ -->
    <div class="row mt-4">
        <div class="col-12">
            <div id="testResults"></div>
        </div>
    </div>
</div>

<style>
.bg-gradient-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.card {
    border-radius: 12px;
    border: none;
}

.card-header {
    border-radius: 12px 12px 0 0 !important;
    border-bottom: 1px solid #e9ecef;
}

.form-control, .form-select {
    border-radius: 8px;
    border: 1px solid #dee2e6;
    transition: all 0.2s ease;
}

.form-control:focus, .form-select:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
}

.btn {
    border-radius: 8px;
    font-weight: 500;
    transition: all 0.2s ease;
}

.alert {
    border-radius: 10px;
}

.form-check-input:checked {
    background-color: #667eea;
    border-color: #667eea;
}

.input-group .btn {
    border-radius: 0 8px 8px 0;
}

.input-group .form-control {
    border-radius: 8px 0 0 8px;
}
</style>

<script>
// é¡µé¢åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    console.log('é¡µé¢åˆå§‹åŒ–å¼€å§‹');

    try {
        // è®¾ç½®é»˜è®¤æœåŠ¡å™¨åœ°å€
        const currentHost = window.location.host;
        const targetServerInput = document.getElementById('targetServerUrl');
        if (targetServerInput) {
            targetServerInput.value = `http://${currentHost}`;
            console.log('é»˜è®¤æœåŠ¡å™¨åœ°å€è®¾ç½®ä¸º:', `http://${currentHost}`);
        } else {
            console.error('æ‰¾ä¸åˆ° targetServerUrl å…ƒç´ ');
        }

        // è®¾ç½®ç›´è¿ Webhook URL
        const webhookUrl = window.location.origin + '/telegram/webhook';
        const webhookUrlInput = document.getElementById('webhookUrl');
        if (webhookUrlInput) {
            webhookUrlInput.value = webhookUrl;
            console.log('Webhook URL è®¾ç½®ä¸º:', webhookUrl);
        } else {
            console.error('æ‰¾ä¸åˆ° webhookUrl å…ƒç´ ');
        }

        // ç»‘å®šäº‹ä»¶
        const form = document.getElementById('telegramConfigForm');
        if (form) {
            form.addEventListener('submit', saveTelegramConfig);
            console.log('è¡¨å•æäº¤äº‹ä»¶å·²ç»‘å®š');
        }

        const loadBtn = document.getElementById('loadConfig');
        if (loadBtn) {
            loadBtn.addEventListener('click', loadTelegramConfig);
            console.log('åŠ è½½é…ç½®æŒ‰é’®äº‹ä»¶å·²ç»‘å®š');
        }

        const testBtn = document.getElementById('testConnection');
        if (testBtn) {
            testBtn.addEventListener('click', testConnection);
            console.log('æµ‹è¯•è¿æ¥æŒ‰é’®äº‹ä»¶å·²ç»‘å®š');
        }

        const testFilePushBtn = document.getElementById('testFilePush');
        if (testFilePushBtn) {
            testFilePushBtn.addEventListener('click', testFilePush);
            console.log('æµ‹è¯•æ–‡ä»¶æ¨é€æŒ‰é’®äº‹ä»¶å·²ç»‘å®š');
        }

        const checkPushConfigBtn = document.getElementById('checkPushConfig');
        if (checkPushConfigBtn) {
            checkPushConfigBtn.addEventListener('click', checkPushConfig);
            console.log('æ£€æŸ¥æ¨é€é…ç½®æŒ‰é’®äº‹ä»¶å·²ç»‘å®š');
        }

        const webhookBtn = document.getElementById('setupWebhook');
        if (webhookBtn) {
            webhookBtn.addEventListener('click', setupWebhook);
            console.log('è®¾ç½®WebhookæŒ‰é’®äº‹ä»¶å·²ç»‘å®š');
        }

        // åŠ è½½ç°æœ‰é…ç½®
        loadTelegramConfig();
        console.log('é¡µé¢åˆå§‹åŒ–å®Œæˆ');

    } catch (error) {
        console.error('é¡µé¢åˆå§‹åŒ–å¤±è´¥:', error);
        alert('é¡µé¢åˆå§‹åŒ–å¤±è´¥: ' + error.message);
    }
});

// éªŒè¯ API é…ç½®
function validateApiConfig() {
    const apiId = document.getElementById('apiId').value.trim();
    const apiHash = document.getElementById('apiHash').value.trim();

    // API ID/Hash æ˜¯å¯é€‰çš„ï¼Œä½†å¦‚æœå¡«å†™äº†å°±è¦éªŒè¯æ ¼å¼
    if (apiId || apiHash) {
        if (!apiId || !apiHash) {
            showMessage('API ID å’Œ API Hash å¿…é¡»åŒæ—¶å¡«å†™æˆ–åŒæ—¶ç•™ç©º', 'warning');
            return false;
        }

        // éªŒè¯ API ID æ ¼å¼ï¼ˆåº”è¯¥æ˜¯æ•°å­—ï¼‰
        if (!/^\d+$/.test(apiId)) {
            showMessage('API ID åº”è¯¥æ˜¯çº¯æ•°å­—', 'danger');
            return false;
        }

        // éªŒè¯ API Hash æ ¼å¼ï¼ˆåº”è¯¥æ˜¯32ä½åå…­è¿›åˆ¶å­—ç¬¦ä¸²ï¼‰
        if (!/^[a-f0-9]{32}$/i.test(apiHash)) {
            showMessage('API Hash åº”è¯¥æ˜¯32ä½åå…­è¿›åˆ¶å­—ç¬¦ä¸²', 'danger');
            return false;
        }
    }

    return true;
}

// æ›´æ–° API é…ç½®çŠ¶æ€æ˜¾ç¤º
function updateApiConfigStatus(config) {
    const statusDiv = document.getElementById('apiConfigStatus');
    const apiConfigured = config && config.api_id_configured && config.api_hash_configured;

    if (!apiConfigured) {
        statusDiv.style.display = 'block';
    } else {
        statusDiv.style.display = 'none';
    }
}

// ç”Ÿæˆ Worker ä»£ç 
function generateWorkerCode() {
    console.log('generateWorkerCode å‡½æ•°è¢«è°ƒç”¨');

    const targetServer = document.getElementById('targetServerUrl').value.trim();
    console.log('ç›®æ ‡æœåŠ¡å™¨åœ°å€:', targetServer);

    if (!targetServer) {
        showMessage('è¯·å…ˆå¡«å†™ç›®æ ‡æœåŠ¡å™¨åœ°å€', 'warning');
        return;
    }

    try {
        new URL(targetServer);
        console.log('URL éªŒè¯é€šè¿‡');
    } catch (e) {
        console.error('URL éªŒè¯å¤±è´¥:', e);
        showMessage('æœåŠ¡å™¨åœ°å€æ ¼å¼ä¸æ­£ç¡®', 'danger');
        return;
    }

    const workerCode = `// Cloudflare Workers ä»£ç†è„šæœ¬
// ç›®æ ‡æœåŠ¡å™¨: ${targetServer}
const TARGET_SERVER = '${targetServer}';
const WEBHOOK_PATH = '/telegram/webhook';

addEventListener('fetch', event => {
  event.respondWith(handleRequest(event.request));
});

async function handleRequest(request) {
  const url = new URL(request.url);

  if (url.pathname === WEBHOOK_PATH) {
    return await proxyToServer(request);
  }

  if (url.pathname === '/health') {
    return new Response(JSON.stringify({status: 'ok', target: TARGET_SERVER}), {
      headers: { 'Content-Type': 'application/json' }
    });
  }

  if (url.pathname === '/') {
    return new Response(\\\`<h1>YT-DLP Telegram Proxy</h1><p>Webhook URL: \\\${request.url}telegram/webhook</p><p>Target: \\\${TARGET_SERVER}</p>\\\`, {
      headers: { 'Content-Type': 'text/html' }
    });
  }

  return new Response('Not Found', { status: 404 });
}

async function proxyToServer(request) {
  try {
    const targetUrl = TARGET_SERVER + WEBHOOK_PATH;
    const headers = new Headers();

    ['content-type', 'content-length', 'x-telegram-bot-api-secret-token'].forEach(name => {
      const value = request.headers.get(name);
      if (value) headers.set(name, value);
    });

    headers.set('X-Forwarded-For', request.headers.get('CF-Connecting-IP') || 'unknown');
    headers.set('X-Forwarded-Proto', 'https');

    const response = await fetch(targetUrl, {
      method: request.method,
      headers: headers,
      body: request.method !== 'GET' ? request.body : null,
    });

    return new Response(response.body, {
      status: response.status,
      headers: { 'Content-Type': response.headers.get('Content-Type') || 'application/json' }
    });

  } catch (error) {
    return new Response(JSON.stringify({error: 'ä»£ç†æœåŠ¡å™¨é”™è¯¯', message: error.message}), {
      status: 502,
      headers: { 'Content-Type': 'application/json' }
    });
  }
}`;

    console.log('å‡†å¤‡æ˜¾ç¤ºç”Ÿæˆçš„ä»£ç ');
    showGeneratedCode(workerCode, targetServer);
}

// æµ‹è¯• JavaScript åŠŸèƒ½
function testJavaScript() {
    console.log('JavaScript æµ‹è¯•å‡½æ•°è¢«è°ƒç”¨');
    alert('JavaScript åŠŸèƒ½æ­£å¸¸ï¼');
    showMessage('JavaScript æµ‹è¯•æˆåŠŸ', 'success');
}

// æ˜¾ç¤ºç”Ÿæˆçš„ä»£ç 
function showGeneratedCode(code, targetServer) {
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fab fa-cloudflare text-warning"></i>
                        ç”Ÿæˆçš„ Cloudflare Worker ä»£ç 
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle"></i> ä»£ç å·²ç”Ÿæˆ</h6>
                        <p class="mb-0">ç›®æ ‡æœåŠ¡å™¨: <code>${targetServer}</code></p>
                    </div>

                    <h6>ğŸ“‹ éƒ¨ç½²æ­¥éª¤</h6>
                    <ol>
                        <li>å¤åˆ¶ä¸‹é¢çš„ä»£ç </li>
                        <li>ç™»å½• <a href="https://dash.cloudflare.com/" target="_blank">Cloudflare Dashboard</a></li>
                        <li>åˆ›å»ºæ–°çš„ Workerï¼ˆå‘½åï¼šyt-dlp-telegram-proxyï¼‰</li>
                        <li>ç²˜è´´ä»£ç å¹¶éƒ¨ç½²</li>
                        <li>è·å– Worker URL å¹¶å¡«å†™åˆ°ä¸Šé¢çš„è¾“å…¥æ¡†</li>
                    </ol>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Cloudflare Worker ä»£ç </label>
                        <div class="position-relative">
                            <textarea class="form-control font-monospace" rows="15" readonly onclick="this.select()" id="generatedCode">${code}</textarea>
                            <button class="btn btn-sm btn-primary position-absolute top-0 end-0 m-2" onclick="copyGeneratedCode()">
                                <i class="fas fa-copy"></i> å¤åˆ¶
                            </button>
                        </div>
                    </div>

                    <div class="alert alert-success">
                        <h6><i class="fas fa-check-circle"></i> ä¸‹ä¸€æ­¥</h6>
                        <p class="mb-0">éƒ¨ç½² Worker åï¼Œå°† Worker URL å¡«å†™åˆ° "Cloudflare Worker URL" è¾“å…¥æ¡†ä¸­ã€‚</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                    <button type="button" class="btn btn-primary" onclick="copyGeneratedCode()">
                        <i class="fas fa-copy"></i> å¤åˆ¶ä»£ç 
                    </button>
                    <a href="https://dash.cloudflare.com/" target="_blank" class="btn btn-success">
                        <i class="fas fa-external-link-alt"></i> æ‰“å¼€ Cloudflare
                    </a>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();

    modal.addEventListener('hidden.bs.modal', () => {
        document.body.removeChild(modal);
    });
}

// å¤åˆ¶ç”Ÿæˆçš„ä»£ç 
function copyGeneratedCode() {
    const code = document.getElementById('generatedCode').value;
    navigator.clipboard.writeText(code).then(() => {
        showMessage('Worker ä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
    }).catch(() => {
        showMessage('å¤åˆ¶å¤±è´¥', 'danger');
    });
}

// å¤åˆ¶ Cloudflare Worker URL
function copyCloudflareUrl() {
    const workerUrl = document.getElementById('cloudflareWorkerUrl').value;
    if (!workerUrl) {
        showMessage('è¯·å…ˆå¡«å†™ Cloudflare Worker URL', 'warning');
        return;
    }
    navigator.clipboard.writeText(workerUrl).then(() => {
        showMessage('Cloudflare Worker URLå·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
    }).catch(() => {
        showMessage('å¤åˆ¶å¤±è´¥', 'danger');
    });
}

// æ˜¾ç¤º Cloudflare é…ç½®æŒ‡å—
function showCloudflareGuide() {
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fab fa-cloudflare text-warning"></i>
                        Cloudflare Workers é…ç½®æŒ‡å—
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle"></i> ä¸ºä»€ä¹ˆéœ€è¦ Cloudflare Workersï¼Ÿ</h6>
                        <p class="mb-0">Telegram åªæ”¯æŒç«¯å£ 80, 88, 443, 8443ï¼Œè€Œæ‚¨çš„æœåŠ¡è¿è¡Œåœ¨ 8090 ç«¯å£ã€‚Cloudflare Workers å¯ä»¥ä½œä¸ºåå‘ä»£ç†è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
                    </div>

                    <h6>ğŸ“‹ é…ç½®æ­¥éª¤</h6>
                    <ol>
                        <li><strong>å¡«å†™æœåŠ¡å™¨åœ°å€</strong><br>
                            åœ¨ä¸Šé¢çš„"ç›®æ ‡æœåŠ¡å™¨åœ°å€"ä¸­å¡«å†™æ‚¨çš„æœåŠ¡å™¨åœ°å€
                        </li>
                        <li><strong>ç”Ÿæˆä»£ç </strong><br>
                            ç‚¹å‡»"ç”Ÿæˆä»£ç "æŒ‰é’®ï¼Œè·å–è‡ªå®šä¹‰çš„ Worker ä»£ç 
                        </li>
                        <li><strong>éƒ¨ç½² Worker</strong><br>
                            ç™»å½• <a href="https://dash.cloudflare.com/" target="_blank">Cloudflare Dashboard</a>ï¼Œåˆ›å»ºå¹¶éƒ¨ç½² Worker
                        </li>
                        <li><strong>è®¾ç½® Webhook</strong><br>
                            å°† Worker URL å¡«å†™åˆ°"Cloudflare Worker URL"è¾“å…¥æ¡†ä¸­
                        </li>
                    </ol>

                    <div class="alert alert-success">
                        <h6><i class="fas fa-check-circle"></i> å®Œæˆå</h6>
                        <p class="mb-0">æ‚¨å°±å¯ä»¥å‘ Bot å‘é€è§†é¢‘é“¾æ¥ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ä¸‹è½½å¹¶æ¨é€æ–‡ä»¶åˆ° Telegramï¼</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                    <a href="https://dash.cloudflare.com/" target="_blank" class="btn btn-primary">
                        <i class="fas fa-external-link-alt"></i> æ‰“å¼€ Cloudflare
                    </a>
                </div>
            </div>
        </div>
    `;

    document.body.appendChild(modal);
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();

    modal.addEventListener('hidden.bs.modal', () => {
        document.body.removeChild(modal);
    });
}

// ä¿å­˜é…ç½®
function saveTelegramConfig(event) {
    event.preventDefault();

    // éªŒè¯ API é…ç½®
    if (!validateApiConfig()) {
        return;
    }

    const formData = new FormData(event.target);
    const data = Object.fromEntries(formData.entries());

    // å¤„ç†å¤é€‰æ¡†
    data.enabled = document.getElementById('enableTelegram').checked;
    data.webhook_enabled = document.getElementById('enableWebhook').checked;
    data.auto_download = document.getElementById('autoDownload').checked;

    // æ·»åŠ  Cloudflare Worker URL
    data.webhook_url = document.getElementById('cloudflareWorkerUrl').value.trim();

    fetch('/telegram/api/config', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        credentials: 'same-origin',
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('é…ç½®ä¿å­˜æˆåŠŸ', 'success');
            updateConfigStatus();
        } else {
            showMessage('é…ç½®ä¿å­˜å¤±è´¥: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        showMessage('ä¿å­˜å¤±è´¥: ' + error.message, 'danger');
    });
}

// åŠ è½½é…ç½®
function loadTelegramConfig() {
    fetch('/telegram/api/config', {
        method: 'GET',
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const config = data.config;

            // å¡«å……è¡¨å•
            document.getElementById('botToken').value = config.bot_token || '';
            document.getElementById('chatId').value = config.chat_id || '';
            document.getElementById('apiId').value = config.api_id || '';
            document.getElementById('apiHash').value = config.api_hash || '';
            document.getElementById('enableTelegram').checked = config.enabled || false;
            document.getElementById('enableWebhook').checked = config.webhook_enabled || false;
            document.getElementById('autoDownload').checked = config.auto_download || false;
            document.getElementById('pushMode').value = config.push_mode || 'file';
            document.getElementById('fileSizeLimit').value = config.file_size_limit_mb || 50;
            document.getElementById('cloudflareWorkerUrl').value = config.webhook_url || '';

            updateConfigStatus();
            updateApiConfigStatus(config);
        }
    })
    .catch(error => {
        console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
    });
}

// æµ‹è¯•è¿æ¥
function testConnection() {
    const btn = document.getElementById('testConnection');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æµ‹è¯•ä¸­...';

    const botToken = document.getElementById('botToken').value.trim();
    const chatId = document.getElementById('chatId').value.trim();

    if (!botToken || !chatId) {
        showMessage('è¯·å…ˆå¡«å†™ Bot Token å’Œ Chat ID', 'warning');
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-test-tube"></i> æµ‹è¯•è¿æ¥';
        return;
    }

    fetch('/telegram/api/test', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        credentials: 'same-origin',
        body: JSON.stringify({
            bot_token: botToken,
            chat_id: chatId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('è¿æ¥æµ‹è¯•æˆåŠŸï¼Bot ä¿¡æ¯å·²éªŒè¯ï¼Œå¯ä»¥å‘é€æ¶ˆæ¯', 'success');
        } else {
            showMessage('è¿æ¥æµ‹è¯•å¤±è´¥: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        showMessage('æµ‹è¯•å¤±è´¥: ' + error.message, 'danger');
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-test-tube"></i> æµ‹è¯•è¿æ¥';
    });
}

// æµ‹è¯•æ–‡ä»¶æ¨é€
function testFilePush() {
    const btn = document.getElementById('testFilePush');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æµ‹è¯•ä¸­...';

    const botToken = document.getElementById('botToken').value.trim();
    const chatId = document.getElementById('chatId').value.trim();

    if (!botToken || !chatId) {
        showMessage('è¯·å…ˆå¡«å†™ Bot Token å’Œ Chat ID', 'warning');
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-file-upload"></i> æµ‹è¯•æ–‡ä»¶æ¨é€';
        return;
    }

    fetch('/telegram/api/test-file-push', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        credentials: 'same-origin',
        body: JSON.stringify({
            bot_token: botToken,
            chat_id: chatId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('æ–‡ä»¶æ¨é€æµ‹è¯•æˆåŠŸï¼è¯·æ£€æŸ¥æ‚¨çš„ Telegram', 'success');
        } else {
            showMessage('æ–‡ä»¶æ¨é€æµ‹è¯•å¤±è´¥: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        showMessage('æµ‹è¯•å¤±è´¥: ' + error.message, 'danger');
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-file-upload"></i> æµ‹è¯•æ–‡ä»¶æ¨é€';
    });
}

// æ£€æŸ¥æ¨é€é…ç½®
function checkPushConfig() {
    const btn = document.getElementById('checkPushConfig');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æ£€æŸ¥ä¸­...';

    fetch('/telegram/api/check-push-config', {
        method: 'GET',
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const config = data.config;
            let message = 'ğŸ“‹ **æ¨é€é…ç½®æ£€æŸ¥ç»“æœ**\n\n';

            // Telegram é€šçŸ¥å™¨çŠ¶æ€
            message += `ğŸ¤– **Telegram é€šçŸ¥å™¨**\n`;
            message += `- å¯ç”¨çŠ¶æ€: ${config.telegram_enabled ? 'âœ… å·²å¯ç”¨' : 'âŒ æœªå¯ç”¨'}\n`;
            message += `- Bot Token: ${config.bot_token_configured ? 'âœ… å·²é…ç½®' : 'âŒ æœªé…ç½®'}\n`;
            message += `- Chat ID: ${config.chat_id_configured ? 'âœ… å·²é…ç½®' : 'âŒ æœªé…ç½®'}\n\n`;

            // Webhook é…ç½®
            message += `ğŸ”— **Webhook é…ç½®**\n`;
            message += `- Webhook å¯ç”¨: ${config.webhook_enabled ? 'âœ… å·²å¯ç”¨' : 'âŒ æœªå¯ç”¨'}\n`;
            message += `- è‡ªåŠ¨ä¸‹è½½: ${config.auto_download ? 'âœ… å·²å¯ç”¨' : 'âŒ æœªå¯ç”¨'}\n`;
            message += `- æ¨é€æ¨¡å¼: ${config.push_mode}\n\n`;

            // é—®é¢˜è¯Šæ–­
            message += `ğŸ” **é—®é¢˜è¯Šæ–­**\n`;
            const issues = [];

            if (!config.telegram_enabled) issues.push('- Telegram é€šçŸ¥æœªå¯ç”¨');
            if (!config.bot_token_configured) issues.push('- Bot Token æœªé…ç½®');
            if (!config.chat_id_configured) issues.push('- Chat ID æœªé…ç½®');
            if (!config.webhook_enabled) issues.push('- Webhook æœªå¯ç”¨');
            if (!config.auto_download) issues.push('- è‡ªåŠ¨ä¸‹è½½æœªå¯ç”¨');

            // æ£€æŸ¥ API ID/Hash é…ç½®çŠ¶æ€
            const apiConfigured = config.api_id_configured && config.api_hash_configured;

            if (issues.length === 0) {
                if (apiConfigured) {
                    message += 'âœ… é…ç½®å®Œæ•´ï¼Œæ”¯æŒæ‰€æœ‰æ–‡ä»¶å¤§å°çš„æ¨é€\n';
                    message += 'ğŸ“‹ åŠŸèƒ½è¯´æ˜ï¼š\n';
                    message += '  â€¢ â‰¤50MB: ä½¿ç”¨ Bot APIï¼ˆæ›´ç¨³å®šï¼‰\n';
                    message += '  â€¢ 50MB-2GB: ä½¿ç”¨ Pyrogramï¼ˆæ”¯æŒå¤§æ–‡ä»¶ï¼‰';
                } else {
                    message += 'âš ï¸ åŸºç¡€é…ç½®æ­£å¸¸ï¼Œä½†æœ‰é™åˆ¶\n';
                    message += 'ğŸ“‹ å½“å‰çŠ¶æ€ï¼š\n';
                    message += '  â€¢ â‰¤50MB: âœ… å¯ä»¥æ¨é€\n';
                    message += '  â€¢ >50MB: âŒ éœ€è¦é…ç½® API ID/Hash\n\n';
                    message += 'ğŸ’¡ å»ºè®®é…ç½® API ID å’Œ API Hash ä»¥æ”¯æŒå¤§æ–‡ä»¶æ¨é€';
                }
            } else {
                message += 'âŒ å‘ç°ä»¥ä¸‹é—®é¢˜ï¼š\n' + issues.join('\n');
                if (!apiConfigured) {
                    message += '\n\nâš ï¸ å¦å¤–ï¼Œæœªé…ç½® API ID/Hashï¼Œæ— æ³•æ¨é€å¤§æ–‡ä»¶ï¼ˆ>50MBï¼‰';
                }
            }

            showMessage(message, 'info');
        } else {
            showMessage('æ£€æŸ¥å¤±è´¥: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        showMessage('æ£€æŸ¥å¤±è´¥: ' + error.message, 'danger');
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-search"></i> æ£€æŸ¥æ¨é€é…ç½®';
    });
}

// è®¾ç½® Webhook
function setupWebhook() {
    const btn = document.getElementById('setupWebhook');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> è®¾ç½®ä¸­...';

    // æ£€æŸ¥æ˜¯å¦æœ‰ Cloudflare Worker URL
    const cloudflareUrl = document.getElementById('cloudflareWorkerUrl').value.trim();

    const requestData = {};
    if (cloudflareUrl) {
        requestData.webhook_url = cloudflareUrl;
        console.log('ä½¿ç”¨ Cloudflare Worker URL:', cloudflareUrl);
    }

    fetch('/telegram/api/setup-webhook', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        credentials: 'same-origin',
        body: JSON.stringify(requestData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showMessage('Webhook è®¾ç½®æˆåŠŸï¼ç°åœ¨å¯ä»¥å‘ Bot å‘é€é“¾æ¥äº†', 'success');
        } else {
            if (data.port_issue) {
                showMessage('ç«¯å£é—®é¢˜ï¼š' + data.error + 'ã€‚è¯·ä½¿ç”¨ Cloudflare Workers ä»£ç†', 'warning');
            } else {
                showMessage('Webhook è®¾ç½®å¤±è´¥: ' + data.error, 'danger');
            }
        }
    })
    .catch(error => {
        showMessage('è®¾ç½®å¤±è´¥: ' + error.message, 'danger');
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-link"></i> è®¾ç½®Webhook';
    });
}

// æ›´æ–°é…ç½®çŠ¶æ€
function updateConfigStatus() {
    const botToken = document.getElementById('botToken').value.trim();
    const chatId = document.getElementById('chatId').value.trim();
    const enabled = document.getElementById('enableTelegram').checked;
    const webhookEnabled = document.getElementById('enableWebhook').checked;
    const autoDownload = document.getElementById('autoDownload').checked;

    const statusContainer = document.getElementById('configStatus');
    let statusHtml = '';

    if (botToken && chatId) {
        statusHtml += '<div class="d-flex align-items-center mb-2"><i class="fas fa-check-circle text-success me-2"></i><span>Bot é…ç½®å®Œæˆ</span></div>';
    } else {
        statusHtml += '<div class="d-flex align-items-center mb-2"><i class="fas fa-times-circle text-danger me-2"></i><span>Bot é…ç½®æœªå®Œæˆ</span></div>';
    }

    if (enabled) {
        statusHtml += '<div class="d-flex align-items-center mb-2"><i class="fas fa-check-circle text-success me-2"></i><span>Telegram é€šçŸ¥å·²å¯ç”¨</span></div>';
    } else {
        statusHtml += '<div class="d-flex align-items-center mb-2"><i class="fas fa-times-circle text-warning me-2"></i><span>Telegram é€šçŸ¥æœªå¯ç”¨</span></div>';
    }

    if (webhookEnabled && autoDownload) {
        statusHtml += '<div class="d-flex align-items-center mb-2"><i class="fas fa-check-circle text-success me-2"></i><span>è‡ªåŠ¨ä¸‹è½½å·²å¯ç”¨</span></div>';
    } else {
        statusHtml += '<div class="d-flex align-items-center mb-2"><i class="fas fa-times-circle text-warning me-2"></i><span>è‡ªåŠ¨ä¸‹è½½æœªå¯ç”¨</span></div>';
    }

    statusContainer.innerHTML = statusHtml;
}

// æ˜¾ç¤ºæ¶ˆæ¯
function showMessage(message, type) {
    const container = document.getElementById('testResults');
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show`;
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    container.appendChild(alert);

    setTimeout(() => {
        if (alert.parentNode) {
            alert.parentNode.removeChild(alert);
        }
    }, 5000);
}
</script>
{% endblock %}
