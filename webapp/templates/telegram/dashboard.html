{% extends "base.html" %}

{% block title %}Telegramæ§åˆ¶å°{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fab fa-telegram"></i> Telegramæ§åˆ¶å°</h2>
                <div>
                    <button id="refreshStatus" class="btn btn-outline-primary me-2">
                        <i class="fas fa-sync-alt"></i> åˆ·æ–°çŠ¶æ€
                    </button>
                    <a href="/telegram/settings" class="btn btn-primary">
                        <i class="fas fa-cog"></i> è®¾ç½®
                    </a>
                </div>
            </div>

            <!-- çŠ¶æ€æ¦‚è§ˆ -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <div id="connectionStatus">
                                <div class="spinner-border spinner-border-sm" role="status"></div>
                                <div class="mt-2">æ£€æŸ¥ä¸­...</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <div id="webhookStatus">
                                <div class="spinner-border spinner-border-sm" role="status"></div>
                                <div class="mt-2">æ£€æŸ¥ä¸­...</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <div id="autoDownloadStatus">
                                <div class="spinner-border spinner-border-sm" role="status"></div>
                                <div class="mt-2">æ£€æŸ¥ä¸­...</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-body text-center">
                            <div id="pushModeStatus">
                                <div class="spinner-border spinner-border-sm" role="status"></div>
                                <div class="mt-2">æ£€æŸ¥ä¸­...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- åŠŸèƒ½åŒºåŸŸ -->
            <div class="row">
                <!-- å¿«é€Ÿæ“ä½œ -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-bolt"></i> å¿«é€Ÿæ“ä½œ</h5>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <button id="testConnection" class="btn btn-outline-primary">
                                    <i class="fas fa-test-tube"></i> æµ‹è¯•è¿æ¥
                                </button>
                                <button id="testFilePush" class="btn btn-outline-success">
                                    <i class="fas fa-file-upload"></i> æµ‹è¯•æ–‡ä»¶æ¨é€
                                </button>
                                <button id="sendTestMessage" class="btn btn-outline-info">
                                    <i class="fas fa-comment"></i> å‘é€æµ‹è¯•æ¶ˆæ¯
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ä½¿ç”¨è¯´æ˜ -->
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-info-circle"></i> ä½¿ç”¨è¯´æ˜</h5>
                        </div>
                        <div class="card-body">
                            <h6>ğŸ“± Telegramè‡ªåŠ¨ä¸‹è½½</h6>
                            <ol class="small">
                                <li>ç¡®ä¿Botå·²é…ç½®å¹¶å¯ç”¨</li>
                                <li>åœ¨Telegramä¸­å‘Botå‘é€è§†é¢‘é“¾æ¥</li>
                                <li>Botä¼šè‡ªåŠ¨å¼€å§‹ä¸‹è½½</li>
                                <li>ä¸‹è½½å®Œæˆåè‡ªåŠ¨å‘é€æ–‡ä»¶</li>
                            </ol>
                            
                            <h6 class="mt-3">ğŸ”§ Webhooké…ç½®</h6>
                            <p class="small">
                                å¯ç”¨Webhookåï¼Œå¯ä»¥ç›´æ¥åœ¨Telegramä¸­å‘é€é“¾æ¥ç»™Botï¼Œ
                                Botä¼šè‡ªåŠ¨ä¸‹è½½å¹¶å‘é€æ–‡ä»¶ã€‚
                            </p>
                            
                            <div id="webhookUrl" class="mt-2" style="display: none;">
                                <strong>Webhook URL:</strong><br>
                                <code id="webhookUrlText"></code>
                                <button class="btn btn-sm btn-outline-secondary ms-2" onclick="copyWebhookUrl()">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æœ€è¿‘æ´»åŠ¨ -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-history"></i> æœ€è¿‘æ´»åŠ¨</h5>
                        </div>
                        <div class="card-body">
                            <div id="recentActivity">
                                <div class="text-center text-muted">
                                    <i class="fas fa-clock fa-2x mb-2"></i>
                                    <p>æš‚æ— æ´»åŠ¨è®°å½•</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æµ‹è¯•ç»“æœ -->
            <div id="testResults" class="mt-4"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadTelegramStatus();
    
    // ç»‘å®šäº‹ä»¶
    document.getElementById('refreshStatus').addEventListener('click', loadTelegramStatus);
    document.getElementById('testConnection').addEventListener('click', testConnection);
    document.getElementById('testFilePush').addEventListener('click', testFilePush);
    document.getElementById('sendTestMessage').addEventListener('click', sendTestMessage);
});

// åŠ è½½TelegramçŠ¶æ€
function loadTelegramStatus() {
    fetch('/telegram/api/config', {
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayTelegramStatus(data.config);
        } else {
            showError('è·å–çŠ¶æ€å¤±è´¥: ' + data.error);
        }
    })
    .catch(error => {
        showError('è·å–çŠ¶æ€å¤±è´¥: ' + error.message);
    });
}

// æ˜¾ç¤ºTelegramçŠ¶æ€
function displayTelegramStatus(config) {
    // è¿æ¥çŠ¶æ€
    const connectionEl = document.getElementById('connectionStatus');
    if (config.enabled && config.bot_token_configured && config.chat_id_configured) {
        connectionEl.innerHTML = `
            <i class="fas fa-check-circle fa-2x text-success"></i>
            <div class="mt-2"><strong>å·²è¿æ¥</strong></div>
        `;
    } else {
        connectionEl.innerHTML = `
            <i class="fas fa-times-circle fa-2x text-danger"></i>
            <div class="mt-2"><strong>æœªé…ç½®</strong></div>
        `;
    }
    
    // WebhookçŠ¶æ€
    const webhookEl = document.getElementById('webhookStatus');
    if (config.webhook_enabled) {
        webhookEl.innerHTML = `
            <i class="fas fa-link fa-2x text-success"></i>
            <div class="mt-2"><strong>å·²å¯ç”¨</strong></div>
        `;
        // æ˜¾ç¤ºWebhook URL
        const webhookUrlDiv = document.getElementById('webhookUrl');
        const webhookUrlText = document.getElementById('webhookUrlText');
        webhookUrlDiv.style.display = 'block';
        webhookUrlText.textContent = window.location.origin + '/telegram/webhook';
    } else {
        webhookEl.innerHTML = `
            <i class="fas fa-unlink fa-2x text-warning"></i>
            <div class="mt-2"><strong>æœªå¯ç”¨</strong></div>
        `;
        document.getElementById('webhookUrl').style.display = 'none';
    }
    
    // è‡ªåŠ¨ä¸‹è½½çŠ¶æ€
    const autoDownloadEl = document.getElementById('autoDownloadStatus');
    if (config.auto_download) {
        autoDownloadEl.innerHTML = `
            <i class="fas fa-download fa-2x text-success"></i>
            <div class="mt-2"><strong>è‡ªåŠ¨ä¸‹è½½</strong></div>
        `;
    } else {
        autoDownloadEl.innerHTML = `
            <i class="fas fa-pause fa-2x text-warning"></i>
            <div class="mt-2"><strong>æ‰‹åŠ¨ä¸‹è½½</strong></div>
        `;
    }
    
    // æ¨é€æ¨¡å¼çŠ¶æ€
    const pushModeEl = document.getElementById('pushModeStatus');
    const modeText = {
        'file': 'æ–‡ä»¶æ¨é€',
        'notification': 'é€šçŸ¥æ¨é€',
        'both': 'æ–‡ä»¶+é€šçŸ¥'
    };
    pushModeEl.innerHTML = `
        <i class="fas fa-paper-plane fa-2x text-info"></i>
        <div class="mt-2"><strong>${modeText[config.push_mode] || 'æœªçŸ¥'}</strong></div>
    `;
}

// æµ‹è¯•è¿æ¥
function testConnection() {
    const btn = document.getElementById('testConnection');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æµ‹è¯•ä¸­...';
    
    fetch('/telegram/api/test', {
        method: 'POST',
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess('âœ… è¿æ¥æµ‹è¯•æˆåŠŸï¼' + (data.message ? ' ' + data.message : ''));
        } else {
            showError('âŒ è¿æ¥æµ‹è¯•å¤±è´¥: ' + data.error);
        }
    })
    .catch(error => {
        showError('âŒ æµ‹è¯•å¤±è´¥: ' + error.message);
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-test-tube"></i> æµ‹è¯•è¿æ¥';
    });
}

// æµ‹è¯•æ–‡ä»¶æ¨é€
function testFilePush() {
    const btn = document.getElementById('testFilePush');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> å‘é€ä¸­...';
    
    fetch('/api/telegram/test-file', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        credentials: 'same-origin',
        body: JSON.stringify({
            file_path: './telegram_test_file.txt'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccess('âœ… ' + data.message);
        } else {
            showError('âŒ æ–‡ä»¶æ¨é€å¤±è´¥: ' + data.error);
        }
    })
    .catch(error => {
        showError('âŒ æµ‹è¯•å¤±è´¥: ' + error.message);
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-file-upload"></i> æµ‹è¯•æ–‡ä»¶æ¨é€';
    });
}

// å‘é€æµ‹è¯•æ¶ˆæ¯
function sendTestMessage() {
    const btn = document.getElementById('sendTestMessage');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> å‘é€ä¸­...';
    
    // è¿™é‡Œå¯ä»¥æ·»åŠ å‘é€æµ‹è¯•æ¶ˆæ¯çš„é€»è¾‘
    setTimeout(() => {
        showInfo('ğŸ“± æµ‹è¯•æ¶ˆæ¯åŠŸèƒ½å¼€å‘ä¸­...');
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-comment"></i> å‘é€æµ‹è¯•æ¶ˆæ¯';
    }, 1000);
}

// å¤åˆ¶Webhook URL
function copyWebhookUrl() {
    const webhookUrl = document.getElementById('webhookUrlText').textContent;
    navigator.clipboard.writeText(webhookUrl).then(() => {
        showSuccess('âœ… Webhook URLå·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
    }).catch(() => {
        showError('âŒ å¤åˆ¶å¤±è´¥');
    });
}

// æ˜¾ç¤ºæ¶ˆæ¯çš„è¾…åŠ©å‡½æ•°
function showSuccess(message) {
    showMessage(message, 'success');
}

function showError(message) {
    showMessage(message, 'danger');
}

function showInfo(message) {
    showMessage(message, 'info');
}

function showMessage(message, type) {
    const container = document.getElementById('testResults');
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show`;
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    container.appendChild(alert);
    
    // è‡ªåŠ¨ç§»é™¤
    setTimeout(() => {
        if (alert.parentNode) {
            alert.parentNode.removeChild(alert);
        }
    }, 5000);
}
</script>
{% endblock %}
