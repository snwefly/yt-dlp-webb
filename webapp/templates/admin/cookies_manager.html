{% extends "base.html" %}

{% block title %}Cookiesç®¡ç† - ç®¡ç†å‘˜{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>ğŸª Cookiesç®¡ç†</h2>
                <div>
                    <a href="/admin" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> è¿”å›ç®¡ç†
                    </a>
                </div>
            </div>

            <!-- çŠ¶æ€å¡ç‰‡ -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card border-primary">
                        <div class="card-body text-center">
                            <h5 class="card-title">CookiesçŠ¶æ€</h5>
                            <div id="cookiesStatusBadge" class="mb-2">
                                <span class="badge bg-secondary">æ£€æŸ¥ä¸­...</span>
                            </div>
                            <button id="refreshStatus" class="btn btn-sm btn-primary">
                                <i class="fas fa-sync-alt"></i> åˆ·æ–°
                            </button>
                            <p id="cookiesStatusText" class="card-text text-muted">æ­£åœ¨æ£€æŸ¥çŠ¶æ€...</p>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card border-success">
                        <div class="card-body text-center">
                            <h5 class="card-title">å¹³å°æ•°é‡</h5>
                            <div id="platformCount" class="mb-2">
                                <span class="badge bg-secondary">0</span>
                            </div>
                            <button id="refreshPlatforms" class="btn btn-sm btn-success">
                                <i class="fas fa-list"></i> æŸ¥çœ‹
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ä¸»è¦åŠŸèƒ½æ ‡ç­¾é¡µ -->
            <ul class="nav nav-tabs" id="cookiesTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="import-tab" data-bs-toggle="tab" data-bs-target="#import" type="button">
                        <i class="fas fa-upload"></i> å¯¼å…¥Cookies
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="manage-tab" data-bs-toggle="tab" data-bs-target="#manage" type="button">
                        <i class="fas fa-cogs"></i> Cookiesç®¡ç†
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="help-tab" data-bs-toggle="tab" data-bs-target="#help" type="button">
                        <i class="fas fa-question-circle"></i> è·å–æŒ‡å—
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="cookiesTabContent">
                <!-- å¯¼å…¥Cookiesæ ‡ç­¾é¡µ -->
                <div class="tab-pane fade show active" id="import" role="tabpanel">
                    <div class="card mt-3">
                        <div class="card-header">
                            <h5><i class="fas fa-upload"></i> å¯¼å…¥æ–°çš„Cookies</h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <h6><i class="fas fa-info-circle"></i> æ”¯æŒçš„æ ¼å¼:</h6>
                                <ul class="mb-0">
                                    <li><strong>JSONæ ¼å¼:</strong> æµè§ˆå™¨æ‰©å±•å¯¼å‡ºçš„JSONæ–‡ä»¶å†…å®¹</li>
                                    <li><strong>Netscapeæ ¼å¼:</strong> æ ‡å‡†çš„cookies.txtæ ¼å¼</li>
                                    <li><strong>è‡ªåŠ¨æ£€æµ‹:</strong> ç³»ç»Ÿä¼šè‡ªåŠ¨è¯†åˆ«æ ¼å¼å¹¶è½¬æ¢</li>
                                </ul>
                            </div>

                            <!-- å¯¼å…¥æ¨¡å¼é€‰æ‹© -->
                            <div class="mb-3">
                                <label class="form-label">å¯¼å…¥æ¨¡å¼</label>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="importMode" id="modeStandard" value="standard" checked>
                                            <label class="form-check-label" for="modeStandard">
                                                <strong>ğŸ”„ æ™ºèƒ½æ¨¡å¼</strong><br>
                                                <small class="text-muted">è‡ªåŠ¨å¤„ç†å¹¶æŒ‰å¹³å°åˆ†ç±»ä¿å­˜</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="importMode" id="modePreserve" value="preserve">
                                            <label class="form-check-label" for="modePreserve">
                                                <strong>ğŸ§¹ æ¸…ç†æ¨¡å¼</strong><br>
                                                <small class="text-muted">ä¿æŒåŸæ ¼å¼ï¼Œåªåˆ é™¤è¿‡æœŸcookies</small>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="importMode" id="modeRaw" value="raw">
                                            <label class="form-check-label" for="modeRaw">
                                                <strong>ğŸ“‹ ç›´æ¥å¯¼å…¥</strong><br>
                                                <small class="text-muted">å®Œå…¨ä¸ä¿®æ”¹ï¼Œç›´æ¥ä¿å­˜</small>
                                            </label>
                                        </div>
                                    </div>
                                </div>

                                <!-- æ¨¡å¼è¯´æ˜ -->
                                <div class="mt-2">
                                    <div class="alert alert-info py-2" id="modeDescription">
                                        <small>
                                            <strong>æ™ºèƒ½æ¨¡å¼</strong>ï¼šæ¨èä½¿ç”¨ã€‚è‡ªåŠ¨è¯†åˆ«cookiesæ ¼å¼ï¼Œè½¬æ¢ä¸ºæ ‡å‡†æ ¼å¼ï¼ŒæŒ‰YouTubeã€Twitterç­‰å¹³å°åˆ†ç±»ä¿å­˜ï¼Œæ¸…ç†è¿‡æœŸcookiesã€‚
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <!-- å¹³å°é€‰æ‹©ï¼ˆä»…åŸå§‹æ¨¡å¼æ˜¾ç¤ºï¼‰ -->
                            <div class="mb-3" id="platformSelection" style="display: none;">
                                <label for="targetPlatform" class="form-label">ç›®æ ‡å¹³å°</label>
                                <select class="form-select" id="targetPlatform">
                                    <option value="youtube">ğŸ“º YouTube</option>
                                    <option value="twitter">ğŸ¦ Twitter/X</option>
                                    <option value="instagram">ğŸ“· Instagram</option>
                                    <option value="tiktok">ğŸµ TikTok</option>
                                    <option value="bilibili">ğŸ“º Bilibili</option>
                                </select>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="cookiesFormat" class="form-label">Cookiesæ ¼å¼</label>
                                    <select class="form-select" id="cookiesFormat">
                                        <option value="auto">è‡ªåŠ¨æ£€æµ‹</option>
                                        <option value="json">JSONæ ¼å¼</option>
                                        <option value="netscape">Netscapeæ ¼å¼</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">å¿«é€Ÿæ“ä½œ</label>
                                    <div>
                                        <button id="clearContent" class="btn btn-outline-secondary btn-sm">
                                            <i class="fas fa-trash"></i> æ¸…ç©º
                                        </button>
                                        <button id="pasteExample" class="btn btn-outline-info btn-sm ms-2">
                                            <i class="fas fa-paste"></i> ç¤ºä¾‹
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="cookiesContent" class="form-label">Cookieså†…å®¹</label>
                                <textarea class="form-control font-monospace" id="cookiesContent" rows="12" 
                                          placeholder="ç²˜è´´æ‚¨çš„cookieså†…å®¹...

æ”¯æŒæ ¼å¼ï¼š
1. JSONæ ¼å¼ (æµè§ˆå™¨æ‰©å±•å¯¼å‡º)
2. Netscapeæ ¼å¼ (cookies.txt)

ç¤ºä¾‹ JSON æ ¼å¼ï¼š
[{&quot;domain&quot;: &quot;.youtube.com&quot;, &quot;name&quot;: &quot;SID&quot;, &quot;value&quot;: &quot;...&quot;}]

ç¤ºä¾‹ Netscape æ ¼å¼ï¼š
# Netscape HTTP Cookie File
.youtube.com	TRUE	/	FALSE	1234567890	SID	value"></textarea>
                            </div>

                            <div class="mb-3">
                                <div class="form-text">
                                    <small>
                                        <strong>ğŸ’¡ ä½¿ç”¨æç¤º</strong>ï¼š
                                        <ul class="mb-0 mt-1">
                                            <li>æ”¯æŒå¹³å°ï¼šYouTubeã€Twitter/Xã€Instagramã€TikTokã€Bilibiliç­‰</li>
                                            <li>ä¸‹è½½æ—¶ç³»ç»Ÿä¼šæ ¹æ®è§†é¢‘URLè‡ªåŠ¨é€‰æ‹©å¯¹åº”å¹³å°çš„cookies</li>
                                            <li>å¯¼å…¥å‰ä¼šè‡ªåŠ¨å¤‡ä»½ç°æœ‰cookiesï¼Œç¡®ä¿æ•°æ®å®‰å…¨</li>
                                        </ul>
                                    </small>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-8">
                                    <button id="importCookies" class="btn btn-success">
                                        <i class="fas fa-upload"></i> å¯¼å…¥Cookies
                                    </button>
                                </div>
                                <div class="col-md-4 text-end">
                                    <small class="text-muted">å¯¼å…¥å‰ä¼šè‡ªåŠ¨å¤‡ä»½ç°æœ‰cookies</small>
                                </div>
                            </div>

                            <div id="importResult" class="mt-3"></div>
                        </div>
                    </div>
                </div>

                <!-- Cookiesç®¡ç†æ ‡ç­¾é¡µ -->
                <div class="tab-pane fade" id="manage" role="tabpanel">
                    <div class="card mt-3">
                        <div class="card-header">
                            <h5><i class="fas fa-cogs"></i> Cookiesç®¡ç†</h5>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <button id="refreshCookiesList" class="btn btn-primary">
                                        <i class="fas fa-sync-alt"></i> åˆ·æ–°åˆ—è¡¨
                                    </button>
                                    <button id="testAllCookies" class="btn btn-success ms-2">
                                        <i class="fas fa-check-circle"></i> æµ‹è¯•æ‰€æœ‰å¹³å°
                                    </button>
                                </div>
                                <small class="text-muted">Cookiesæ–‡ä»¶ä¿å­˜åœ¨: /app/config/</small>
                            </div>

                            <div id="cookiesList">
                                <div class="text-center text-muted">
                                    <i class="fas fa-spinner fa-spin"></i> åŠ è½½Cookiesåˆ—è¡¨...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- è·å–æŒ‡å—æ ‡ç­¾é¡µ -->
                <div class="tab-pane fade" id="help" role="tabpanel">
                    <div class="card mt-3">
                        <div class="card-header">
                            <h5><i class="fas fa-question-circle"></i> Cookiesè·å–æŒ‡å—</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <h6><i class="fab fa-youtube"></i> YouTube Cookies</h6>
                                    <ol>
                                        <li>å®‰è£…æ‰©å±•: "Get cookies.txt LOCALLY"</li>
                                        <li>è®¿é—®å¹¶ç™»å½• <a href="https://youtube.com" target="_blank">YouTube</a></li>
                                        <li>ç‚¹å‡»æ‰©å±•å›¾æ ‡</li>
                                        <li>é€‰æ‹© "youtube.com"</li>
                                        <li>å¤åˆ¶JSONå†…å®¹åˆ°å¯¼å…¥æ¡†</li>
                                    </ol>
                                </div>
                                <div class="col-md-4">
                                    <h6><i class="fab fa-twitter"></i> Twitter/X Cookies</h6>
                                    <ol>
                                        <li>å®‰è£…æ‰©å±•: "Get cookies.txt LOCALLY"</li>
                                        <li>è®¿é—®å¹¶ç™»å½• <a href="https://x.com" target="_blank">X (Twitter)</a></li>
                                        <li>ç‚¹å‡»æ‰©å±•å›¾æ ‡</li>
                                        <li>é€‰æ‹© "x.com"</li>
                                        <li>å¤åˆ¶JSONå†…å®¹åˆ°å¯¼å…¥æ¡†</li>
                                    </ol>
                                </div>
                                <div class="col-md-4">
                                    <h6><i class="fas fa-globe"></i> å¤šå¹³å°æ™ºèƒ½ç®¡ç†</h6>
                                    <ol>
                                        <li>å¯¼å…¥ä»»æ„å¹³å°çš„cookies</li>
                                        <li>ç³»ç»ŸæŒ‰å¹³å°è‡ªåŠ¨åˆ†ç¦»åˆ°ç‹¬ç«‹æ–‡ä»¶</li>
                                        <li>ä¸‹è½½æ—¶æ ¹æ®URLæ™ºèƒ½é€‰æ‹©å¯¹åº”æ–‡ä»¶</li>
                                        <li>ä¸€æ¬¡å¯¼å…¥ï¼Œæ”¯æŒæ‰€æœ‰å¹³å°</li>
                                        <li>é¿å…å¹³å°é—´cookieså†²çª</li>
                                    </ol>
                                </div>
                            </div>

                            <div class="alert alert-warning mt-3">
                                <h6><i class="fas fa-exclamation-triangle"></i> é‡è¦æé†’</h6>
                                <ul class="mb-0">
                                    <li>ç³»ç»Ÿä¸ºæ¯ä¸ªå¹³å°ç”Ÿæˆç‹¬ç«‹cookiesæ–‡ä»¶</li>
                                    <li>ä¸‹è½½æ—¶æ ¹æ®URLæ™ºèƒ½é€‰æ‹©å¯¹åº”å¹³å°æ–‡ä»¶</li>
                                    <li>å¯¼å…¥å‰ä¼šè‡ªåŠ¨å¤‡ä»½ç°æœ‰cookies</li>
                                    <li>æ”¯æŒæ ¼å¼è‡ªåŠ¨æ£€æµ‹å’Œè½¬æ¢</li>
                                    <li>å¯¼å…¥åä¼šè‡ªåŠ¨æµ‹è¯•æœ‰æ•ˆæ€§</li>
                                    <li>å»ºè®®æ¯3ä¸ªæœˆæ›´æ–°ä¸€æ¬¡</li>
                                    <li>ä¿æŒè´¦å·æ´»è·ƒçŠ¶æ€ï¼ˆå„å¹³å°ï¼‰</li>
                                </ul>
                            </div>

                            <div class="alert alert-info">
                                <h6><i class="fas fa-shield-alt"></i> å®‰å…¨è¯´æ˜</h6>
                                <ul class="mb-0">
                                    <li>CookiesæŒ‰å¹³å°åˆ†åˆ«å­˜å‚¨åœ¨ç‹¬ç«‹æ–‡ä»¶ä¸­</li>
                                    <li>ä¸ä¼šå­˜å‚¨æ‚¨çš„å¯†ç ä¿¡æ¯</li>
                                    <li>æ‚¨å¯ä»¥éšæ—¶æ›´æ–°æˆ–åˆ é™¤cookies</li>
                                    <li>å»ºè®®ä½¿ç”¨ä¸“é—¨çš„è´¦å·è¿›è¡Œä¸‹è½½</li>
                                    <li>æ™ºèƒ½é€‰æ‹©å¯¹åº”å¹³å°cookiesï¼Œé¿å…å†²çª</li>
                                    <li>ä¾¿äºå•ç‹¬ç®¡ç†å’Œå¤‡ä»½å„å¹³å°cookies</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥çŠ¶æ€
    checkCookiesStatus();
    loadCookiesList();

    // åˆ·æ–°çŠ¶æ€æŒ‰é’®
    document.getElementById('refreshStatus').addEventListener('click', function() {
        checkCookiesStatus();
        loadCookiesList();
    });



    // å¯¼å…¥ç›¸å…³æŒ‰é’®
    document.getElementById('importCookies').addEventListener('click', importCookies);

    // ç»‘å®šå¯¼å…¥æ¨¡å¼åˆ‡æ¢äº‹ä»¶
    document.querySelectorAll('input[name="importMode"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const platformSelection = document.getElementById('platformSelection');
            const modeDescription = document.getElementById('modeDescription');

            // æ˜¾ç¤º/éšè—å¹³å°é€‰æ‹©
            if (this.value === 'raw') {
                platformSelection.style.display = 'block';
            } else {
                platformSelection.style.display = 'none';
            }

            // æ›´æ–°æ¨¡å¼è¯´æ˜
            let description = '';
            switch(this.value) {
                case 'standard':
                    description = '<strong>æ™ºèƒ½æ¨¡å¼</strong>ï¼šæ¨èä½¿ç”¨ã€‚è‡ªåŠ¨è¯†åˆ«cookiesæ ¼å¼ï¼Œè½¬æ¢ä¸ºæ ‡å‡†æ ¼å¼ï¼ŒæŒ‰YouTubeã€Twitterç­‰å¹³å°åˆ†ç±»ä¿å­˜ï¼Œæ¸…ç†è¿‡æœŸcookiesã€‚';
                    break;
                case 'preserve':
                    description = '<strong>æ¸…ç†æ¨¡å¼</strong>ï¼šä¿æŒcookiesçš„åŸå§‹æ ¼å¼ä¸å˜ï¼Œåªåˆ é™¤å·²è¿‡æœŸçš„cookiesï¼Œé€‚åˆå·²ç»æ˜¯æ­£ç¡®æ ¼å¼çš„cookiesæ–‡ä»¶ã€‚';
                    break;
                case 'raw':
                    description = '<strong>ç›´æ¥å¯¼å…¥</strong>ï¼šå®Œå…¨ä¸ä¿®æ”¹cookieså†…å®¹ï¼Œç›´æ¥ä¿å­˜åˆ°æŒ‡å®šå¹³å°æ–‡ä»¶ã€‚é€‚åˆé«˜çº§ç”¨æˆ·æˆ–ç‰¹æ®Šæ ¼å¼çš„cookiesã€‚';
                    break;
            }
            modeDescription.innerHTML = `<small>${description}</small>`;
        });
    });

    // Cookiesç®¡ç†ç›¸å…³æŒ‰é’®
    document.getElementById('refreshPlatforms').addEventListener('click', loadCookiesList);
    document.getElementById('refreshCookiesList').addEventListener('click', loadCookiesList);
    document.getElementById('testAllCookies').addEventListener('click', testAllPlatformCookies);

    // å¿«é€Ÿæ“ä½œæŒ‰é’®
    document.getElementById('clearContent').addEventListener('click', function() {
        document.getElementById('cookiesContent').value = '';
        showInfo('å·²æ¸…ç©ºå†…å®¹');
    });

    document.getElementById('pasteExample').addEventListener('click', function() {
        const exampleContent = `[
    {
        "domain": ".youtube.com",
        "name": "SID",
        "value": "your_sid_value_here",
        "path": "/",
        "expires": 1735689600,
        "httpOnly": false,
        "secure": true
    },
    {
        "domain": ".youtube.com",
        "name": "HSID",
        "value": "your_hsid_value_here",
        "path": "/",
        "expires": 1735689600,
        "httpOnly": false,
        "secure": true
    }
]`;
        document.getElementById('cookiesContent').value = exampleContent;
        showInfo('å·²ç²˜è´´ç¤ºä¾‹å†…å®¹ï¼Œè¯·æ›¿æ¢ä¸ºæ‚¨çš„å®é™…cookies');
    });

    // æ£€æŸ¥cookiesçŠ¶æ€
    function checkCookiesStatus() {
        fetch('/api/cookies/status', {
            credentials: 'same-origin'  // ä½¿ç”¨cookiesè®¤è¯
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateStatusDisplay(data);
            } else {
                showError('æ£€æŸ¥çŠ¶æ€å¤±è´¥: ' + data.error);
            }
        })
        .catch(error => {
            showError('æ£€æŸ¥çŠ¶æ€å¤±è´¥: ' + error.message);
        });
    }

    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
    function updateStatusDisplay(status) {
        const statusBadge = document.getElementById('cookiesStatusBadge');
        const statusText = document.getElementById('cookiesStatusText');

        let badgeClass = 'bg-secondary';
        let statusMessage = 'æœªçŸ¥çŠ¶æ€';

        if (status.exists) {
            switch (status.status) {
                case 'good':
                    badgeClass = 'bg-success';
                    statusMessage = 'çŠ¶æ€è‰¯å¥½';
                    break;
                case 'warning':
                    badgeClass = 'bg-warning';
                    statusMessage = 'éœ€è¦å…³æ³¨';
                    break;
                case 'expired':
                    badgeClass = 'bg-danger';
                    statusMessage = 'å¯èƒ½è¿‡æœŸ';
                    break;
                case 'incomplete':
                    badgeClass = 'bg-warning';
                    statusMessage = 'å†…å®¹ä¸å®Œæ•´';
                    break;
            }
        } else {
            badgeClass = 'bg-danger';
            statusMessage = 'ä¸å­˜åœ¨';
        }

        statusBadge.innerHTML = `<span class="badge ${badgeClass}">${statusMessage}</span>`;

        // æ„å»ºçŠ¶æ€æ–‡æœ¬ï¼ŒåŒ…å«å¹³å°ä¿¡æ¯
        let statusTextContent = status.message || 'æ— è¯¦ç»†ä¿¡æ¯';

        // æ·»åŠ å¹³å°ä¿¡æ¯
        if (status.platform_analysis && Object.keys(status.platform_analysis).length > 0) {
            const platforms = Object.keys(status.platform_analysis);
            const platformBadges = platforms.map(platform => {
                const analysis = status.platform_analysis[platform];
                const badgeClass = analysis.has_auth ? 'bg-success' : 'bg-warning';
                const icon = getPlatformIcon(platform);
                const completeness = Math.round(analysis.completeness * 100);
                return `<span class="badge ${badgeClass} me-1" title="${platform}: ${completeness}% å®Œæ•´åº¦">${icon} ${platform}</span>`;
            }).join('');
            statusTextContent += `<br><small>æ”¯æŒå¹³å°: ${platformBadges}</small>`;
        }

        statusText.innerHTML = statusTextContent;
    }

    // è·å–å¹³å°å›¾æ ‡
    function getPlatformIcon(platform) {
        const icons = {
            'youtube': 'ğŸ“º',
            'twitter': 'ğŸ¦',
            'instagram': 'ğŸ“·',
            'tiktok': 'ğŸµ',
            'bilibili': 'ğŸ“º'
        };
        return icons[platform] || 'ğŸŒ';
    }















    // å¯¼å…¥cookies
    function importCookies() {
        const content = document.getElementById('cookiesContent').value.trim();

        if (!content) {
            showError('è¯·å…ˆè¾“å…¥cookieså†…å®¹');
            return;
        }

        // è·å–å¯¼å…¥æ¨¡å¼
        const importMode = document.querySelector('input[name="importMode"]:checked').value;
        const platform = document.getElementById('targetPlatform').value;

        const btn = document.getElementById('importCookies');
        btn.disabled = true;

        // æ ¹æ®æ¨¡å¼æ˜¾ç¤ºä¸åŒçš„çŠ¶æ€
        let statusText = '';
        switch(importMode) {
            case 'raw':
                statusText = `å¯¼å…¥ä¸­ (åŸå§‹æ¨¡å¼ - ${platform})`;
                break;
            case 'preserve':
                statusText = 'å¯¼å…¥ä¸­ (ä¿æŒæ ¼å¼æ¨¡å¼)';
                break;
            default:
                statusText = 'å¯¼å…¥ä¸­ (æ ‡å‡†æ¨¡å¼)';
        }
        btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${statusText}`;

        fetch('/api/cookies/import', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'same-origin',  // ä½¿ç”¨cookiesè®¤è¯
            body: JSON.stringify({
                cookies_content: content,
                format: 'auto',
                import_mode: importMode,
                platform: platform
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                let message = `Cookieså¯¼å…¥æˆåŠŸï¼(${data.import_mode || importMode}æ¨¡å¼)`;
                if (data.found_cookies && data.found_cookies.length > 0) {
                    message += ` æ‰¾åˆ° ${data.found_cookies.length} ä¸ªé‡è¦cookies`;
                }
                if (data.cookie_count) {
                    message += ` å…± ${data.cookie_count} è¡Œ`;
                }
                showSuccess(message);
                document.getElementById('cookiesContent').value = '';
                checkCookiesStatus(); // åˆ·æ–°çŠ¶æ€
                loadCookiesList(); // åˆ·æ–°åˆ—è¡¨

                // æ˜¾ç¤ºæµ‹è¯•ç»“æœ
                if (data.test_result) {
                    if (data.test_result.valid) {
                        showSuccess('å¯¼å…¥çš„cookiesæµ‹è¯•é€šè¿‡ï¼Œå¯ä»¥æ­£å¸¸ä½¿ç”¨');
                    } else {
                        showWarning('å¯¼å…¥æˆåŠŸä½†æµ‹è¯•å¤±è´¥ï¼Œå¯èƒ½éœ€è¦é‡æ–°è·å–cookies');
                    }
                }
            } else {
                showError('å¯¼å…¥å¤±è´¥: ' + data.error);
            }
        })
        .catch(error => {
            showError('å¯¼å…¥å¤±è´¥: ' + error.message);
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-upload"></i> å¯¼å…¥Cookies';
        });
    }



    // åŠ è½½cookiesåˆ—è¡¨
    function loadCookiesList() {
        fetch('/api/cookies/list', {
            credentials: 'same-origin'  // ä½¿ç”¨cookiesè®¤è¯
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayCookiesList(data.cookies_files);
                document.getElementById('platformCount').innerHTML =
                    `<span class="badge bg-success">${data.cookies_files.length}</span>`;
            } else {
                showError('åŠ è½½Cookiesåˆ—è¡¨å¤±è´¥: ' + data.error);
            }
        })
        .catch(error => {
            showError('åŠ è½½Cookiesåˆ—è¡¨å¤±è´¥: ' + error.message);
        });
    }

    // æ˜¾ç¤ºcookiesåˆ—è¡¨
    function displayCookiesList(cookiesFiles) {
        const container = document.getElementById('cookiesList');

        if (cookiesFiles.length === 0) {
            container.innerHTML = '<div class="text-center text-muted">æš‚æ— å¯¼å…¥çš„Cookiesæ–‡ä»¶</div>';
            return;
        }

        let html = '<div class="table-responsive"><table class="table table-hover">';
        html += '<thead><tr><th>å¹³å°</th><th>ä¿®æ”¹æ—¶é—´</th><th>Cookiesæ•°é‡</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead><tbody>';

        cookiesFiles.forEach(file => {
            const statusBadge = file.has_auth ?
                '<span class="badge bg-success">æœ‰è®¤è¯</span>' :
                '<span class="badge bg-warning">æ— è®¤è¯</span>';

            const expiredInfo = file.expired_cookies > 0 ?
                `<small class="text-danger">(${file.expired_cookies}ä¸ªå·²è¿‡æœŸ)</small>` : '';

            html += `
                <tr>
                    <td>
                        <strong>${file.platform}</strong><br>
                        <small class="text-muted">${file.file_name}</small>
                    </td>
                    <td>${file.modified_date}</td>
                    <td>
                        ${file.cookies_count} ä¸ª
                        ${expiredInfo}
                    </td>
                    <td>${statusBadge}</td>
                    <td>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-info" onclick="inspectPlatformCookies('${file.platform}')" title="æ£€æŸ¥è¯¦æƒ…">
                                <i class="fas fa-search"></i> æ£€æŸ¥
                            </button>
                            <button class="btn btn-sm btn-outline-success" onclick="testPlatformCookies('${file.platform}')" title="æµ‹è¯•æœ‰æ•ˆæ€§">
                                <i class="fas fa-check"></i> æµ‹è¯•
                            </button>
                            <button class="btn btn-sm btn-outline-warning" onclick="cleanPlatformCookies('${file.platform}')" title="æ¸…ç†è¿‡æœŸcookies">
                                <i class="fas fa-broom"></i> æ¸…ç†
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deletePlatformCookies('${file.platform}')">
                                <i class="fas fa-trash"></i> åˆ é™¤
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        });

        html += '</tbody></table></div>';
        container.innerHTML = html;
    }





    // æ£€æŸ¥å¹³å°cookies
    window.inspectPlatformCookies = function(platform) {
        fetch('/api/cookies/inspect', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'same-origin',
            body: JSON.stringify({
                platform: platform
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showPlatformInspectionModal(data);
            } else {
                showError('æ£€æŸ¥å¤±è´¥: ' + data.error);
            }
        })
        .catch(error => {
            showError('æ£€æŸ¥å¤±è´¥: ' + error.message);
        });
    };

    // æµ‹è¯•å¹³å°cookies
    window.testPlatformCookies = function(platform) {
        showInfo(`æ­£åœ¨æµ‹è¯• ${platform} å¹³å°cookies...`);

        fetch('/api/cookies/test', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'same-origin',
            body: JSON.stringify({
                platform: platform
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.valid) {
                    showSuccess(`âœ… ${platform} å¹³å°cookiesæœ‰æ•ˆ: ${data.message}`);
                } else {
                    showError(`âŒ ${platform} å¹³å°cookiesæ— æ•ˆ: ${data.message || data.error}`);
                }
            } else {
                showError(`âŒ ${platform} å¹³å°æµ‹è¯•å¤±è´¥: ${data.error}`);
            }
        })
        .catch(error => {
            showError(`âŒ ${platform} å¹³å°æµ‹è¯•å¤±è´¥: ${error.message}`);
        });
    };

    // æ¸…ç†å¹³å°cookies
    window.cleanPlatformCookies = function(platform) {
        if (!confirm(`ç¡®å®šè¦æ¸…ç† ${platform} å¹³å°çš„è¿‡æœŸcookieså—ï¼Ÿ\n\nè¿™å°†åˆ é™¤è¿‡æœŸcookieså¹¶ä¿®å¤ä¼šè¯cookiesã€‚`)) {
            return;
        }

        fetch('/api/cookies/clean', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'same-origin',
            body: JSON.stringify({
                platform: platform
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccess(`âœ… ${platform} å¹³å°cookiesæ¸…ç†æˆåŠŸ`);
                loadCookiesList(); // åˆ·æ–°åˆ—è¡¨
                checkCookiesStatus(); // åˆ·æ–°çŠ¶æ€
            } else {
                showError('æ¸…ç†å¤±è´¥: ' + data.error);
            }
        })
        .catch(error => {
            showError('æ¸…ç†å¤±è´¥: ' + error.message);
        });
    };

    // åˆ é™¤å¹³å°cookies
    window.deletePlatformCookies = function(platform) {
        if (!confirm(`ç¡®å®šè¦åˆ é™¤ ${platform} å¹³å°çš„cookiesæ–‡ä»¶å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
            return;
        }

        fetch('/api/cookies/delete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            credentials: 'same-origin',
            body: JSON.stringify({
                platform: platform
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccess(`âœ… ${platform} å¹³å°cookieså·²åˆ é™¤`);
                loadCookiesList(); // åˆ·æ–°åˆ—è¡¨
                checkCookiesStatus(); // åˆ·æ–°çŠ¶æ€
            } else {
                showError('åˆ é™¤å¤±è´¥: ' + data.error);
            }
        })
        .catch(error => {
            showError('åˆ é™¤å¤±è´¥: ' + error.message);
        });
    };

    // æµ‹è¯•æ‰€æœ‰å¹³å°cookies
    function testAllPlatformCookies() {
        showInfo('æ­£åœ¨æµ‹è¯•æ‰€æœ‰å¹³å°cookies...');

        fetch('/api/cookies/test', {
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                let message = 'ğŸ§ª æ‰€æœ‰å¹³å°æµ‹è¯•å®Œæˆ:\n\n';

                if (data.platform_results) {
                    Object.entries(data.platform_results).forEach(([platform, result]) => {
                        const status = result.valid ? 'âœ…' : 'âŒ';
                        message += `${status} ${platform}: ${result.message}\n`;
                    });
                } else {
                    message += data.valid ? 'âœ… æµ‹è¯•é€šè¿‡' : 'âŒ æµ‹è¯•å¤±è´¥';
                    message += `\næ¶ˆæ¯: ${data.message}`;
                }

                showInfo(message);
            } else {
                showError('æµ‹è¯•å¤±è´¥: ' + data.error);
            }
        })
        .catch(error => {
            showError('æµ‹è¯•å¤±è´¥: ' + error.message);
        });
    }

    // æ˜¾ç¤ºå¹³å°æ£€æŸ¥ç»“æœ
    function showPlatformInspectionModal(data) {
        let inspectionInfo = `ğŸ” **${data.platform} å¹³å°Cookiesæ£€æŸ¥æŠ¥å‘Š**\n\n`;

        inspectionInfo += `ğŸ“ **æ–‡ä»¶ä¿¡æ¯:**\n`;
        inspectionInfo += `- å¹³å°: ${data.platform}\n`;
        inspectionInfo += `- æ–‡ä»¶å¤§å°: ${(data.file_size / 1024).toFixed(1)} KB\n`;
        inspectionInfo += `- æ€»è¡Œæ•°: ${data.total_lines}\n`;
        inspectionInfo += `- æœ‰æ•ˆè¡Œæ•°: ${data.valid_lines}\n`;

        if (data.analysis) {
            inspectionInfo += `\nğŸ“Š **Cookiesåˆ†æ:**\n`;
            inspectionInfo += `- æ€»æ•°é‡: ${data.analysis.total_cookies}\n`;
            inspectionInfo += `- æœ‰æ•ˆ: ${data.analysis.valid_cookies}\n`;
            inspectionInfo += `- è¿‡æœŸ: ${data.analysis.expired_cookies}\n`;
            inspectionInfo += `- çŠ¶æ€: ${data.analysis.overall_status}\n`;
        }

        if (data.cookies_details && data.cookies_details.length > 0) {
            inspectionInfo += `\nğŸª **é‡è¦Cookiesè¯¦æƒ…:**\n`;
            data.cookies_details.slice(0, 10).forEach(cookie => {
                const status = cookie.is_expired ? 'âŒ' : 'âœ…';
                const important = cookie.is_important ? 'â­' : '';
                inspectionInfo += `${status}${important} ${cookie.name}: ${cookie.domain}\n`;
            });

            if (data.cookies_details.length > 10) {
                inspectionInfo += `... è¿˜æœ‰ ${data.cookies_details.length - 10} ä¸ªcookies\n`;
            }
        }

        // åˆ›å»ºæ£€æŸ¥ç»“æœæ¨¡æ€æ¡†
        const modalHtml = `
            <div class="modal fade" id="platformInspectionModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">ğŸ” ${data.platform} å¹³å°Cookiesæ£€æŸ¥</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <pre style="white-space: pre-wrap; font-family: monospace; background: #f8f9fa; padding: 15px; border-radius: 5px; max-height: 400px; overflow-y: auto;">${inspectionInfo}</pre>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                            <button type="button" class="btn btn-success" onclick="testPlatformCookies('${data.platform}')">æµ‹è¯•æ­¤å¹³å°</button>
                            <button type="button" class="btn btn-primary" onclick="copyPlatformInspectionInfo()">å¤åˆ¶æŠ¥å‘Š</button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // ç§»é™¤æ—§çš„æ¨¡æ€æ¡†
        const oldModal = document.getElementById('platformInspectionModal');
        if (oldModal) {
            oldModal.remove();
        }

        // æ·»åŠ æ–°çš„æ¨¡æ€æ¡†
        document.body.insertAdjacentHTML('beforeend', modalHtml);

        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        const modal = new bootstrap.Modal(document.getElementById('platformInspectionModal'));
        modal.show();

        // å­˜å‚¨æ£€æŸ¥ä¿¡æ¯ä¾›å¤åˆ¶ä½¿ç”¨
        window.currentPlatformInspectionInfo = inspectionInfo;
    }

    // å¤åˆ¶å¹³å°æ£€æŸ¥ä¿¡æ¯
    window.copyPlatformInspectionInfo = function() {
        if (window.currentPlatformInspectionInfo) {
            navigator.clipboard.writeText(window.currentPlatformInspectionInfo).then(() => {
                showSuccess('æ£€æŸ¥æŠ¥å‘Šå·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            }).catch(() => {
                showWarning('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©æ–‡æœ¬å¤åˆ¶');
            });
        }
    };



    // æ¶ˆæ¯æ˜¾ç¤ºå‡½æ•°
    function showSuccess(message) {
        showMessage(message, 'success');
    }

    function showError(message) {
        showMessage(message, 'danger');
    }

    function showWarning(message) {
        showMessage(message, 'warning');
    }

    function showInfo(message) {
        showMessage(message, 'info');
    }

    function showMessage(message, type) {
        const result = document.getElementById('importResult');
        result.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>`;
    }
});
</script>
{% endblock %}
