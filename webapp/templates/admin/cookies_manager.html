{% extends "base.html" %}

{% block title %}Cookiesç®¡ç† - ç®¡ç†å‘˜{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>ğŸª YouTube Cookiesç®¡ç†</h2>
                <div>
                    <button id="refreshStatus" class="btn btn-outline-primary">
                        <i class="fas fa-sync-alt"></i> åˆ·æ–°çŠ¶æ€
                    </button>
                    <a href="/admin" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> è¿”å›ç®¡ç†
                    </a>
                </div>
            </div>

            <!-- çŠ¶æ€å¡ç‰‡ -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card border-primary">
                        <div class="card-body text-center">
                            <h5 class="card-title">CookiesçŠ¶æ€</h5>
                            <div id="cookiesStatusBadge" class="mb-2">
                                <span class="badge bg-secondary">æ£€æŸ¥ä¸­...</span>
                            </div>
                            <p id="cookiesStatusText" class="card-text text-muted">æ­£åœ¨æ£€æŸ¥çŠ¶æ€...</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card border-info">
                        <div class="card-body text-center">
                            <h5 class="card-title">æœ‰æ•ˆæ€§æµ‹è¯•</h5>
                            <div id="validityBadge" class="mb-2">
                                <span class="badge bg-secondary">æœªæµ‹è¯•</span>
                            </div>
                            <button id="testCookies" class="btn btn-sm btn-info">
                                <i class="fas fa-vial"></i> æµ‹è¯•
                            </button>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card border-success">
                        <div class="card-body text-center">
                            <h5 class="card-title">å¤‡ä»½æ•°é‡</h5>
                            <div id="backupCount" class="mb-2">
                                <span class="badge bg-secondary">0</span>
                            </div>
                            <button id="refreshBackups" class="btn btn-sm btn-success">
                                <i class="fas fa-list"></i> æŸ¥çœ‹
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ä¸»è¦åŠŸèƒ½æ ‡ç­¾é¡µ -->
            <ul class="nav nav-tabs" id="cookiesTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="import-tab" data-bs-toggle="tab" data-bs-target="#import" type="button">
                        <i class="fas fa-upload"></i> å¯¼å…¥Cookies
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="backup-tab" data-bs-toggle="tab" data-bs-target="#backup" type="button">
                        <i class="fas fa-archive"></i> å¤‡ä»½ç®¡ç†
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="help-tab" data-bs-toggle="tab" data-bs-target="#help" type="button">
                        <i class="fas fa-question-circle"></i> è·å–æŒ‡å—
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="cookiesTabContent">
                <!-- å¯¼å…¥Cookiesæ ‡ç­¾é¡µ -->
                <div class="tab-pane fade show active" id="import" role="tabpanel">
                    <div class="card mt-3">
                        <div class="card-header">
                            <h5><i class="fas fa-upload"></i> å¯¼å…¥æ–°çš„Cookies</h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-info">
                                <h6><i class="fas fa-info-circle"></i> æ”¯æŒçš„æ ¼å¼:</h6>
                                <ul class="mb-0">
                                    <li><strong>JSONæ ¼å¼:</strong> æµè§ˆå™¨æ‰©å±•å¯¼å‡ºçš„JSONæ–‡ä»¶å†…å®¹</li>
                                    <li><strong>Netscapeæ ¼å¼:</strong> æ ‡å‡†çš„cookies.txtæ ¼å¼</li>
                                    <li><strong>è‡ªåŠ¨æ£€æµ‹:</strong> ç³»ç»Ÿä¼šè‡ªåŠ¨è¯†åˆ«æ ¼å¼å¹¶è½¬æ¢</li>
                                </ul>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="cookiesFormat" class="form-label">Cookiesæ ¼å¼</label>
                                    <select class="form-select" id="cookiesFormat">
                                        <option value="auto">è‡ªåŠ¨æ£€æµ‹</option>
                                        <option value="json">JSONæ ¼å¼</option>
                                        <option value="netscape">Netscapeæ ¼å¼</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">å¿«é€Ÿæ“ä½œ</label>
                                    <div>
                                        <button id="clearContent" class="btn btn-outline-secondary btn-sm">
                                            <i class="fas fa-trash"></i> æ¸…ç©º
                                        </button>
                                        <button id="pasteExample" class="btn btn-outline-info btn-sm ms-2">
                                            <i class="fas fa-paste"></i> ç¤ºä¾‹
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="cookiesContent" class="form-label">Cookieså†…å®¹</label>
                                <textarea class="form-control font-monospace" id="cookiesContent" rows="12" 
                                          placeholder="ç²˜è´´æ‚¨çš„cookieså†…å®¹...

æ”¯æŒæ ¼å¼ï¼š
1. JSONæ ¼å¼ (æµè§ˆå™¨æ‰©å±•å¯¼å‡º)
2. Netscapeæ ¼å¼ (cookies.txt)

ç¤ºä¾‹ JSON æ ¼å¼ï¼š
[{&quot;domain&quot;: &quot;.youtube.com&quot;, &quot;name&quot;: &quot;SID&quot;, &quot;value&quot;: &quot;...&quot;}]

ç¤ºä¾‹ Netscape æ ¼å¼ï¼š
# Netscape HTTP Cookie File
.youtube.com	TRUE	/	FALSE	1234567890	SID	value"></textarea>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <button id="validateCookies" class="btn btn-outline-primary">
                                        <i class="fas fa-check"></i> éªŒè¯æ ¼å¼
                                    </button>
                                    <button id="importCookies" class="btn btn-success ms-2">
                                        <i class="fas fa-upload"></i> å¯¼å…¥Cookies
                                    </button>
                                </div>
                                <div class="col-md-6 text-end">
                                    <small class="text-muted">å¯¼å…¥å‰ä¼šè‡ªåŠ¨å¤‡ä»½ç°æœ‰cookies</small>
                                </div>
                            </div>

                            <div id="importResult" class="mt-3"></div>
                        </div>
                    </div>
                </div>

                <!-- å¤‡ä»½ç®¡ç†æ ‡ç­¾é¡µ -->
                <div class="tab-pane fade" id="backup" role="tabpanel">
                    <div class="card mt-3">
                        <div class="card-header">
                            <h5><i class="fas fa-archive"></i> Cookieså¤‡ä»½ç®¡ç†</h5>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <div>
                                    <button id="refreshBackupsList" class="btn btn-primary">
                                        <i class="fas fa-sync-alt"></i> åˆ·æ–°åˆ—è¡¨
                                    </button>
                                </div>
                                <small class="text-muted">å¤‡ä»½æ–‡ä»¶ä¿å­˜åœ¨: /app/config/</small>
                            </div>

                            <div id="backupsList">
                                <div class="text-center text-muted">
                                    <i class="fas fa-spinner fa-spin"></i> åŠ è½½å¤‡ä»½åˆ—è¡¨...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- è·å–æŒ‡å—æ ‡ç­¾é¡µ -->
                <div class="tab-pane fade" id="help" role="tabpanel">
                    <div class="card mt-3">
                        <div class="card-header">
                            <h5><i class="fas fa-question-circle"></i> Cookiesè·å–æŒ‡å—</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6><i class="fas fa-chrome"></i> Chromeæµè§ˆå™¨</h6>
                                    <ol>
                                        <li>å®‰è£…æ‰©å±•: "Get cookies.txt LOCALLY"</li>
                                        <li>è®¿é—®å¹¶ç™»å½• <a href="https://youtube.com" target="_blank">YouTube</a></li>
                                        <li>ç‚¹å‡»æ‰©å±•å›¾æ ‡</li>
                                        <li>é€‰æ‹© "youtube.com"</li>
                                        <li>å¤åˆ¶JSONå†…å®¹åˆ°å¯¼å…¥æ¡†</li>
                                    </ol>
                                </div>
                                <div class="col-md-6">
                                    <h6><i class="fas fa-firefox-browser"></i> Firefoxæµè§ˆå™¨</h6>
                                    <ol>
                                        <li>å®‰è£…æ‰©å±•: "cookies.txt"</li>
                                        <li>è®¿é—®å¹¶ç™»å½• <a href="https://youtube.com" target="_blank">YouTube</a></li>
                                        <li>å³é”®ç‚¹å‡»é¡µé¢ â†’ "Export cookies"</li>
                                        <li>ä¿å­˜ä¸º cookies.txt</li>
                                        <li>å¤åˆ¶å†…å®¹åˆ°å¯¼å…¥æ¡†</li>
                                    </ol>
                                </div>
                            </div>

                            <div class="alert alert-warning mt-3">
                                <h6><i class="fas fa-exclamation-triangle"></i> é‡è¦æé†’</h6>
                                <ul class="mb-0">
                                    <li>å¯¼å…¥å‰ä¼šè‡ªåŠ¨å¤‡ä»½ç°æœ‰cookies</li>
                                    <li>æ”¯æŒæ ¼å¼è‡ªåŠ¨æ£€æµ‹å’Œè½¬æ¢</li>
                                    <li>å¯¼å…¥åä¼šè‡ªåŠ¨æµ‹è¯•æœ‰æ•ˆæ€§</li>
                                    <li>å»ºè®®æ¯3ä¸ªæœˆæ›´æ–°ä¸€æ¬¡</li>
                                    <li>ä¿æŒYouTubeè´¦å·æ´»è·ƒçŠ¶æ€</li>
                                </ul>
                            </div>

                            <div class="alert alert-info">
                                <h6><i class="fas fa-shield-alt"></i> å®‰å…¨è¯´æ˜</h6>
                                <ul class="mb-0">
                                    <li>Cookiesä»…ç”¨äºYouTubeè§†é¢‘ä¸‹è½½</li>
                                    <li>ä¸ä¼šå­˜å‚¨æ‚¨çš„å¯†ç ä¿¡æ¯</li>
                                    <li>æ‚¨å¯ä»¥éšæ—¶æ›´æ–°æˆ–åˆ é™¤cookies</li>
                                    <li>å»ºè®®ä½¿ç”¨ä¸“é—¨çš„YouTubeè´¦å·</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥çŠ¶æ€
    checkCookiesStatus();
    loadBackupsList();

    // åˆ·æ–°çŠ¶æ€æŒ‰é’®
    document.getElementById('refreshStatus').addEventListener('click', function() {
        checkCookiesStatus();
        loadBackupsList();
    });

    // æµ‹è¯•cookiesæŒ‰é’®
    document.getElementById('testCookies').addEventListener('click', testCookiesValidity);

    // å¯¼å…¥ç›¸å…³æŒ‰é’®
    document.getElementById('validateCookies').addEventListener('click', validateCookiesFormat);
    document.getElementById('importCookies').addEventListener('click', importCookies);
    document.getElementById('clearContent').addEventListener('click', () => {
        document.getElementById('cookiesContent').value = '';
    });
    document.getElementById('pasteExample').addEventListener('click', pasteExample);

    // å¤‡ä»½ç›¸å…³æŒ‰é’®
    document.getElementById('refreshBackups').addEventListener('click', loadBackupsList);
    document.getElementById('refreshBackupsList').addEventListener('click', loadBackupsList);

    // æ£€æŸ¥cookiesçŠ¶æ€
    function checkCookiesStatus() {
        fetch('/api/cookies/status', {
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('token')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateStatusDisplay(data);
            } else {
                showError('æ£€æŸ¥çŠ¶æ€å¤±è´¥: ' + data.error);
            }
        })
        .catch(error => {
            showError('æ£€æŸ¥çŠ¶æ€å¤±è´¥: ' + error.message);
        });
    }

    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
    function updateStatusDisplay(status) {
        const statusBadge = document.getElementById('cookiesStatusBadge');
        const statusText = document.getElementById('cookiesStatusText');

        let badgeClass = 'bg-secondary';
        let statusMessage = 'æœªçŸ¥çŠ¶æ€';

        if (status.exists) {
            switch (status.status) {
                case 'good':
                    badgeClass = 'bg-success';
                    statusMessage = 'çŠ¶æ€è‰¯å¥½';
                    break;
                case 'warning':
                    badgeClass = 'bg-warning';
                    statusMessage = 'éœ€è¦å…³æ³¨';
                    break;
                case 'expired':
                    badgeClass = 'bg-danger';
                    statusMessage = 'å¯èƒ½è¿‡æœŸ';
                    break;
                case 'incomplete':
                    badgeClass = 'bg-warning';
                    statusMessage = 'å†…å®¹ä¸å®Œæ•´';
                    break;
            }
        } else {
            badgeClass = 'bg-danger';
            statusMessage = 'ä¸å­˜åœ¨';
        }

        statusBadge.innerHTML = `<span class="badge ${badgeClass}">${statusMessage}</span>`;
        statusText.textContent = status.message || 'æ— è¯¦ç»†ä¿¡æ¯';
    }

    // æµ‹è¯•cookiesæœ‰æ•ˆæ€§
    function testCookiesValidity() {
        const btn = document.getElementById('testCookies');
        const badge = document.getElementById('validityBadge');

        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æµ‹è¯•ä¸­';
        badge.innerHTML = '<span class="badge bg-secondary">æµ‹è¯•ä¸­...</span>';

        fetch('/api/cookies/test', {
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('token')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.valid) {
                    badge.innerHTML = '<span class="badge bg-success">æœ‰æ•ˆ</span>';
                    showSuccess('Cookiesæµ‹è¯•é€šè¿‡ï¼Œå¯ä»¥æ­£å¸¸ä¸‹è½½YouTubeè§†é¢‘');
                } else {
                    badge.innerHTML = '<span class="badge bg-danger">æ— æ•ˆ</span>';
                    showError('Cookiesæµ‹è¯•å¤±è´¥: ' + (data.message || data.error));
                }
            } else {
                badge.innerHTML = '<span class="badge bg-danger">é”™è¯¯</span>';
                showError('æµ‹è¯•å¤±è´¥: ' + data.error);
            }
        })
        .catch(error => {
            badge.innerHTML = '<span class="badge bg-danger">é”™è¯¯</span>';
            showError('æµ‹è¯•å¤±è´¥: ' + error.message);
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-vial"></i> æµ‹è¯•';
        });
    }

    // éªŒè¯cookiesæ ¼å¼
    function validateCookiesFormat() {
        const content = document.getElementById('cookiesContent').value.trim();
        if (!content) {
            showError('è¯·å…ˆè¾“å…¥cookieså†…å®¹');
            return;
        }

        try {
            // å°è¯•è§£æJSON
            JSON.parse(content);
            showSuccess('æ£€æµ‹åˆ°æœ‰æ•ˆçš„JSONæ ¼å¼');
        } catch (e) {
            // æ£€æŸ¥Netscapeæ ¼å¼
            if (content.includes('# Netscape HTTP Cookie File') || 
                (content.includes('\t') && content.includes('youtube.com'))) {
                showSuccess('æ£€æµ‹åˆ°Netscapeæ ¼å¼');
            } else {
                showWarning('æ ¼å¼å¯èƒ½ä¸æ­£ç¡®ï¼Œè¯·æ£€æŸ¥å†…å®¹');
            }
        }
    }

    // å¯¼å…¥cookies
    function importCookies() {
        const content = document.getElementById('cookiesContent').value.trim();
        const format = document.getElementById('cookiesFormat').value;

        if (!content) {
            showError('è¯·å…ˆè¾“å…¥cookieså†…å®¹');
            return;
        }

        const btn = document.getElementById('importCookies');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> å¯¼å…¥ä¸­';

        fetch('/api/cookies/import', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + localStorage.getItem('token')
            },
            body: JSON.stringify({
                cookies_content: content,
                format: format
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccess('Cookieså¯¼å…¥æˆåŠŸï¼æ‰¾åˆ° ' + data.found_cookies.length + ' ä¸ªé‡è¦cookies');
                document.getElementById('cookiesContent').value = '';
                checkCookiesStatus(); // åˆ·æ–°çŠ¶æ€
                
                // æ˜¾ç¤ºæµ‹è¯•ç»“æœ
                if (data.test_result) {
                    if (data.test_result.valid) {
                        showSuccess('å¯¼å…¥çš„cookiesæµ‹è¯•é€šè¿‡ï¼Œå¯ä»¥æ­£å¸¸ä½¿ç”¨');
                    } else {
                        showWarning('å¯¼å…¥æˆåŠŸä½†æµ‹è¯•å¤±è´¥ï¼Œå¯èƒ½éœ€è¦é‡æ–°è·å–cookies');
                    }
                }
            } else {
                showError('å¯¼å…¥å¤±è´¥: ' + data.error);
            }
        })
        .catch(error => {
            showError('å¯¼å…¥å¤±è´¥: ' + error.message);
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-upload"></i> å¯¼å…¥Cookies';
        });
    }

    // ç²˜è´´ç¤ºä¾‹
    function pasteExample() {
        const example = `[
    {
        "domain": ".youtube.com",
        "name": "SID",
        "value": "your_sid_value_here",
        "path": "/",
        "secure": false,
        "expirationDate": 1767225600
    },
    {
        "domain": ".youtube.com", 
        "name": "HSID",
        "value": "your_hsid_value_here",
        "path": "/",
        "secure": false,
        "expirationDate": 1767225600
    }
]`;
        document.getElementById('cookiesContent').value = example;
        showInfo('å·²ç²˜è´´ç¤ºä¾‹æ ¼å¼ï¼Œè¯·æ›¿æ¢ä¸ºæ‚¨çš„å®é™…cookieså€¼');
    }

    // åŠ è½½å¤‡ä»½åˆ—è¡¨
    function loadBackupsList() {
        fetch('/api/cookies/backup/list', {
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('token')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayBackupsList(data.backups);
                document.getElementById('backupCount').innerHTML = 
                    `<span class="badge bg-success">${data.backups.length}</span>`;
            } else {
                showError('åŠ è½½å¤‡ä»½åˆ—è¡¨å¤±è´¥: ' + data.error);
            }
        })
        .catch(error => {
            showError('åŠ è½½å¤‡ä»½åˆ—è¡¨å¤±è´¥: ' + error.message);
        });
    }

    // æ˜¾ç¤ºå¤‡ä»½åˆ—è¡¨
    function displayBackupsList(backups) {
        const container = document.getElementById('backupsList');
        
        if (backups.length === 0) {
            container.innerHTML = '<div class="text-center text-muted">æš‚æ— å¤‡ä»½æ–‡ä»¶</div>';
            return;
        }

        let html = '<div class="table-responsive"><table class="table table-hover">';
        html += '<thead><tr><th>æ–‡ä»¶å</th><th>åˆ›å»ºæ—¶é—´</th><th>å¤§å°</th><th>æ“ä½œ</th></tr></thead><tbody>';

        backups.forEach(backup => {
            const sizeKB = (backup.file_size / 1024).toFixed(1);
            html += `
                <tr>
                    <td><code>${backup.filename}</code></td>
                    <td>${backup.created_time_str}</td>
                    <td>${sizeKB} KB</td>
                    <td>
                        <button class="btn btn-sm btn-outline-success" onclick="restoreBackup('${backup.filename}')">
                            <i class="fas fa-undo"></i> æ¢å¤
                        </button>
                    </td>
                </tr>
            `;
        });

        html += '</tbody></table></div>';
        container.innerHTML = html;
    }

    // æ¢å¤å¤‡ä»½
    window.restoreBackup = function(filename) {
        if (!confirm(`ç¡®å®šè¦æ¢å¤å¤‡ä»½ "${filename}" å—ï¼Ÿè¿™å°†æ›¿æ¢å½“å‰çš„cookiesã€‚`)) {
            return;
        }

        fetch('/api/cookies/backup/restore', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + localStorage.getItem('token')
            },
            body: JSON.stringify({
                backup_filename: filename
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccess('å¤‡ä»½æ¢å¤æˆåŠŸ: ' + data.message);
                checkCookiesStatus(); // åˆ·æ–°çŠ¶æ€
            } else {
                showError('æ¢å¤å¤±è´¥: ' + data.error);
            }
        })
        .catch(error => {
            showError('æ¢å¤å¤±è´¥: ' + error.message);
        });
    };

    // æ¶ˆæ¯æ˜¾ç¤ºå‡½æ•°
    function showSuccess(message) {
        showMessage(message, 'success');
    }

    function showError(message) {
        showMessage(message, 'danger');
    }

    function showWarning(message) {
        showMessage(message, 'warning');
    }

    function showInfo(message) {
        showMessage(message, 'info');
    }

    function showMessage(message, type) {
        const result = document.getElementById('importResult');
        result.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>`;
    }
});
</script>
{% endblock %}
