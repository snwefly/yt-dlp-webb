{% extends "base.html" %}

{% block title %}yt-dlp Web ä¸‹è½½å™¨{% endblock %}

{% block extra_css %}
    <!-- Animate.css -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">

    <style>
        .header-section {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            border-radius: 20px 20px 0 0;
            position: relative;
            overflow: hidden;
        }

        .btn-custom {
            border-radius: 25px;
            padding: 12px 30px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            border: none;
        }

        .btn-primary-custom {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
        }

        .btn-primary-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .form-control-custom {
            border-radius: 15px;
            border: 2px solid #e9ecef;
            padding: 15px 20px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-control-custom:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

        .card-custom {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }

        .progress-custom {
            height: 25px;
            border-radius: 15px;
            background: #e9ecef;
        }

        .progress-bar-custom {
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border-radius: 15px;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .status-section {
            display: none;
        }

        .status-section.show {
            display: block;
        }

        .hidden {
            display: none !important;
        }
    </style>
{% endblock %}

{% block content %}
    <!-- Header -->
    <div class="header-section p-5 text-center position-relative">
        <h1 class="display-4 fw-bold mb-3">
            <i class="fas fa-download me-3"></i>yt-dlp Web ä¸‹è½½å™¨
        </h1>
        <p class="lead mb-0">å¼ºå¤§çš„è§†é¢‘ä¸‹è½½å·¥å…·ï¼Œæ”¯æŒå¤šå¹³å°è§†é¢‘ä¸‹è½½</p>
    </div>

    <!-- Main Content -->
    <div class="p-4">
                <!-- YouTube CookiesçŠ¶æ€æç¤º -->
                <div id="cookies-status-alert" class="alert alert-warning d-none mb-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong><i class="fas fa-exclamation-triangle me-2"></i>YouTubeä¸‹è½½éœ€è¦è®¤è¯</strong>
                            <p class="mb-0">æ£€æµ‹åˆ°YouTube cookiesæœªé…ç½®æˆ–å·²è¿‡æœŸï¼Œå¯èƒ½æ— æ³•ä¸‹è½½YouTubeè§†é¢‘</p>
                        </div>
                        <div>
                            <button id="check-cookies-btn" class="btn btn-sm btn-outline-warning me-2">
                                <i class="fas fa-sync-alt"></i> æ£€æŸ¥çŠ¶æ€
                            </button>
                            <a href="/admin/cookies-manager" class="btn btn-sm btn-warning" id="manage-cookies-btn" style="display: none;">
                                <i class="fas fa-cog"></i> ç®¡ç†Cookies
                            </a>
                        </div>
                    </div>
                </div>

                <div id="cookies-success-alert" class="alert alert-success d-none mb-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong><i class="fas fa-check-circle me-2"></i>YouTubeä¸‹è½½å·²å°±ç»ª</strong>
                            <p class="mb-0">YouTube cookieså·²é…ç½®ä¸”æœ‰æ•ˆï¼Œå¯ä»¥æ­£å¸¸ä¸‹è½½YouTubeè§†é¢‘</p>
                        </div>
                        <small class="text-muted">çŠ¶æ€è‰¯å¥½</small>
                    </div>
                </div>

                <div class="row g-4">
                    <!-- Left Panel - Download Form -->
                    <div class="col-lg-8">
                        <div class="card card-custom h-100">
                            <div class="card-body p-4">
                                <h5 class="card-title mb-4">
                                    <i class="fas fa-link me-2"></i>è§†é¢‘ä¸‹è½½
                                </h5>

                                <!-- URL Input -->
                                <div class="mb-4">
                                    <label for="url" class="form-label fw-semibold">è§†é¢‘é“¾æ¥</label>
                                    <div class="input-group">
                                        <input type="url" class="form-control form-control-custom"
                                               id="url" placeholder="è¯·è¾“å…¥è§†é¢‘é“¾æ¥...">
                                        <button class="btn btn-outline-secondary" type="button" id="pasteBtn">
                                            <i class="fas fa-paste"></i>
                                        </button>
                                    </div>
                                </div>

                                <!-- Action Buttons -->
                                <div class="row g-3 mb-4">
                                    <div class="col-md-6">
                                        <button type="button" class="btn btn-outline-primary btn-custom w-100"
                                                id="getInfoBtn">
                                            <i class="fas fa-info-circle me-2"></i>
                                            <span id="infoText">è·å–è§†é¢‘ä¿¡æ¯</span>
                                            <span id="infoSpinner" class="loading-spinner ms-2 d-none"></span>
                                        </button>
                                    </div>
                                    <div class="col-md-6">
                                        <button type="button" class="btn btn-primary-custom btn-custom w-100"
                                                id="downloadBtn">
                                            <i class="fas fa-download me-2"></i>
                                            <span id="downloadText">å¼€å§‹ä¸‹è½½</span>
                                            <span id="downloadSpinner" class="loading-spinner ms-2 d-none"></span>
                                        </button>
                                    </div>
                                </div>

                                <!-- Message Area -->
                                <div id="messageArea"></div>

                                <!-- Video Info -->
                                <div id="video-info-section" class="status-section d-none mt-4">
                                    <div class="card bg-light">
                                        <div class="card-body">
                                            <h6 class="card-title">
                                                <i class="fas fa-video me-2"></i>è§†é¢‘ä¿¡æ¯
                                            </h6>
                                            <div id="video-info"></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Download Status -->
                                <div id="download-status-section" class="status-section d-none mt-4">
                                    <div class="card bg-light">
                                        <div class="card-body">
                                            <h6 class="card-title">
                                                <i class="fas fa-tasks me-2"></i>ä¸‹è½½çŠ¶æ€
                                            </h6>
                                            <div id="download-status"></div>

                                            <!-- Progress Container -->
                                            <div id="progress-container" class="d-none mt-3">
                                                <div class="progress progress-custom mb-3">
                                                    <div class="progress-bar progress-bar-custom"
                                                         id="progress-fill" role="progressbar" style="width: 0%">
                                                        <span id="progress-text">0%</span>
                                                    </div>
                                                </div>
                                                <div class="row g-3 text-center">
                                                    <div class="col-4">
                                                        <small class="text-muted">ä¸‹è½½é€Ÿåº¦</small>
                                                        <div id="download-speed" class="fw-bold">0 KB/s</div>
                                                    </div>
                                                    <div class="col-4">
                                                        <small class="text-muted">æ–‡ä»¶å¤§å°</small>
                                                        <div id="file-size" class="fw-bold">0 MB</div>
                                                    </div>
                                                    <div class="col-4">
                                                        <small class="text-muted">å‰©ä½™æ—¶é—´</small>
                                                        <div id="eta" class="fw-bold">--:--</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Recent Downloads -->
                                <div class="mt-4">
                                    <div class="card bg-light">
                                        <div class="card-body">
                                            <h6 class="card-title">
                                                <i class="fas fa-history me-2"></i>æœ€è¿‘ä¸‹è½½
                                            </h6>
                                            <div id="downloads-list"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Panel - Options -->
                    <div class="col-lg-4">
                        <div class="card card-custom h-100">
                            <div class="card-body p-4">
                                <h5 class="card-title mb-4">
                                    <i class="fas fa-cog me-2"></i>ä¸‹è½½é€‰é¡¹
                                </h5>

                                <!-- Quality Options -->
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">è§†é¢‘è´¨é‡</label>
                                    <select class="form-select" id="video-quality">
                                        <option value="best">æœ€ä½³è´¨é‡</option>
                                        <option value="worst">æœ€ä½è´¨é‡</option>
                                        <option value="1080">1080p</option>
                                        <option value="720">720p</option>
                                        <option value="480">480p</option>
                                        <option value="360">360p</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-semibold">éŸ³é¢‘è´¨é‡</label>
                                    <select class="form-select" id="audio-quality">
                                        <option value="best">æœ€ä½³è´¨é‡</option>
                                        <option value="worst">æœ€ä½è´¨é‡</option>
                                        <option value="320">320 kbps</option>
                                        <option value="256">256 kbps</option>
                                        <option value="192">192 kbps</option>
                                        <option value="128">128 kbps</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-semibold">è¾“å‡ºæ ¼å¼</label>
                                    <select class="form-select" id="output-format">
                                        <option value="best">è‡ªåŠ¨é€‰æ‹©</option>
                                        <option value="mp4">MP4 (è§†é¢‘)</option>
                                        <option value="webm">WebM (è§†é¢‘)</option>
                                        <option value="mkv">MKV (è§†é¢‘)</option>
                                        <option value="mp3">MP3 (éŸ³é¢‘)</option>
                                        <option value="aac">AAC (éŸ³é¢‘)</option>
                                        <option value="flac">FLAC (éŸ³é¢‘)</option>
                                        <option value="wav">WAV (éŸ³é¢‘)</option>
                                    </select>
                                </div>

                                <!-- Additional Options -->
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="audio-only">
                                        <label class="form-check-label" for="audio-only">
                                            ä»…æå–éŸ³é¢‘
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="download-subtitles">
                                        <label class="form-check-label" for="download-subtitles">
                                            ä¸‹è½½å­—å¹•
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="download-thumbnail">
                                        <label class="form-check-label" for="download-thumbnail">
                                            ä¸‹è½½ç¼©ç•¥å›¾
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="download-description">
                                        <label class="form-check-label" for="download-description">
                                            ä¸‹è½½æè¿°
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="download-playlist">
                                        <label class="form-check-label" for="download-playlist">
                                            ä¸‹è½½æ•´ä¸ªæ’­æ”¾åˆ—è¡¨
                                        </label>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-semibold">å­—å¹•è¯­è¨€</label>
                                    <select class="form-select" id="subtitle-lang">
                                        <option value="all">æ‰€æœ‰å¯ç”¨è¯­è¨€</option>
                                        <option value="zh">ä¸­æ–‡</option>
                                        <option value="en">è‹±æ–‡</option>
                                        <option value="ja">æ—¥æ–‡</option>
                                        <option value="ko">éŸ©æ–‡</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
{% endblock %}

{% block scripts %}
    <script>

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ğŸš€ é¡µé¢åŠ è½½å®Œæˆ');
            console.log('æœåŠ¡å™¨è®¤è¯çŠ¶æ€:', isAuthenticated);
            console.log('å½“å‰ç”¨æˆ·:', currentUser);

            // æ£€æŸ¥ localStorage ä¸­çš„ token
            const token = getAuthToken();
            console.log('localStorage token:', token ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');

            // å¦‚æœæœ‰tokenï¼Œå§‹ç»ˆç¡®ä¿è®¤è¯çŠ¶æ€åŒæ­¥ï¼ˆæ— è®ºæœåŠ¡å™¨ç«¯çŠ¶æ€å¦‚ä½•ï¼‰
            if (token) {
                console.log('ğŸ”„ æ£€æµ‹åˆ°localStorage tokenï¼Œç¡®ä¿è®¤è¯çŠ¶æ€åŒæ­¥...');

                // ä½¿ç”¨å…¨å±€çš„è®¤è¯åŒæ­¥å‡½æ•°
                if (window.ensureAuthSync) {
                    const syncSuccess = await window.ensureAuthSync();
                    if (syncSuccess) {
                        console.log('âœ… è®¤è¯çŠ¶æ€åŒæ­¥æˆåŠŸ');

                        // éªŒè¯tokenå¹¶è·å–ç”¨æˆ·ä¿¡æ¯
                        const tokenValid = await validateToken();
                        if (tokenValid) {
                            isAuthenticated = true;
                            try {
                                const response = await axios.get('/api/auth/verify', {
                                    headers: { 'Authorization': `Bearer ${token}` }
                                });
                                if (response.data.valid) {
                                    currentUser = response.data.username;
                                    console.log('âœ… å·²æ›´æ–°ç”¨æˆ·ä¿¡æ¯:', currentUser);
                                }
                            } catch (error) {
                                console.log('âš ï¸ è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
                            }
                        }
                    } else {
                        console.log('âŒ è®¤è¯çŠ¶æ€åŒæ­¥å¤±è´¥ï¼Œtokenå·²æ¸…ç†');
                        isAuthenticated = false;
                        currentUser = null;
                    }
                }
            } else {
                console.log('â„¹ï¸ æ— localStorage tokenï¼Œä¿æŒå½“å‰è®¤è¯çŠ¶æ€');
                // å¦‚æœæ²¡æœ‰tokenä½†æœåŠ¡å™¨ç«¯æ˜¾ç¤ºå·²è®¤è¯ï¼Œå¯èƒ½æ˜¯sessionæ®‹ç•™ï¼Œæ¸…ç†çŠ¶æ€
                if (isAuthenticated) {
                    console.log('âš ï¸ æ— tokenä½†æœåŠ¡å™¨ç«¯æ˜¾ç¤ºå·²è®¤è¯ï¼Œæ¸…ç†è®¤è¯çŠ¶æ€');
                    isAuthenticated = false;
                    currentUser = null;
                }
            }

            // ç»‘å®šäº‹ä»¶
            bindEvents();

            // æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯å’Œæ£€æŸ¥çŠ¶æ€
            if (isUserAuthenticated()) {
                console.log('âœ… ç”¨æˆ·å·²è®¤è¯ï¼Œæ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯');
                showMessage('æ¬¢è¿ä½¿ç”¨ yt-dlp Web ä¸‹è½½å™¨ï¼', 'success');
                // æ£€æŸ¥cookiesçŠ¶æ€
                checkCookiesStatus();


            } else {
                console.log('â„¹ï¸ ç”¨æˆ·æœªè®¤è¯ï¼Œæ˜¾ç¤ºè®¿å®¢æ¶ˆæ¯');
                showMessage('æ‚¨æ­£åœ¨ä»¥è®¿å®¢æ¨¡å¼æµè§ˆï¼Œç™»å½•åå¯ä½¿ç”¨ä¸‹è½½åŠŸèƒ½ã€‚', 'info');
            }
        });



        // æ£€æŸ¥cookiesçŠ¶æ€
        async function checkCookiesStatus() {
            if (!isUserAuthenticated()) {
                return;
            }

            // ç¡®ä¿è®¤è¯çŠ¶æ€åŒæ­¥
            if (window.ensureAuthSync) {
                console.log('ğŸ”„ æ£€æŸ¥cookieså‰ç¡®ä¿è®¤è¯çŠ¶æ€åŒæ­¥...');
                const syncSuccess = await window.ensureAuthSync();
                if (!syncSuccess) {
                    console.log('âŒ è®¤è¯çŠ¶æ€åŒæ­¥å¤±è´¥ï¼Œè·³è¿‡cookiesæ£€æŸ¥');
                    return;
                }
            }

            try {
                const token = getAuthToken();
                const response = await axios.get('/api/cookies/status', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.data.success) {
                    updateCookiesStatusDisplay(response.data);
                } else {
                    showCookiesWarning('æ£€æŸ¥cookiesçŠ¶æ€å¤±è´¥');
                }
            } catch (error) {
                console.log('æ£€æŸ¥cookiesçŠ¶æ€å¤±è´¥:', error);
                // å¦‚æœæ˜¯401é”™è¯¯ï¼Œè¯´æ˜éœ€è¦ç™»å½•
                if (error.response?.status !== 401) {
                    showCookiesWarning('æ— æ³•æ£€æŸ¥cookiesçŠ¶æ€');
                }
            }
        }

        // æ›´æ–°cookiesçŠ¶æ€æ˜¾ç¤º
        function updateCookiesStatusDisplay(status) {
            const warningAlert = document.getElementById('cookies-status-alert');
            const successAlert = document.getElementById('cookies-success-alert');
            const manageCookiesBtn = document.getElementById('manage-cookies-btn');

            // éšè—æ‰€æœ‰æç¤º
            warningAlert.classList.add('d-none');
            successAlert.classList.add('d-none');

            if (!status.exists || status.status === 'expired' || status.status === 'incomplete') {
                // æ˜¾ç¤ºè­¦å‘Š
                warningAlert.classList.remove('d-none');
                if (isUserAuthenticated()) {
                    manageCookiesBtn.style.display = 'inline-block';
                }
            } else if (status.status === 'good' || status.status === 'warning') {
                // æ˜¾ç¤ºæˆåŠŸ
                successAlert.classList.remove('d-none');
                const statusText = successAlert.querySelector('small');
                if (status.status === 'warning') {
                    statusText.textContent = 'å»ºè®®è¿‘æœŸæ›´æ–°';
                    statusText.className = 'text-warning';
                } else {
                    statusText.textContent = 'çŠ¶æ€è‰¯å¥½';
                    statusText.className = 'text-muted';
                }
            }
        }

        // æ˜¾ç¤ºcookiesè­¦å‘Š
        function showCookiesWarning(message) {
            const warningAlert = document.getElementById('cookies-status-alert');
            const messageElement = warningAlert.querySelector('p');
            messageElement.textContent = message;
            warningAlert.classList.remove('d-none');
        }

        // ç»‘å®šäº‹ä»¶
        function bindEvents() {
            // cookiesçŠ¶æ€æ£€æŸ¥æŒ‰é’®
            document.getElementById('check-cookies-btn').addEventListener('click', function() {
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æ£€æŸ¥ä¸­';
                this.disabled = true;

                checkCookiesStatus().finally(() => {
                    this.innerHTML = '<i class="fas fa-sync-alt"></i> æ£€æŸ¥çŠ¶æ€';
                    this.disabled = false;
                });
            });
            // ç²˜è´´æŒ‰é’®
            document.getElementById('pasteBtn').addEventListener('click', async function() {
                try {
                    const text = await navigator.clipboard.readText();
                    document.getElementById('url').value = text;
                    showMessage('é“¾æ¥å·²ç²˜è´´', 'success');
                } catch (err) {
                    showMessage('æ— æ³•è®¿é—®å‰ªè´´æ¿ï¼Œè¯·æ‰‹åŠ¨ç²˜è´´', 'warning');
                }
            });

            // è·å–è§†é¢‘ä¿¡æ¯æŒ‰é’®
            document.getElementById('getInfoBtn').addEventListener('click', getVideoInfo);

            // ä¸‹è½½æŒ‰é’®
            const downloadBtn = document.getElementById('downloadBtn');
            if (downloadBtn) {
                downloadBtn.addEventListener('click', startDownload);
                console.log('âœ… ä¸‹è½½æŒ‰é’®äº‹ä»¶å·²ç»‘å®š');
            } else {
                console.error('âŒ æ‰¾ä¸åˆ°ä¸‹è½½æŒ‰é’®å…ƒç´ ');
            }
        }

        // è·å–è§†é¢‘ä¿¡æ¯
        async function getVideoInfo() {
            // æ£€æŸ¥è®¤è¯çŠ¶æ€
            if (!isUserAuthenticated()) {
                console.log('âŒ è®¤è¯å¤±è´¥ï¼Œéœ€è¦ç™»å½•');
                showLoginRequired('æŸ¥çœ‹è§†é¢‘ä¿¡æ¯');
                return;
            }

            const token = getAuthToken();

            // ç¡®ä¿è®¤è¯çŠ¶æ€åŒæ­¥
            if (window.ensureAuthSync) {
                console.log('ğŸ”„ APIè°ƒç”¨å‰ç¡®ä¿è®¤è¯çŠ¶æ€åŒæ­¥...');
                const syncSuccess = await window.ensureAuthSync();
                if (!syncSuccess) {
                    console.log('âŒ è®¤è¯çŠ¶æ€åŒæ­¥å¤±è´¥ï¼Œéœ€è¦é‡æ–°ç™»å½•');
                    showLoginRequired('æŸ¥çœ‹è§†é¢‘ä¿¡æ¯');
                    return;
                }
            }

            const url = document.getElementById('url').value.trim();
            if (!url) {
                showMessage('è¯·è¾“å…¥è§†é¢‘é“¾æ¥', 'error');
                return;
            }

            const btn = document.getElementById('getInfoBtn');
            const spinner = document.getElementById('infoSpinner');
            const text = document.getElementById('infoText');

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            btn.disabled = true;
            spinner.classList.remove('d-none');
            text.textContent = 'è·å–ä¸­...';

            try {
                console.log('ğŸ“¤ å‘é€è§†é¢‘ä¿¡æ¯è¯·æ±‚ï¼Œä½¿ç”¨token:', token ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
                const response = await axios.post('/api/info', {
                    url: url
                }, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.data.success) {
                    displayVideoInfo(response.data.info);
                    showMessage('è§†é¢‘ä¿¡æ¯è·å–æˆåŠŸ', 'success');
                } else {
                    showMessage(response.data.error || 'è·å–è§†é¢‘ä¿¡æ¯å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('è·å–è§†é¢‘ä¿¡æ¯å¤±è´¥:', error);
                if (error.response?.status === 401) {
                    showLoginRequired('è·å–è§†é¢‘ä¿¡æ¯');
                } else {
                    showMessage('è·å–è§†é¢‘ä¿¡æ¯å¤±è´¥: ' + (error.response?.data?.error || error.message), 'error');
                }
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                btn.disabled = false;
                spinner.classList.add('d-none');
                text.textContent = 'è·å–è§†é¢‘ä¿¡æ¯';
            }
        }

        // å¼€å§‹ä¸‹è½½
        async function startDownload() {
            console.log('ğŸ¯ å¼€å§‹ä¸‹è½½å‡½æ•°è¢«è°ƒç”¨');

            // æ£€æŸ¥è®¤è¯çŠ¶æ€
            if (!isUserAuthenticated()) {
                console.log('âŒ è®¤è¯å¤±è´¥ï¼Œéœ€è¦ç™»å½•');
                showLoginRequired('ä¸‹è½½è§†é¢‘');
                return;
            }

            const token = getAuthToken();

            // ç¡®ä¿è®¤è¯çŠ¶æ€åŒæ­¥
            if (window.ensureAuthSync) {
                console.log('ğŸ”„ ä¸‹è½½å‰ç¡®ä¿è®¤è¯çŠ¶æ€åŒæ­¥...');
                const syncSuccess = await window.ensureAuthSync();
                if (!syncSuccess) {
                    console.log('âŒ è®¤è¯çŠ¶æ€åŒæ­¥å¤±è´¥ï¼Œéœ€è¦é‡æ–°ç™»å½•');
                    showLoginRequired('ä¸‹è½½è§†é¢‘');
                    return;
                }
            }

            const url = document.getElementById('url').value.trim();
            if (!url) {
                showMessage('è¯·è¾“å…¥è§†é¢‘é“¾æ¥', 'error');
                return;
            }

            const btn = document.getElementById('downloadBtn');
            const spinner = document.getElementById('downloadSpinner');
            const text = document.getElementById('downloadText');

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            btn.disabled = true;
            spinner.classList.remove('d-none');
            text.textContent = 'ä¸‹è½½ä¸­...';

            try {
                const downloadOptions = {
                    url: url,
                    video_quality: document.getElementById('video-quality').value,
                    audio_quality: document.getElementById('audio-quality').value,
                    output_format: document.getElementById('output-format').value,
                    audio_only: document.getElementById('audio-only').checked,
                    download_subtitles: document.getElementById('download-subtitles').checked,
                    download_thumbnail: document.getElementById('download-thumbnail').checked,
                    download_description: document.getElementById('download-description').checked,
                    download_playlist: document.getElementById('download-playlist').checked,
                    subtitle_lang: document.getElementById('subtitle-lang').value,
                    preset: 'custom'
                };

                console.log('ğŸ“¤ å‘é€ä¸‹è½½è¯·æ±‚:', downloadOptions);
                console.log('ğŸ”‘ ä½¿ç”¨ token:', token ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');

                const response = await axios.post('/api/download', downloadOptions, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                console.log('ğŸ“¥ ä¸‹è½½å“åº”:', response.data);

                if (response.data.success) {
                    showMessage('ä¸‹è½½ä»»åŠ¡å·²å¼€å§‹', 'success');

                    // æ˜¾ç¤ºä¸‹è½½çŠ¶æ€åŒºåŸŸ
                    const statusSection = document.getElementById('download-status-section');
                    statusSection.classList.remove('d-none');
                    statusSection.classList.add('show');

                    // å¼€å§‹ç›‘æ§ä¸‹è½½è¿›åº¦
                    startDownloadMonitoring(response.data.download_id);
                } else {
                    showMessage(response.data.error || 'ä¸‹è½½å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('âŒ ä¸‹è½½å¤±è´¥:', error);
                console.error('é”™è¯¯è¯¦æƒ…:', {
                    status: error.response?.status,
                    statusText: error.response?.statusText,
                    data: error.response?.data,
                    message: error.message
                });

                if (error.response?.status === 401) {
                    console.log('ğŸ” è®¤è¯å¤±è´¥ï¼Œæ˜¾ç¤ºç™»å½•æç¤º');
                    showLoginRequired('ä¸‹è½½è§†é¢‘');
                } else {
                    const errorMsg = error.response?.data?.error || error.message || 'æœªçŸ¥é”™è¯¯';
                    console.log('ğŸ’¥ æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯:', errorMsg);
                    showMessage('ä¸‹è½½å¤±è´¥: ' + errorMsg, 'error');
                }
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                btn.disabled = false;
                spinner.classList.add('d-none');
                text.textContent = 'å¼€å§‹ä¸‹è½½';
            }
        }

        // æ˜¾ç¤ºéœ€è¦ç™»å½•çš„æç¤º
        function showLoginRequired(action) {
            Swal.fire({
                title: 'éœ€è¦ç™»å½•',
                text: `è¯·å…ˆç™»å½•ä»¥${action}`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'ç«‹å³ç™»å½•',
                cancelButtonText: 'å–æ¶ˆ',
                confirmButtonColor: '#667eea'
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname);
                }
            });
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type = 'info') {
            const messageArea = document.getElementById('messageArea');
            const alertClass = {
                'success': 'alert-success',
                'error': 'alert-danger',
                'warning': 'alert-warning',
                'info': 'alert-info'
            }[type] || 'alert-info';

            const alertHtml = `
                <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;

            messageArea.innerHTML = alertHtml;

            // è‡ªåŠ¨éšè—æ¶ˆæ¯
            setTimeout(() => {
                const alert = messageArea.querySelector('.alert');
                if (alert) {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }
            }, 5000);
        }

        // æ˜¾ç¤ºè§†é¢‘ä¿¡æ¯
        function displayVideoInfo(info) {
            const videoInfoSection = document.getElementById('video-info-section');
            const videoInfo = document.getElementById('video-info');
            const duration = info.duration ? formatDuration(info.duration) : 'æœªçŸ¥';
            const fileSize = info.filesize ? formatFileSize(info.filesize) : 'æœªçŸ¥';

            const infoHtml = `
                <div class="row g-3">
                    <div class="col-12">
                        <h6 class="fw-bold">${info.title || 'æœªçŸ¥æ ‡é¢˜'}</h6>
                    </div>
                    <div class="col-md-6">
                        <small class="text-muted">ä¸Šä¼ è€…</small>
                        <div>${info.uploader || 'æœªçŸ¥'}</div>
                    </div>
                    <div class="col-md-6">
                        <small class="text-muted">æ—¶é•¿</small>
                        <div>${duration}</div>
                    </div>
                    <div class="col-md-6">
                        <small class="text-muted">è§‚çœ‹æ¬¡æ•°</small>
                        <div>${info.view_count ? info.view_count.toLocaleString() : 'æœªçŸ¥'}</div>
                    </div>
                    <div class="col-md-6">
                        <small class="text-muted">é¢„ä¼°å¤§å°</small>
                        <div>${fileSize}</div>
                    </div>
                    ${info.description ? `
                    <div class="col-12">
                        <small class="text-muted">æè¿°</small>
                        <div class="text-truncate" style="max-height: 60px; overflow: hidden;">
                            ${info.description.substring(0, 200)}${info.description.length > 200 ? '...' : ''}
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;

            videoInfo.innerHTML = infoHtml;
            videoInfoSection.classList.remove('d-none');
            videoInfoSection.classList.add('show');
        }

        // å·¥å…·å‡½æ•°
        function formatDuration(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;

            if (hours > 0) {
                return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            } else {
                return `${minutes}:${secs.toString().padStart(2, '0')}`;
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatSpeed(bytesPerSecond) {
            return formatFileSize(bytesPerSecond) + '/s';
        }

        function formatTime(seconds) {
            if (seconds < 60) {
                return `${Math.round(seconds)}ç§’`;
            } else if (seconds < 3600) {
                const minutes = Math.floor(seconds / 60);
                const secs = Math.round(seconds % 60);
                return `${minutes}åˆ†${secs}ç§’`;
            } else {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                return `${hours}å°æ—¶${minutes}åˆ†`;
            }
        }

        // å¼€å§‹ä¸‹è½½ç›‘æ§
        function startDownloadMonitoring(downloadId) {
            console.log('ğŸ“Š å¼€å§‹ç›‘æ§ä¸‹è½½:', downloadId);

            const progressContainer = document.getElementById('progress-container');
            progressContainer.classList.remove('d-none');

            // æ¯2ç§’æ£€æŸ¥ä¸€æ¬¡ä¸‹è½½çŠ¶æ€
            const interval = setInterval(async () => {
                try {
                    const token = getAuthToken();
                    const response = await axios.get(`/api/download/${downloadId}/status`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.data) {
                        updateDownloadProgress(response.data);

                        // å¦‚æœä¸‹è½½å®Œæˆæˆ–å¤±è´¥ï¼Œåœæ­¢ç›‘æ§
                        if (response.data.status === 'completed' || response.data.status === 'failed') {
                            clearInterval(interval);
                            handleDownloadComplete(response.data);
                        }
                    }
                } catch (error) {
                    console.error('è·å–ä¸‹è½½çŠ¶æ€å¤±è´¥:', error);
                    clearInterval(interval);
                }
            }, 2000);
        }

        // æ›´æ–°ä¸‹è½½è¿›åº¦
        function updateDownloadProgress(downloadData) {
            const progressFill = document.getElementById('progress-fill');
            const progressText = document.getElementById('progress-text');
            const downloadSpeed = document.getElementById('download-speed');
            const fileSize = document.getElementById('file-size');
            const eta = document.getElementById('eta');
            const downloadStatus = document.getElementById('download-status');

            // æ›´æ–°è¿›åº¦æ¡
            const progress = downloadData.progress || 0;
            progressFill.style.width = `${progress}%`;
            progressText.textContent = `${progress}%`;

            // æ›´æ–°çŠ¶æ€æ–‡æœ¬
            let statusText = '';
            switch (downloadData.status) {
                case 'pending':
                    statusText = 'â³ ç­‰å¾…å¼€å§‹...';
                    break;
                case 'downloading':
                    statusText = 'ğŸ“¥ æ­£åœ¨ä¸‹è½½...';
                    break;
                case 'completed':
                    statusText = 'âœ… ä¸‹è½½å®Œæˆ';
                    break;
                case 'failed':
                    statusText = `âŒ ä¸‹è½½å¤±è´¥: ${downloadData.error || 'æœªçŸ¥é”™è¯¯'}`;
                    break;
                default:
                    statusText = `ğŸ“Š çŠ¶æ€: ${downloadData.status}`;
            }
            downloadStatus.textContent = statusText;

            // æ›´æ–°ä¸‹è½½ä¿¡æ¯
            if (downloadData.speed) {
                downloadSpeed.textContent = formatSpeed(downloadData.speed);
            }

            if (downloadData.total_bytes) {
                fileSize.textContent = formatFileSize(downloadData.total_bytes);
            }

            if (downloadData.eta) {
                eta.textContent = formatTime(downloadData.eta);
            }

            console.log('ğŸ“Š è¿›åº¦æ›´æ–°:', {
                progress: progress,
                status: downloadData.status,
                filename: downloadData.filename
            });
        }

        // å¤„ç†ä¸‹è½½å®Œæˆ
        function handleDownloadComplete(downloadData) {
            if (downloadData.status === 'completed') {
                showMessage('ğŸ‰ ä¸‹è½½å®Œæˆï¼', 'success');

                // å¦‚æœæœ‰æ–‡ä»¶åå’Œä¸‹è½½é“¾æ¥ï¼Œæ˜¾ç¤ºä¸‹è½½æŒ‰é’®
                if (downloadData.filename && downloadData.download_url) {
                    const filename = downloadData.filename.split('/').pop(); // è·å–æ–‡ä»¶å

                    // åœ¨ä¸‹è½½çŠ¶æ€åŒºåŸŸæ·»åŠ ä¸‹è½½é“¾æ¥
                    const downloadStatus = document.getElementById('download-status');
                    downloadStatus.innerHTML = `
                        <div class="d-flex align-items-center justify-content-between">
                            <span>âœ… ä¸‹è½½å®Œæˆ: ${filename}</span>
                            <a href="${downloadData.download_url}"
                               class="btn btn-success btn-sm"
                               download="${filename}">
                                <i class="fas fa-download me-1"></i>ä¸‹è½½æ–‡ä»¶
                            </a>
                        </div>
                    `;

                    showMessage(`æ–‡ä»¶å·²ä¿å­˜: ${filename}`, 'info');
                } else if (downloadData.filename) {
                    const filename = downloadData.filename.split('/').pop();
                    showMessage(`æ–‡ä»¶å·²ä¿å­˜: ${filename}`, 'info');
                }
            } else if (downloadData.status === 'failed') {
                showMessage(`ä¸‹è½½å¤±è´¥: ${downloadData.error || 'æœªçŸ¥é”™è¯¯'}`, 'error');
            }
        }

        // é€€å‡ºç™»å½•ï¼ˆé¦–é¡µç‰ˆæœ¬ï¼Œä½¿ç”¨ç¡®è®¤å¯¹è¯æ¡†ï¼‰
        function logoutWithConfirm() {
            Swal.fire({
                title: 'ç¡®è®¤é€€å‡º',
                text: 'æ‚¨ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'ç¡®è®¤é€€å‡º',
                cancelButtonText: 'å–æ¶ˆ',
                confirmButtonColor: '#dc3545'
            }).then((result) => {
                if (result.isConfirmed) {
                    localStorage.removeItem('auth_token');
                    window.location.href = '/login';
                }
            });
        }
    </script>
{% endblock %}