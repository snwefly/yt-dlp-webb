<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>yt-dlp Web ä¸‹è½½å™¨</title>

    <!-- è®¤è¯çŠ¶æ€å…ƒæ•°æ® -->
    <meta name="auth-status" content="{{ 'true' if is_authenticated else 'false' }}">
    <meta name="current-user" content="{{ current_user or '' }}">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Animate.css -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">

    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
        }

        body {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .main-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .header-section {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            border-radius: 20px 20px 0 0;
            position: relative;
            overflow: hidden;
        }

        .user-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 10;
        }

        .btn-custom {
            border-radius: 25px;
            padding: 12px 30px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
            border: none;
        }

        .btn-primary-custom {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
        }

        .btn-primary-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .form-control-custom {
            border-radius: 15px;
            border: 2px solid #e9ecef;
            padding: 15px 20px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .form-control-custom:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

        .card-custom {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }

        .progress-custom {
            height: 25px;
            border-radius: 15px;
            background: #e9ecef;
        }

        .progress-bar-custom {
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border-radius: 15px;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .status-section {
            display: none;
        }

        .status-section.show {
            display: block;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="main-container mx-auto" style="max-width: 1200px;">
            <!-- Header -->
            <div class="header-section p-5 text-center position-relative">
                <div class="user-controls" id="userControls">
                    <!-- ç”¨æˆ·æ§ä»¶å°†é€šè¿‡ JavaScript åŠ¨æ€æ·»åŠ  -->
                </div>
                <h1 class="display-4 fw-bold mb-3">
                    <i class="fas fa-download me-3"></i>yt-dlp Web ä¸‹è½½å™¨
                </h1>
                <p class="lead mb-0">å¼ºå¤§çš„è§†é¢‘ä¸‹è½½å·¥å…·ï¼Œæ”¯æŒå¤šå¹³å°è§†é¢‘ä¸‹è½½</p>
            </div>

            <!-- Main Content -->
            <div class="p-4">
                <div class="row g-4">
                    <!-- Left Panel - Download Form -->
                    <div class="col-lg-8">
                        <div class="card card-custom h-100">
                            <div class="card-body p-4">
                                <h5 class="card-title mb-4">
                                    <i class="fas fa-link me-2"></i>è§†é¢‘ä¸‹è½½
                                </h5>

                                <!-- URL Input -->
                                <div class="mb-4">
                                    <label for="url" class="form-label fw-semibold">è§†é¢‘é“¾æ¥</label>
                                    <div class="input-group">
                                        <input type="url" class="form-control form-control-custom"
                                               id="url" placeholder="è¯·è¾“å…¥è§†é¢‘é“¾æ¥...">
                                        <button class="btn btn-outline-secondary" type="button" id="pasteBtn">
                                            <i class="fas fa-paste"></i>
                                        </button>
                                    </div>
                                </div>

                                <!-- Action Buttons -->
                                <div class="row g-3 mb-4">
                                    <div class="col-md-6">
                                        <button type="button" class="btn btn-outline-primary btn-custom w-100"
                                                id="getInfoBtn">
                                            <i class="fas fa-info-circle me-2"></i>
                                            <span id="infoText">è·å–è§†é¢‘ä¿¡æ¯</span>
                                            <span id="infoSpinner" class="loading-spinner ms-2 d-none"></span>
                                        </button>
                                    </div>
                                    <div class="col-md-6">
                                        <button type="button" class="btn btn-primary-custom btn-custom w-100"
                                                id="downloadBtn">
                                            <i class="fas fa-download me-2"></i>
                                            <span id="downloadText">å¼€å§‹ä¸‹è½½</span>
                                            <span id="downloadSpinner" class="loading-spinner ms-2 d-none"></span>
                                        </button>
                                    </div>
                                </div>

                                <!-- Message Area -->
                                <div id="messageArea"></div>

                                <!-- Video Info -->
                                <div id="video-info-section" class="status-section d-none mt-4">
                                    <div class="card bg-light">
                                        <div class="card-body">
                                            <h6 class="card-title">
                                                <i class="fas fa-video me-2"></i>è§†é¢‘ä¿¡æ¯
                                            </h6>
                                            <div id="video-info"></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Download Status -->
                                <div id="download-status-section" class="status-section d-none mt-4">
                                    <div class="card bg-light">
                                        <div class="card-body">
                                            <h6 class="card-title">
                                                <i class="fas fa-tasks me-2"></i>ä¸‹è½½çŠ¶æ€
                                            </h6>
                                            <div id="download-status"></div>

                                            <!-- Progress Container -->
                                            <div id="progress-container" class="d-none mt-3">
                                                <div class="progress progress-custom mb-3">
                                                    <div class="progress-bar progress-bar-custom"
                                                         id="progress-fill" role="progressbar" style="width: 0%">
                                                        <span id="progress-text">0%</span>
                                                    </div>
                                                </div>
                                                <div class="row g-3 text-center">
                                                    <div class="col-4">
                                                        <small class="text-muted">ä¸‹è½½é€Ÿåº¦</small>
                                                        <div id="download-speed" class="fw-bold">0 KB/s</div>
                                                    </div>
                                                    <div class="col-4">
                                                        <small class="text-muted">æ–‡ä»¶å¤§å°</small>
                                                        <div id="file-size" class="fw-bold">0 MB</div>
                                                    </div>
                                                    <div class="col-4">
                                                        <small class="text-muted">å‰©ä½™æ—¶é—´</small>
                                                        <div id="eta" class="fw-bold">--:--</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Recent Downloads -->
                                <div class="mt-4">
                                    <div class="card bg-light">
                                        <div class="card-body">
                                            <h6 class="card-title">
                                                <i class="fas fa-history me-2"></i>æœ€è¿‘ä¸‹è½½
                                            </h6>
                                            <div id="downloads-list"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Panel - Options -->
                    <div class="col-lg-4">
                        <div class="card card-custom h-100">
                            <div class="card-body p-4">
                                <h5 class="card-title mb-4">
                                    <i class="fas fa-cog me-2"></i>ä¸‹è½½é€‰é¡¹
                                </h5>

                                <!-- Quality Options -->
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">è§†é¢‘è´¨é‡</label>
                                    <select class="form-select" id="video-quality">
                                        <option value="best">æœ€ä½³è´¨é‡</option>
                                        <option value="worst">æœ€ä½è´¨é‡</option>
                                        <option value="1080">1080p</option>
                                        <option value="720">720p</option>
                                        <option value="480">480p</option>
                                        <option value="360">360p</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-semibold">éŸ³é¢‘è´¨é‡</label>
                                    <select class="form-select" id="audio-quality">
                                        <option value="best">æœ€ä½³è´¨é‡</option>
                                        <option value="worst">æœ€ä½è´¨é‡</option>
                                        <option value="320">320 kbps</option>
                                        <option value="256">256 kbps</option>
                                        <option value="192">192 kbps</option>
                                        <option value="128">128 kbps</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-semibold">è¾“å‡ºæ ¼å¼</label>
                                    <select class="form-select" id="output-format">
                                        <option value="best">è‡ªåŠ¨é€‰æ‹©</option>
                                        <option value="mp4">MP4 (è§†é¢‘)</option>
                                        <option value="webm">WebM (è§†é¢‘)</option>
                                        <option value="mkv">MKV (è§†é¢‘)</option>
                                        <option value="mp3">MP3 (éŸ³é¢‘)</option>
                                        <option value="aac">AAC (éŸ³é¢‘)</option>
                                        <option value="flac">FLAC (éŸ³é¢‘)</option>
                                        <option value="wav">WAV (éŸ³é¢‘)</option>
                                    </select>
                                </div>

                                <!-- Additional Options -->
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="audio-only">
                                        <label class="form-check-label" for="audio-only">
                                            ä»…æå–éŸ³é¢‘
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="download-subtitles">
                                        <label class="form-check-label" for="download-subtitles">
                                            ä¸‹è½½å­—å¹•
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="download-thumbnail">
                                        <label class="form-check-label" for="download-thumbnail">
                                            ä¸‹è½½ç¼©ç•¥å›¾
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="download-description">
                                        <label class="form-check-label" for="download-description">
                                            ä¸‹è½½æè¿°
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="download-playlist">
                                        <label class="form-check-label" for="download-playlist">
                                            ä¸‹è½½æ•´ä¸ªæ’­æ”¾åˆ—è¡¨
                                        </label>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-semibold">å­—å¹•è¯­è¨€</label>
                                    <select class="form-select" id="subtitle-lang">
                                        <option value="all">æ‰€æœ‰å¯ç”¨è¯­è¨€</option>
                                        <option value="zh">ä¸­æ–‡</option>
                                        <option value="en">è‹±æ–‡</option>
                                        <option value="ja">æ—¥æ–‡</option>
                                        <option value="ko">éŸ©æ–‡</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script>
        // å…¨å±€å˜é‡ - ä»æœåŠ¡å™¨ç«¯è·å–
        let isAuthenticated = false;
        let currentUser = null;

        // ä»é¡µé¢å…ƒæ•°æ®è·å–è®¤è¯çŠ¶æ€
        try {
            const authMeta = document.querySelector('meta[name="auth-status"]');
            const userMeta = document.querySelector('meta[name="current-user"]');

            if (authMeta) {
                isAuthenticated = authMeta.content === 'true';
            }
            if (userMeta && userMeta.content) {
                currentUser = userMeta.content;
            }
        } catch (e) {
            console.log('æ— æ³•ä»å…ƒæ•°æ®è·å–è®¤è¯çŠ¶æ€ï¼Œä½¿ç”¨é»˜è®¤å€¼');
        }

        // å¤‡ç”¨æ–¹æ³•ï¼šæ£€æŸ¥ localStorage ä¸­çš„ token
        const token = localStorage.getItem('auth_token');
        if (token && !isAuthenticated) {
            // å¦‚æœæœ‰ token ä½†æœåŠ¡å™¨ç«¯è®¤ä¸ºæœªè®¤è¯ï¼Œå¯èƒ½æ˜¯ token è¿‡æœŸ
            console.log('æ£€æµ‹åˆ° localStorage tokenï¼Œä½†æœåŠ¡å™¨ç«¯æœªè®¤è¯');
        }

        // è·å–æœ‰æ•ˆçš„è®¤è¯token
        function getAuthToken() {
            const token = localStorage.getItem('auth_token');
            console.log('ğŸ”‘ è·å–è®¤è¯token:', token ? `å­˜åœ¨(${token.substring(0, 10)}...)` : 'ä¸å­˜åœ¨');
            return token;
        }

        // æ£€æŸ¥è®¤è¯çŠ¶æ€
        function isUserAuthenticated() {
            const token = getAuthToken();
            const authenticated = (token && token.length > 0) || isAuthenticated;
            console.log('ğŸ” ç”¨æˆ·è®¤è¯çŠ¶æ€:', {
                hasToken: !!token,
                serverAuth: isAuthenticated,
                finalAuth: authenticated
            });
            return authenticated;
        }

        // éªŒè¯tokenæœ‰æ•ˆæ€§
        async function validateToken() {
            const token = getAuthToken();
            if (!token) {
                console.log('ğŸ” æ²¡æœ‰tokenï¼Œè·³è¿‡éªŒè¯');
                return false;
            }

            try {
                console.log('ğŸ” éªŒè¯tokenæœ‰æ•ˆæ€§...');
                const response = await axios.get('/api/auth/verify', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.data.valid) {
                    console.log('âœ… TokenéªŒè¯æˆåŠŸ');
                    return true;
                } else {
                    console.log('âŒ TokenéªŒè¯å¤±è´¥ï¼Œæ¸…é™¤æ— æ•ˆtoken');
                    localStorage.removeItem('auth_token');
                    return false;
                }
            } catch (error) {
                console.log('âŒ TokenéªŒè¯å‡ºé”™ï¼Œæ¸…é™¤token:', error.response?.status);
                localStorage.removeItem('auth_token');
                return false;
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ğŸš€ é¡µé¢åŠ è½½å®Œæˆ');
            console.log('æœåŠ¡å™¨è®¤è¯çŠ¶æ€:', isAuthenticated);
            console.log('å½“å‰ç”¨æˆ·:', currentUser);

            // æ£€æŸ¥ localStorage ä¸­çš„ token
            const token = getAuthToken();

            // å¦‚æœæœ‰tokenä½†æœåŠ¡å™¨ç«¯æœªè®¤è¯ï¼Œå°è¯•éªŒè¯token
            if (token && !isAuthenticated) {
                console.log('ğŸ”„ æ£€æµ‹åˆ°localStorage tokenä½†æœåŠ¡å™¨ç«¯æœªè®¤è¯ï¼Œå°è¯•éªŒè¯...');
                const tokenValid = await validateToken();
                if (tokenValid) {
                    // Tokenæœ‰æ•ˆï¼Œæ›´æ–°è®¤è¯çŠ¶æ€
                    isAuthenticated = true;
                    // å°è¯•è·å–ç”¨æˆ·ä¿¡æ¯
                    try {
                        const response = await axios.get('/api/auth/verify', {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        if (response.data.valid) {
                            currentUser = response.data.username;
                            console.log('âœ… å·²æ›´æ–°ç”¨æˆ·ä¿¡æ¯:', currentUser);
                        }
                    } catch (error) {
                        console.log('âš ï¸ è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
                    }
                }
            } else if (token) {
                // å¦‚æœæœ‰tokenä¸”æœåŠ¡å™¨ç«¯å·²è®¤è¯ï¼Œä»ç„¶éªŒè¯ä¸€ä¸‹tokenæœ‰æ•ˆæ€§
                await validateToken();
            }

            // åˆå§‹åŒ–ç”¨æˆ·ç•Œé¢
            initializeUserInterface();

            // ç»‘å®šäº‹ä»¶
            bindEvents();

            // æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
            if (isUserAuthenticated()) {
                showMessage('æ¬¢è¿ä½¿ç”¨ yt-dlp Web ä¸‹è½½å™¨ï¼', 'success');
            } else {
                showMessage('æ‚¨æ­£åœ¨ä»¥è®¿å®¢æ¨¡å¼æµè§ˆï¼Œç™»å½•åå¯ä½¿ç”¨ä¸‹è½½åŠŸèƒ½ã€‚', 'info');
            }
        });

        // åˆå§‹åŒ–ç”¨æˆ·ç•Œé¢
        function initializeUserInterface() {
            const userControls = document.getElementById('userControls');
            const token = localStorage.getItem('auth_token');

            // æ£€æŸ¥æœ€æ–°çš„è®¤è¯çŠ¶æ€
            const authenticated = isUserAuthenticated();
            const displayUser = currentUser || 'admin'; // é»˜è®¤æ˜¾ç¤ºadmin

            if (authenticated) {
                // å·²ç™»å½•ç”¨æˆ·ç•Œé¢
                userControls.innerHTML = `
                    <div class="d-flex align-items-center gap-3">
                        <span class="text-white-50">
                            <i class="fas fa-user me-2"></i>${displayUser}
                        </span>
                        <button class="btn btn-outline-light btn-sm" onclick="window.location.href='/files'">
                            <i class="fas fa-folder me-2"></i>æ–‡ä»¶ç®¡ç†
                        </button>
                        <button class="btn btn-outline-light btn-sm" onclick="window.location.href='/admin'">
                            <i class="fas fa-cog me-2"></i>ç®¡ç†
                        </button>
                        <button class="btn btn-outline-light btn-sm" onclick="logout()">
                            <i class="fas fa-sign-out-alt me-2"></i>é€€å‡º
                        </button>
                    </div>
                `;
            } else {
                // è®¿å®¢ç”¨æˆ·ç•Œé¢
                userControls.innerHTML = `
                    <div class="d-flex align-items-center gap-3">
                        <span class="text-white-50">
                            <i class="fas fa-user-slash me-2"></i>è®¿å®¢æ¨¡å¼
                        </span>
                        <button class="btn btn-outline-light btn-sm" onclick="window.location.href='/login'">
                            <i class="fas fa-sign-in-alt me-2"></i>ç™»å½•
                        </button>
                    </div>
                `;
            }
        }

        // ç»‘å®šäº‹ä»¶
        function bindEvents() {
            // ç²˜è´´æŒ‰é’®
            document.getElementById('pasteBtn').addEventListener('click', async function() {
                try {
                    const text = await navigator.clipboard.readText();
                    document.getElementById('url').value = text;
                    showMessage('é“¾æ¥å·²ç²˜è´´', 'success');
                } catch (err) {
                    showMessage('æ— æ³•è®¿é—®å‰ªè´´æ¿ï¼Œè¯·æ‰‹åŠ¨ç²˜è´´', 'warning');
                }
            });

            // è·å–è§†é¢‘ä¿¡æ¯æŒ‰é’®
            document.getElementById('getInfoBtn').addEventListener('click', getVideoInfo);

            // ä¸‹è½½æŒ‰é’®
            const downloadBtn = document.getElementById('downloadBtn');
            if (downloadBtn) {
                downloadBtn.addEventListener('click', startDownload);
                console.log('âœ… ä¸‹è½½æŒ‰é’®äº‹ä»¶å·²ç»‘å®š');
            } else {
                console.error('âŒ æ‰¾ä¸åˆ°ä¸‹è½½æŒ‰é’®å…ƒç´ ');
            }
        }

        // è·å–è§†é¢‘ä¿¡æ¯
        async function getVideoInfo() {
            // æ£€æŸ¥è®¤è¯çŠ¶æ€
            if (!isUserAuthenticated()) {
                console.log('âŒ è®¤è¯å¤±è´¥ï¼Œéœ€è¦ç™»å½•');
                showLoginRequired('æŸ¥çœ‹è§†é¢‘ä¿¡æ¯');
                return;
            }

            const token = getAuthToken();

            const url = document.getElementById('url').value.trim();
            if (!url) {
                showMessage('è¯·è¾“å…¥è§†é¢‘é“¾æ¥', 'error');
                return;
            }

            const btn = document.getElementById('getInfoBtn');
            const spinner = document.getElementById('infoSpinner');
            const text = document.getElementById('infoText');

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            btn.disabled = true;
            spinner.classList.remove('d-none');
            text.textContent = 'è·å–ä¸­...';

            try {
                console.log('ğŸ“¤ å‘é€è§†é¢‘ä¿¡æ¯è¯·æ±‚ï¼Œä½¿ç”¨token:', token ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
                const response = await axios.post('/api/info', {
                    url: url
                }, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.data.success) {
                    displayVideoInfo(response.data.info);
                    showMessage('è§†é¢‘ä¿¡æ¯è·å–æˆåŠŸ', 'success');
                } else {
                    showMessage(response.data.error || 'è·å–è§†é¢‘ä¿¡æ¯å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('è·å–è§†é¢‘ä¿¡æ¯å¤±è´¥:', error);
                if (error.response?.status === 401) {
                    showLoginRequired('è·å–è§†é¢‘ä¿¡æ¯');
                } else {
                    showMessage('è·å–è§†é¢‘ä¿¡æ¯å¤±è´¥: ' + (error.response?.data?.error || error.message), 'error');
                }
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                btn.disabled = false;
                spinner.classList.add('d-none');
                text.textContent = 'è·å–è§†é¢‘ä¿¡æ¯';
            }
        }

        // å¼€å§‹ä¸‹è½½
        async function startDownload() {
            console.log('ğŸ¯ å¼€å§‹ä¸‹è½½å‡½æ•°è¢«è°ƒç”¨');

            // æ£€æŸ¥è®¤è¯çŠ¶æ€
            if (!isUserAuthenticated()) {
                console.log('âŒ è®¤è¯å¤±è´¥ï¼Œéœ€è¦ç™»å½•');
                showLoginRequired('ä¸‹è½½è§†é¢‘');
                return;
            }

            const token = getAuthToken();

            const url = document.getElementById('url').value.trim();
            if (!url) {
                showMessage('è¯·è¾“å…¥è§†é¢‘é“¾æ¥', 'error');
                return;
            }

            const btn = document.getElementById('downloadBtn');
            const spinner = document.getElementById('downloadSpinner');
            const text = document.getElementById('downloadText');

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            btn.disabled = true;
            spinner.classList.remove('d-none');
            text.textContent = 'ä¸‹è½½ä¸­...';

            try {
                const downloadOptions = {
                    url: url,
                    video_quality: document.getElementById('video-quality').value,
                    audio_quality: document.getElementById('audio-quality').value,
                    output_format: document.getElementById('output-format').value,
                    audio_only: document.getElementById('audio-only').checked,
                    download_subtitles: document.getElementById('download-subtitles').checked,
                    download_thumbnail: document.getElementById('download-thumbnail').checked,
                    download_description: document.getElementById('download-description').checked,
                    download_playlist: document.getElementById('download-playlist').checked,
                    subtitle_lang: document.getElementById('subtitle-lang').value,
                    preset: 'custom'
                };

                console.log('ğŸ“¤ å‘é€ä¸‹è½½è¯·æ±‚:', downloadOptions);
                console.log('ğŸ”‘ ä½¿ç”¨ token:', token ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');

                const response = await axios.post('/api/download', downloadOptions, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                console.log('ğŸ“¥ ä¸‹è½½å“åº”:', response.data);

                if (response.data.success) {
                    showMessage('ä¸‹è½½ä»»åŠ¡å·²å¼€å§‹', 'success');

                    // æ˜¾ç¤ºä¸‹è½½çŠ¶æ€åŒºåŸŸ
                    const statusSection = document.getElementById('download-status-section');
                    statusSection.classList.remove('d-none');
                    statusSection.classList.add('show');

                    // å¼€å§‹ç›‘æ§ä¸‹è½½è¿›åº¦
                    startDownloadMonitoring(response.data.download_id);
                } else {
                    showMessage(response.data.error || 'ä¸‹è½½å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('âŒ ä¸‹è½½å¤±è´¥:', error);
                console.error('é”™è¯¯è¯¦æƒ…:', {
                    status: error.response?.status,
                    statusText: error.response?.statusText,
                    data: error.response?.data,
                    message: error.message
                });

                if (error.response?.status === 401) {
                    console.log('ğŸ” è®¤è¯å¤±è´¥ï¼Œæ˜¾ç¤ºç™»å½•æç¤º');
                    showLoginRequired('ä¸‹è½½è§†é¢‘');
                } else {
                    const errorMsg = error.response?.data?.error || error.message || 'æœªçŸ¥é”™è¯¯';
                    console.log('ğŸ’¥ æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯:', errorMsg);
                    showMessage('ä¸‹è½½å¤±è´¥: ' + errorMsg, 'error');
                }
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                btn.disabled = false;
                spinner.classList.add('d-none');
                text.textContent = 'å¼€å§‹ä¸‹è½½';
            }
        }

        // æ˜¾ç¤ºéœ€è¦ç™»å½•çš„æç¤º
        function showLoginRequired(action) {
            Swal.fire({
                title: 'éœ€è¦ç™»å½•',
                text: `è¯·å…ˆç™»å½•ä»¥${action}`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'ç«‹å³ç™»å½•',
                cancelButtonText: 'å–æ¶ˆ',
                confirmButtonColor: '#667eea'
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = '/login?redirect=' + encodeURIComponent(window.location.pathname);
                }
            });
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type = 'info') {
            const messageArea = document.getElementById('messageArea');
            const alertClass = {
                'success': 'alert-success',
                'error': 'alert-danger',
                'warning': 'alert-warning',
                'info': 'alert-info'
            }[type] || 'alert-info';

            const alertHtml = `
                <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;

            messageArea.innerHTML = alertHtml;

            // è‡ªåŠ¨éšè—æ¶ˆæ¯
            setTimeout(() => {
                const alert = messageArea.querySelector('.alert');
                if (alert) {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }
            }, 5000);
        }

        // æ˜¾ç¤ºè§†é¢‘ä¿¡æ¯
        function displayVideoInfo(info) {
            const videoInfoSection = document.getElementById('video-info-section');
            const videoInfo = document.getElementById('video-info');
            const duration = info.duration ? formatDuration(info.duration) : 'æœªçŸ¥';
            const fileSize = info.filesize ? formatFileSize(info.filesize) : 'æœªçŸ¥';

            const infoHtml = `
                <div class="row g-3">
                    <div class="col-12">
                        <h6 class="fw-bold">${info.title || 'æœªçŸ¥æ ‡é¢˜'}</h6>
                    </div>
                    <div class="col-md-6">
                        <small class="text-muted">ä¸Šä¼ è€…</small>
                        <div>${info.uploader || 'æœªçŸ¥'}</div>
                    </div>
                    <div class="col-md-6">
                        <small class="text-muted">æ—¶é•¿</small>
                        <div>${duration}</div>
                    </div>
                    <div class="col-md-6">
                        <small class="text-muted">è§‚çœ‹æ¬¡æ•°</small>
                        <div>${info.view_count ? info.view_count.toLocaleString() : 'æœªçŸ¥'}</div>
                    </div>
                    <div class="col-md-6">
                        <small class="text-muted">é¢„ä¼°å¤§å°</small>
                        <div>${fileSize}</div>
                    </div>
                    ${info.description ? `
                    <div class="col-12">
                        <small class="text-muted">æè¿°</small>
                        <div class="text-truncate" style="max-height: 60px; overflow: hidden;">
                            ${info.description.substring(0, 200)}${info.description.length > 200 ? '...' : ''}
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;

            videoInfo.innerHTML = infoHtml;
            videoInfoSection.classList.remove('d-none');
            videoInfoSection.classList.add('show');
        }

        // å·¥å…·å‡½æ•°
        function formatDuration(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;

            if (hours > 0) {
                return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            } else {
                return `${minutes}:${secs.toString().padStart(2, '0')}`;
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatSpeed(bytesPerSecond) {
            return formatFileSize(bytesPerSecond) + '/s';
        }

        function formatTime(seconds) {
            if (seconds < 60) {
                return `${Math.round(seconds)}ç§’`;
            } else if (seconds < 3600) {
                const minutes = Math.floor(seconds / 60);
                const secs = Math.round(seconds % 60);
                return `${minutes}åˆ†${secs}ç§’`;
            } else {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                return `${hours}å°æ—¶${minutes}åˆ†`;
            }
        }

        // å¼€å§‹ä¸‹è½½ç›‘æ§
        function startDownloadMonitoring(downloadId) {
            console.log('ğŸ“Š å¼€å§‹ç›‘æ§ä¸‹è½½:', downloadId);

            const progressContainer = document.getElementById('progress-container');
            progressContainer.classList.remove('d-none');

            // æ¯2ç§’æ£€æŸ¥ä¸€æ¬¡ä¸‹è½½çŠ¶æ€
            const interval = setInterval(async () => {
                try {
                    const token = getAuthToken();
                    const response = await axios.get(`/api/download/${downloadId}/status`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.data) {
                        updateDownloadProgress(response.data);

                        // å¦‚æœä¸‹è½½å®Œæˆæˆ–å¤±è´¥ï¼Œåœæ­¢ç›‘æ§
                        if (response.data.status === 'completed' || response.data.status === 'failed') {
                            clearInterval(interval);
                            handleDownloadComplete(response.data);
                        }
                    }
                } catch (error) {
                    console.error('è·å–ä¸‹è½½çŠ¶æ€å¤±è´¥:', error);
                    clearInterval(interval);
                }
            }, 2000);
        }

        // æ›´æ–°ä¸‹è½½è¿›åº¦
        function updateDownloadProgress(downloadData) {
            const progressFill = document.getElementById('progress-fill');
            const progressText = document.getElementById('progress-text');
            const downloadSpeed = document.getElementById('download-speed');
            const fileSize = document.getElementById('file-size');
            const eta = document.getElementById('eta');
            const downloadStatus = document.getElementById('download-status');

            // æ›´æ–°è¿›åº¦æ¡
            const progress = downloadData.progress || 0;
            progressFill.style.width = `${progress}%`;
            progressText.textContent = `${progress}%`;

            // æ›´æ–°çŠ¶æ€æ–‡æœ¬
            let statusText = '';
            switch (downloadData.status) {
                case 'pending':
                    statusText = 'â³ ç­‰å¾…å¼€å§‹...';
                    break;
                case 'downloading':
                    statusText = 'ğŸ“¥ æ­£åœ¨ä¸‹è½½...';
                    break;
                case 'completed':
                    statusText = 'âœ… ä¸‹è½½å®Œæˆ';
                    break;
                case 'failed':
                    statusText = `âŒ ä¸‹è½½å¤±è´¥: ${downloadData.error || 'æœªçŸ¥é”™è¯¯'}`;
                    break;
                default:
                    statusText = `ğŸ“Š çŠ¶æ€: ${downloadData.status}`;
            }
            downloadStatus.textContent = statusText;

            // æ›´æ–°ä¸‹è½½ä¿¡æ¯
            if (downloadData.speed) {
                downloadSpeed.textContent = formatSpeed(downloadData.speed);
            }

            if (downloadData.total_bytes) {
                fileSize.textContent = formatFileSize(downloadData.total_bytes);
            }

            if (downloadData.eta) {
                eta.textContent = formatTime(downloadData.eta);
            }

            console.log('ğŸ“Š è¿›åº¦æ›´æ–°:', {
                progress: progress,
                status: downloadData.status,
                filename: downloadData.filename
            });
        }

        // å¤„ç†ä¸‹è½½å®Œæˆ
        function handleDownloadComplete(downloadData) {
            if (downloadData.status === 'completed') {
                showMessage('ğŸ‰ ä¸‹è½½å®Œæˆï¼', 'success');

                // å¦‚æœæœ‰æ–‡ä»¶åå’Œä¸‹è½½é“¾æ¥ï¼Œæ˜¾ç¤ºä¸‹è½½æŒ‰é’®
                if (downloadData.filename && downloadData.download_url) {
                    const filename = downloadData.filename.split('/').pop(); // è·å–æ–‡ä»¶å

                    // åœ¨ä¸‹è½½çŠ¶æ€åŒºåŸŸæ·»åŠ ä¸‹è½½é“¾æ¥
                    const downloadStatus = document.getElementById('download-status');
                    downloadStatus.innerHTML = `
                        <div class="d-flex align-items-center justify-content-between">
                            <span>âœ… ä¸‹è½½å®Œæˆ: ${filename}</span>
                            <a href="${downloadData.download_url}"
                               class="btn btn-success btn-sm"
                               download="${filename}">
                                <i class="fas fa-download me-1"></i>ä¸‹è½½æ–‡ä»¶
                            </a>
                        </div>
                    `;

                    showMessage(`æ–‡ä»¶å·²ä¿å­˜: ${filename}`, 'info');
                } else if (downloadData.filename) {
                    const filename = downloadData.filename.split('/').pop();
                    showMessage(`æ–‡ä»¶å·²ä¿å­˜: ${filename}`, 'info');
                }
            } else if (downloadData.status === 'failed') {
                showMessage(`ä¸‹è½½å¤±è´¥: ${downloadData.error || 'æœªçŸ¥é”™è¯¯'}`, 'error');
            }
        }

        // é€€å‡ºç™»å½•
        function logout() {
            Swal.fire({
                title: 'ç¡®è®¤é€€å‡º',
                text: 'æ‚¨ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'ç¡®è®¤é€€å‡º',
                cancelButtonText: 'å–æ¶ˆ',
                confirmButtonColor: '#dc3545'
            }).then((result) => {
                if (result.isConfirmed) {
                    localStorage.removeItem('auth_token');
                    window.location.href = '/login';
                }
            });
        }
    </script>
</body>
</html>