# æ··åˆæ¨¡å¼ Dockerfile
# ç‰¹ç‚¹ï¼šæ„å»ºæ—¶å°è¯•ä¸‹è½½ï¼Œè¿è¡Œæ—¶æ£€æŸ¥è¡¥å……

# ==========================================
# é˜¶æ®µ1: å°è¯•ä¸‹è½½ yt-dlp
# ==========================================
FROM python:3.11-slim AS ytdlp-downloader

# å®‰è£…ä¸‹è½½å·¥å…·
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    wget \
    git \
    && rm -rf /var/lib/apt/lists/*

# å®‰è£… Python ä¾èµ–
RUN pip install --no-cache-dir requests>=2.32.3 pyyaml>=6.0.2

# å¤åˆ¶æºç®¡ç†å™¨
COPY scripts/ytdlp_source_manager.py /tmp/
COPY config/ytdlp-source.yml /tmp/

# è®¾ç½®æ„å»ºå‚æ•°
ARG YTDLP_SOURCE=github_release
ARG YTDLP_VERSION=latest
ENV YTDLP_SOURCE=${YTDLP_SOURCE}
ENV YTDLP_VERSION=${YTDLP_VERSION}

# å°è¯•ä¸‹è½½ yt-dlpï¼ˆå…è®¸å¤±è´¥ï¼‰
RUN cd /tmp && \
    echo "ğŸ”½ å°è¯•æ„å»ºæ—¶ä¸‹è½½ yt-dlp (æº: ${YTDLP_SOURCE}, ç‰ˆæœ¬: ${YTDLP_VERSION})" && \
    mkdir -p /ytdlp-prepared && \
    (python ytdlp_source_manager.py \
        --config ytdlp-source.yml \
        --target /ytdlp-prepared && \
    echo "âœ… æ„å»ºæ—¶ä¸‹è½½æˆåŠŸ" && \
    echo "build_time_success" > /ytdlp-prepared/.download_status) || \
    (echo "âš ï¸ æ„å»ºæ—¶ä¸‹è½½å¤±è´¥ï¼Œå°†åœ¨è¿è¡Œæ—¶é‡è¯•" && \
    echo "build_time_failed" > /ytdlp-prepared/.download_status)

# ==========================================
# é˜¶æ®µ2: æœ€ç»ˆåº”ç”¨é•œåƒ
# ==========================================
FROM python:3.11-slim

# æ„å»ºå‚æ•°
ARG BUILDTIME
ARG VERSION
ARG REVISION
ARG YTDLP_SOURCE
ARG YTDLP_VERSION

# æ ‡ç­¾
LABEL org.opencontainers.image.title="YT-DLP Web (æ··åˆæ¨¡å¼)"
LABEL org.opencontainers.image.description="yt-dlp Webç•Œé¢ - æ··åˆä¸‹è½½æ¨¡å¼"
LABEL org.opencontainers.image.version="${VERSION}"
LABEL org.opencontainers.image.created="${BUILDTIME}"
LABEL ytdlp.source="${YTDLP_SOURCE}"
LABEL ytdlp.version="${YTDLP_VERSION}"
LABEL build.strategy="hybrid"

# å·¥ä½œç›®å½•
WORKDIR /app

# ç¯å¢ƒå˜é‡
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONPATH=/app
ENV YTDLP_NO_LAZY_EXTRACTORS=1
ENV BUILD_STRATEGY=hybrid
ENV YTDLP_SOURCE=${YTDLP_SOURCE}
ENV YTDLP_VERSION=${YTDLP_VERSION}

# åˆ›å»ºç”¨æˆ·
RUN groupadd -r ytdlp && useradd -r -g ytdlp -u 1000 ytdlp

# å®‰è£…ç³»ç»Ÿä¾èµ–ï¼ˆåŒ…å«ä¸‹è½½å·¥å…·ä»¥å¤‡è¿è¡Œæ—¶ä½¿ç”¨ï¼‰
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    wget \
    git \
    ca-certificates \
    dos2unix \
    ffmpeg \
    build-essential \
    gcc \
    g++ \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# å®‰è£… Python ä¾èµ–
COPY requirements/requirements.hybrid.txt /tmp/requirements.txt

# å…ˆå‡çº§ pip å’Œå®‰è£…åŸºç¡€å·¥å…·
RUN pip install --no-cache-dir --upgrade pip setuptools wheel

# åˆ†æ­¥å®‰è£…æ ¸å¿ƒä¾èµ–ï¼Œç¡®ä¿å…³é”®ç»„ä»¶èƒ½æ­£ç¡®å®‰è£…
RUN pip install --no-cache-dir Flask>=3.1.1 && \
    pip install --no-cache-dir Flask-Login>=0.6.3 && \
    pip install --no-cache-dir Flask-SQLAlchemy>=3.1.1 && \
    pip install --no-cache-dir flask-cors>=6.0.0 && \
    pip install --no-cache-dir Werkzeug>=3.1.3 && \
    pip install --no-cache-dir PyJWT>=2.8.0 && \
    pip install --no-cache-dir requests>=2.32.3 && \
    pip install --no-cache-dir gunicorn>=23.0.0

# éªŒè¯æ ¸å¿ƒä¾èµ–å®‰è£…
RUN python -c "import flask_login; print('âœ… Flask-Login å®‰è£…æˆåŠŸ')" && \
    python -c "import flask, flask_sqlalchemy, flask_cors; print('âœ… Flask æ ¸å¿ƒç»„ä»¶å®‰è£…æˆåŠŸ')"

# å®‰è£…å…¶ä½™ä¾èµ–ï¼ˆå…è®¸éƒ¨åˆ†å¤±è´¥ï¼‰
RUN pip install --no-cache-dir -r /tmp/requirements.txt || \
    echo "âš ï¸ éƒ¨åˆ†ä¾èµ–å®‰è£…å¤±è´¥ï¼Œä½†æ ¸å¿ƒä¾èµ–å·²å®‰è£…"

# ä»ä¸‹è½½é˜¶æ®µå¤åˆ¶ç»“æœï¼ˆå¯èƒ½æˆåŠŸä¹Ÿå¯èƒ½å¤±è´¥ï¼‰
COPY --from=ytdlp-downloader /ytdlp-prepared /app/yt-dlp-source

# å¤åˆ¶åº”ç”¨æ–‡ä»¶
COPY webapp /app/webapp
COPY scripts /app/scripts
COPY config /app/config

# å¤åˆ¶ç¯å¢ƒé…ç½®æ–‡ä»¶
COPY .env* /app/

# å¤åˆ¶æ‰€æœ‰è„šæœ¬æ–‡ä»¶
COPY scripts /app/scripts

# è®¾ç½®æƒé™å’Œç›®å½•ï¼ˆä½¿ç”¨ root ç”¨æˆ·è¿è¡Œï¼‰
RUN dos2unix /app/scripts/start-hybrid.sh && \
    chmod +x /app/scripts/*.sh && \
    # åˆ›å»ºåº”ç”¨æ‰€éœ€ç›®å½•
    mkdir -p /app/downloads /app/config /app/logs /app/yt-dlp-cache && \
    # è®¾ç½®ç›®å½•æƒé™ï¼ˆroot ç”¨æˆ·æ‹¥æœ‰å®Œå…¨æƒé™ï¼‰
    chmod 755 /app/downloads /app/config /app/logs /app/yt-dlp-cache && \
    # ç¡®ä¿è„šæœ¬å¯æ‰§è¡Œ
    chmod +x /app/scripts/*.sh && \
    # æµ‹è¯•å†™å…¥æƒé™
    touch /app/downloads/.test_write && rm /app/downloads/.test_write && \
    touch /app/logs/.test_write && rm /app/logs/.test_write && \
    echo "âœ… æ··åˆæ¨¡å¼é…ç½®å®Œæˆï¼Œæƒé™æµ‹è¯•é€šè¿‡"

# è·³è¿‡æ„å»ºæ—¶éªŒè¯ï¼Œåœ¨è¿è¡Œæ—¶è¿›è¡Œæ£€æŸ¥

# ä½¿ç”¨ root ç”¨æˆ·è¿è¡Œï¼ˆæ³¨é‡Šæ‰ USER æŒ‡ä»¤ï¼‰
# USER ytdlp

# ç«¯å£
EXPOSE 8080

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=15s --start-period=45s --retries=4 \
    CMD curl -f http://localhost:8080/health || exit 1

# å¯åŠ¨
CMD ["/app/scripts/start-hybrid.sh"]
